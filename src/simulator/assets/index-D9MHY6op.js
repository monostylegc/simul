var Dh=Object.defineProperty;var ic=e=>{throw TypeError(e)};var zh=(e,t,n)=>t in e?Dh(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var O=(e,t,n)=>zh(e,typeof t!="symbol"?t+"":t,n),kr=(e,t,n)=>t.has(e)||ic("Cannot "+n);var v=(e,t,n)=>(kr(e,t,"read from private field"),n?n.call(e):t.get(e)),L=(e,t,n)=>t.has(e)?ic("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),ge=(e,t,n,s)=>(kr(e,t,"write to private field"),s?s.call(e,n):t.set(e,n),n),yt=(e,t,n)=>(kr(e,t,"access private method"),n);import{C as Od,V as Y,M as ns,T as Gs,Q as Ut,S as ac,a as $t,R as Ih,P as Cl,b as Lh,L as Oh,F as Fh,B as en,c as ni,d as Fd,e as Lt,f as Ds,g as Nh,h as $h,W as Hh,i as si,A as jh,D as oc,G as rc,j as Bh,k as Pl,l as wn,m as W,n as mn,I as Al,o as En,p as lc,q as sr,r as fi,O as Qr,s as ii,t as Nd,u as Ft,v as St,w as Fo,x as gi,y as Tl,E as Uh,z as Zh,H as ss,J as Yh,K as $d,N as Jr}from"./three-DB1OcJWK.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=n(i);fetch(i.href,a)}})();const el=!1;var Rl=Array.isArray,Gh=Array.prototype.indexOf,ai=Array.prototype.includes,_r=Array.from,Vh=Object.defineProperty,Pi=Object.getOwnPropertyDescriptor,Hd=Object.getOwnPropertyDescriptors,Xh=Object.prototype,Wh=Array.prototype,Dl=Object.getPrototypeOf,cc=Object.isExtensible;const Kh=()=>{};function qh(e){return e()}function tl(e){for(var t=0;t<e.length;t++)e[t]()}function jd(){var e,t,n=new Promise((s,i)=>{e=s,t=i});return{promise:n,resolve:e,reject:t}}function Qh(e,t){if(Array.isArray(e))return e;if(!(Symbol.iterator in e))return Array.from(e);const n=[];for(const s of e)if(n.push(s),n.length===t)break;return n}const At=2,ko=4,Mo=8,Bd=1<<24,Vn=16,kn=32,$s=64,nl=128,dn=512,kt=1024,Tt=2048,xn=4096,tn=8192,is=16384,zs=32768,oi=65536,dc=1<<17,Ud=1<<18,pi=1<<19,Zd=1<<20,Zn=1<<25,Is=65536,sl=1<<21,zl=1<<22,as=1<<23,os=Symbol("$state"),Jh=Symbol(""),_s=new class extends Error{constructor(){super(...arguments);O(this,"name","StaleReactionError");O(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};var zd;const ef=!!((zd=globalThis.document)!=null&&zd.contentType)&&globalThis.document.contentType.includes("xml");function tf(e){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function nf(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function sf(e,t,n){throw new Error("https://svelte.dev/e/each_key_duplicate")}function af(e){throw new Error("https://svelte.dev/e/effect_in_teardown")}function of(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function rf(e){throw new Error("https://svelte.dev/e/effect_orphan")}function lf(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function cf(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function df(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function uf(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function hf(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const ff=1,pf=2,Yd=4,vf=8,_f=16,mf=1,gf=2,Et=Symbol(),Gd="http://www.w3.org/1999/xhtml";function bf(){console.warn("https://svelte.dev/e/select_multiple_invalid_value")}function yf(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function Vd(e){return e===this.v}function wf(e,t){return e!=e?t==t:e!==t||e!==null&&typeof e=="object"||typeof e=="function"}function Xd(e){return!wf(e,this.v)}let So=!1,xf=!1;function kf(){So=!0}let dt=null;function ri(e){dt=e}function sn(e,t=!1,n){dt={p:dt,i:!1,c:null,e:null,s:e,x:null,l:So&&!t?{s:null,u:null,$:[]}:null}}function an(e){var t=dt,n=t.e;if(n!==null){t.e=null;for(var s of n)mu(s)}return t.i=!0,dt=t.p,{}}function Eo(){return!So||dt!==null&&dt.l===null}let ms=[];function Wd(){var e=ms;ms=[],tl(e)}function rs(e){if(ms.length===0&&!Ai){var t=ms;queueMicrotask(()=>{t===ms&&Wd()})}ms.push(e)}function Mf(){for(;ms.length>0;)Wd()}function Kd(e){var t=De;if(t===null)return ke.f|=as,e;if((t.f&zs)===0&&(t.f&ko)===0)throw e;es(e,t)}function es(e,t){for(;t!==null;){if((t.f&nl)!==0){if((t.f&zs)===0)throw e;try{t.b.error(e);return}catch(n){e=n}}t=t.parent}throw e}const Sf=-7169;function ct(e,t){e.f=e.f&Sf|t}function Il(e){(e.f&dn)!==0||e.deps===null?ct(e,kt):ct(e,xn)}function qd(e){if(e!==null)for(const t of e)(t.f&At)===0||(t.f&Is)===0||(t.f^=Is,qd(t.deps))}function Qd(e,t,n){(e.f&Tt)!==0?t.add(e):(e.f&xn)!==0&&n.add(e),qd(e.deps),ct(e,kt)}const No=new Set;let ue=null,ir=null,Pt=null,jt=[],mr=null,il=!1,Ai=!1;var Ws,Ks,Ms,qs,Xi,Wi,Ss,jn,Qs,nn,al,ol,rl,Jd;const nc=class nc{constructor(){L(this,nn);O(this,"current",new Map);O(this,"previous",new Map);L(this,Ws,new Set);L(this,Ks,new Set);L(this,Ms,0);L(this,qs,0);L(this,Xi,null);L(this,Wi,new Set);L(this,Ss,new Set);L(this,jn,new Map);O(this,"is_fork",!1);L(this,Qs,!1)}skip_effect(t){v(this,jn).has(t)||v(this,jn).set(t,{d:[],m:[]})}unskip_effect(t){var n=v(this,jn).get(t);if(n){v(this,jn).delete(t);for(var s of n.d)ct(s,Tt),gn(s);for(s of n.m)ct(s,xn),gn(s)}}process(t){var i;jt=[],this.apply();var n=[],s=[];for(const a of t)yt(this,nn,ol).call(this,a,n,s);if(yt(this,nn,al).call(this)){yt(this,nn,rl).call(this,s),yt(this,nn,rl).call(this,n);for(const[a,o]of v(this,jn))su(a,o)}else{for(const a of v(this,Ws))a();v(this,Ws).clear(),v(this,Ms)===0&&yt(this,nn,Jd).call(this),ir=this,ue=null,uc(s),uc(n),ir=null,(i=v(this,Xi))==null||i.resolve()}Pt=null}capture(t,n){n!==Et&&!this.previous.has(t)&&this.previous.set(t,n),(t.f&as)===0&&(this.current.set(t,t.v),Pt==null||Pt.set(t,t.v))}activate(){ue=this,this.apply()}deactivate(){ue===this&&(ue=null,Pt=null)}flush(){if(this.activate(),jt.length>0){if(eu(),ue!==null&&ue!==this)return}else v(this,Ms)===0&&this.process([]);this.deactivate()}discard(){for(const t of v(this,Ks))t(this);v(this,Ks).clear()}increment(t){ge(this,Ms,v(this,Ms)+1),t&&ge(this,qs,v(this,qs)+1)}decrement(t){ge(this,Ms,v(this,Ms)-1),t&&ge(this,qs,v(this,qs)-1),!v(this,Qs)&&(ge(this,Qs,!0),rs(()=>{ge(this,Qs,!1),yt(this,nn,al).call(this)?jt.length>0&&this.flush():this.revive()}))}revive(){for(const t of v(this,Wi))v(this,Ss).delete(t),ct(t,Tt),gn(t);for(const t of v(this,Ss))ct(t,xn),gn(t);this.flush()}oncommit(t){v(this,Ws).add(t)}ondiscard(t){v(this,Ks).add(t)}settled(){return(v(this,Xi)??ge(this,Xi,jd())).promise}static ensure(){if(ue===null){const t=ue=new nc;No.add(ue),Ai||rs(()=>{ue===t&&t.flush()})}return ue}apply(){}};Ws=new WeakMap,Ks=new WeakMap,Ms=new WeakMap,qs=new WeakMap,Xi=new WeakMap,Wi=new WeakMap,Ss=new WeakMap,jn=new WeakMap,Qs=new WeakMap,nn=new WeakSet,al=function(){return this.is_fork||v(this,qs)>0},ol=function(t,n,s){t.f^=kt;for(var i=t.first;i!==null;){var a=i.f,o=(a&(kn|$s))!==0,r=o&&(a&kt)!==0,c=r||(a&tn)!==0||v(this,jn).has(i);if(!c&&i.fn!==null){o?i.f^=kt:(a&ko)!==0?n.push(i):Po(i)&&((a&Vn)!==0&&v(this,Ss).add(i),ci(i));var l=i.first;if(l!==null){i=l;continue}}for(;i!==null;){var d=i.next;if(d!==null){i=d;break}i=i.parent}}},rl=function(t){for(var n=0;n<t.length;n+=1)Qd(t[n],v(this,Wi),v(this,Ss))},Jd=function(){var i;if(No.size>1){this.previous.clear();var t=Pt,n=!0;for(const a of No){if(a===this){n=!1;continue}const o=[];for(const[c,l]of this.current){if(a.current.has(c))if(n&&l!==a.current.get(c))a.current.set(c,l);else continue;o.push(c)}if(o.length===0)continue;const r=[...a.current.keys()].filter(c=>!this.current.has(c));if(r.length>0){var s=jt;jt=[];const c=new Set,l=new Map;for(const d of o)tu(d,r,c,l);if(jt.length>0){ue=a,a.apply();for(const d of jt)yt(i=a,nn,ol).call(i,d,[],[]);a.deactivate()}jt=s}}ue=null,Pt=t}No.delete(this)};let ls=nc;function Ef(e){var t=Ai;Ai=!0;try{for(var n;;){if(Mf(),jt.length===0&&(ue==null||ue.flush(),jt.length===0))return mr=null,n;eu()}}finally{Ai=t}}function eu(){il=!0;var e=null;try{for(var t=0;jt.length>0;){var n=ls.ensure();if(t++>1e3){var s,i;Cf()}n.process(jt),cs.clear()}}finally{jt=[],il=!1,mr=null}}function Cf(){try{lf()}catch(e){es(e,mr)}}let pn=null;function uc(e){var t=e.length;if(t!==0){for(var n=0;n<t;){var s=e[n++];if((s.f&(is|tn))===0&&Po(s)&&(pn=new Set,ci(s),s.deps===null&&s.first===null&&s.nodes===null&&s.teardown===null&&s.ac===null&&yu(s),(pn==null?void 0:pn.size)>0)){cs.clear();for(const i of pn){if((i.f&(is|tn))!==0)continue;const a=[i];let o=i.parent;for(;o!==null;)pn.has(o)&&(pn.delete(o),a.push(o)),o=o.parent;for(let r=a.length-1;r>=0;r--){const c=a[r];(c.f&(is|tn))===0&&ci(c)}}pn.clear()}}pn=null}}function tu(e,t,n,s){if(!n.has(e)&&(n.add(e),e.reactions!==null))for(const i of e.reactions){const a=i.f;(a&At)!==0?tu(i,t,n,s):(a&(zl|Vn))!==0&&(a&Tt)===0&&nu(i,t,s)&&(ct(i,Tt),gn(i))}}function nu(e,t,n){const s=n.get(e);if(s!==void 0)return s;if(e.deps!==null)for(const i of e.deps){if(ai.call(t,i))return!0;if((i.f&At)!==0&&nu(i,t,n))return n.set(i,!0),!0}return n.set(e,!1),!1}function gn(e){var t=mr=e,n=t.b;if(n!=null&&n.is_pending&&(e.f&(ko|Mo|Bd))!==0&&(e.f&zs)===0){n.defer_effect(e);return}for(;t.parent!==null;){t=t.parent;var s=t.f;if(il&&t===De&&(s&Vn)!==0&&(s&Ud)===0&&(s&zs)!==0)return;if((s&($s|kn))!==0){if((s&kt)===0)return;t.f^=kt}}jt.push(t)}function su(e,t){if(!((e.f&kn)!==0&&(e.f&kt)!==0)){(e.f&Tt)!==0?t.d.push(e):(e.f&xn)!==0&&t.m.push(e),ct(e,kt);for(var n=e.first;n!==null;)su(n,t),n=n.next}}function Pf(e){let t=0,n=fs(0),s;return()=>{Fl()&&(u(n),Nl(()=>(t===0&&(s=Ao(()=>e(()=>Ti(n)))),t+=1,()=>{rs(()=>{t-=1,t===0&&(s==null||s(),s=void 0,Ti(n))})})))}}var Af=oi|pi;function Tf(e,t,n,s){new Rf(e,t,n,s)}var rn,El,Cn,Es,Ht,Pn,Wt,vn,Bn,Cs,Jn,Js,ei,ti,Un,pr,mt,Df,zf,If,ll,qo,Qo,cl;class Rf{constructor(t,n,s,i){L(this,mt);O(this,"parent");O(this,"is_pending",!1);O(this,"transform_error");L(this,rn);L(this,El,null);L(this,Cn);L(this,Es);L(this,Ht);L(this,Pn,null);L(this,Wt,null);L(this,vn,null);L(this,Bn,null);L(this,Cs,0);L(this,Jn,0);L(this,Js,!1);L(this,ei,new Set);L(this,ti,new Set);L(this,Un,null);L(this,pr,Pf(()=>(ge(this,Un,fs(v(this,Cs))),()=>{ge(this,Un,null)})));var a;ge(this,rn,t),ge(this,Cn,n),ge(this,Es,o=>{var r=De;r.b=this,r.f|=nl,s(o)}),this.parent=De.b,this.transform_error=i??((a=this.parent)==null?void 0:a.transform_error)??(o=>o),ge(this,Ht,$l(()=>{yt(this,mt,ll).call(this)},Af))}defer_effect(t){Qd(t,v(this,ei),v(this,ti))}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!v(this,Cn).pending}update_pending_count(t){yt(this,mt,cl).call(this,t),ge(this,Cs,v(this,Cs)+t),!(!v(this,Un)||v(this,Js))&&(ge(this,Js,!0),rs(()=>{ge(this,Js,!1),v(this,Un)&&li(v(this,Un),v(this,Cs))}))}get_effect_pending(){return v(this,pr).call(this),u(v(this,Un))}error(t){var n=v(this,Cn).onerror;let s=v(this,Cn).failed;if(!n&&!s)throw t;v(this,Pn)&&(Gt(v(this,Pn)),ge(this,Pn,null)),v(this,Wt)&&(Gt(v(this,Wt)),ge(this,Wt,null)),v(this,vn)&&(Gt(v(this,vn)),ge(this,vn,null));var i=!1,a=!1;const o=()=>{if(i){yf();return}i=!0,a&&hf(),v(this,vn)!==null&&As(v(this,vn),()=>{ge(this,vn,null)}),yt(this,mt,Qo).call(this,()=>{ls.ensure(),yt(this,mt,ll).call(this)})},r=c=>{try{a=!0,n==null||n(c,o),a=!1}catch(l){es(l,v(this,Ht)&&v(this,Ht).parent)}s&&ge(this,vn,yt(this,mt,Qo).call(this,()=>{ls.ensure();try{return ln(()=>{var l=De;l.b=this,l.f|=nl,s(v(this,rn),()=>c,()=>o)})}catch(l){return es(l,v(this,Ht).parent),null}}))};rs(()=>{var c;try{c=this.transform_error(t)}catch(l){es(l,v(this,Ht)&&v(this,Ht).parent);return}c!==null&&typeof c=="object"&&typeof c.then=="function"?c.then(r,l=>es(l,v(this,Ht)&&v(this,Ht).parent)):r(c)})}}rn=new WeakMap,El=new WeakMap,Cn=new WeakMap,Es=new WeakMap,Ht=new WeakMap,Pn=new WeakMap,Wt=new WeakMap,vn=new WeakMap,Bn=new WeakMap,Cs=new WeakMap,Jn=new WeakMap,Js=new WeakMap,ei=new WeakMap,ti=new WeakMap,Un=new WeakMap,pr=new WeakMap,mt=new WeakSet,Df=function(){try{ge(this,Pn,ln(()=>v(this,Es).call(this,v(this,rn))))}catch(t){this.error(t)}},zf=function(t){const n=v(this,Cn).failed;n&&ge(this,vn,ln(()=>{n(v(this,rn),()=>t,()=>()=>{})}))},If=function(){const t=v(this,Cn).pending;t&&(this.is_pending=!0,ge(this,Wt,ln(()=>t(v(this,rn)))),rs(()=>{var n=ge(this,Bn,document.createDocumentFragment()),s=Yn();n.append(s),ge(this,Pn,yt(this,mt,Qo).call(this,()=>(ls.ensure(),ln(()=>v(this,Es).call(this,s))))),v(this,Jn)===0&&(v(this,rn).before(n),ge(this,Bn,null),As(v(this,Wt),()=>{ge(this,Wt,null)}),yt(this,mt,qo).call(this))}))},ll=function(){try{if(this.is_pending=this.has_pending_snippet(),ge(this,Jn,0),ge(this,Cs,0),ge(this,Pn,ln(()=>{v(this,Es).call(this,v(this,rn))})),v(this,Jn)>0){var t=ge(this,Bn,document.createDocumentFragment());ku(v(this,Pn),t);const n=v(this,Cn).pending;ge(this,Wt,ln(()=>n(v(this,rn))))}else yt(this,mt,qo).call(this)}catch(n){this.error(n)}},qo=function(){this.is_pending=!1;for(const t of v(this,ei))ct(t,Tt),gn(t);for(const t of v(this,ti))ct(t,xn),gn(t);v(this,ei).clear(),v(this,ti).clear()},Qo=function(t){var n=De,s=ke,i=dt;Ln(v(this,Ht)),hn(v(this,Ht)),ri(v(this,Ht).ctx);try{return t()}catch(a){return Kd(a),null}finally{Ln(n),hn(s),ri(i)}},cl=function(t){var n;if(!this.has_pending_snippet()){this.parent&&yt(n=this.parent,mt,cl).call(n,t);return}ge(this,Jn,v(this,Jn)+t),v(this,Jn)===0&&(yt(this,mt,qo).call(this),v(this,Wt)&&As(v(this,Wt),()=>{ge(this,Wt,null)}),v(this,Bn)&&(v(this,rn).before(v(this,Bn)),ge(this,Bn,null)))};function Lf(e,t,n,s){const i=Eo()?gr:iu;var a=e.filter(f=>!f.settled);if(n.length===0&&a.length===0){s(t.map(i));return}var o=De,r=Of(),c=a.length===1?a[0].promise:a.length>1?Promise.all(a.map(f=>f.promise)):null;function l(f){r();try{s(f)}catch(h){(o.f&is)===0&&es(h,o)}dl()}if(n.length===0){c.then(()=>l(t.map(i)));return}function d(){r(),Promise.all(n.map(f=>Nf(f))).then(f=>l([...t.map(i),...f])).catch(f=>es(f,o))}c?c.then(d):d()}function Of(){var e=De,t=ke,n=dt,s=ue;return function(a=!0){Ln(e),hn(t),ri(n),a&&(s==null||s.activate())}}function dl(e=!0){Ln(null),hn(null),ri(null),e&&(ue==null||ue.deactivate())}function Ff(){var e=De.b,t=ue,n=e.is_rendered();return e.update_pending_count(1),t.increment(n),()=>{e.update_pending_count(-1),t.decrement(n)}}function gr(e){var t=At|Tt,n=ke!==null&&(ke.f&At)!==0?ke:null;return De!==null&&(De.f|=pi),{ctx:dt,deps:null,effects:null,equals:Vd,f:t,fn:e,reactions:null,rv:0,v:Et,wv:0,parent:n??De,ac:null}}function Nf(e,t,n){De===null&&nf();var i=void 0,a=fs(Et),o=!ke,r=new Map;return qf(()=>{var h;var c=jd();i=c.promise;try{Promise.resolve(e()).then(c.resolve,c.reject).finally(dl)}catch(p){c.reject(p),dl()}var l=ue;if(o){var d=Ff();(h=r.get(l))==null||h.reject(_s),r.delete(l),r.set(l,c)}const f=(p,g=void 0)=>{if(l.activate(),g)g!==_s&&(a.f|=as,li(a,g));else{(a.f&as)!==0&&(a.f^=as),li(a,p);for(const[x,b]of r){if(r.delete(x),x===l)break;b.reject(_s)}}d&&d()};c.promise.then(f,p=>f(null,p||"unknown"))}),_u(()=>{for(const c of r.values())c.reject(_s)}),new Promise(c=>{function l(d){function f(){d===i?c(a):l(i)}d.then(f,f)}l(i)})}function xt(e){const t=gr(e);return Mu(t),t}function iu(e){const t=gr(e);return t.equals=Xd,t}function $f(e){var t=e.effects;if(t!==null){e.effects=null;for(var n=0;n<t.length;n+=1)Gt(t[n])}}function Hf(e){for(var t=e.parent;t!==null;){if((t.f&At)===0)return(t.f&is)===0?t:null;t=t.parent}return null}function Ll(e){var t,n=De;Ln(Hf(e));try{e.f&=~Is,$f(e),t=Pu(e)}finally{Ln(n)}return t}function au(e){var t=Ll(e);if(!e.equals(t)&&(e.wv=Eu(),(!(ue!=null&&ue.is_fork)||e.deps===null)&&(e.v=t,e.deps===null))){ct(e,kt);return}Ls||(Pt!==null?(Fl()||ue!=null&&ue.is_fork)&&Pt.set(e,t):Il(e))}function jf(e){var t,n;if(e.effects!==null)for(const s of e.effects)(s.teardown||s.ac)&&((t=s.teardown)==null||t.call(s),(n=s.ac)==null||n.abort(_s),s.teardown=Kh,s.ac=null,Oi(s,0),Hl(s))}function ou(e){if(e.effects!==null)for(const t of e.effects)t.teardown&&ci(t)}let ul=new Set;const cs=new Map;let ru=!1;function fs(e,t){var n={f:0,v:e,reactions:null,equals:Vd,rv:0,wv:0};return n}function z(e,t){const n=fs(e);return Mu(n),n}function lu(e,t=!1,n=!0){var i;const s=fs(e);return t||(s.equals=Xd),So&&n&&dt!==null&&dt.l!==null&&((i=dt.l).s??(i.s=[])).push(s),s}function k(e,t,n=!1){ke!==null&&(!bn||(ke.f&dc)!==0)&&Eo()&&(ke.f&(At|Vn|zl|dc))!==0&&(un===null||!ai.call(un,e))&&uf();let s=n?Qt(t):t;return li(e,s)}function li(e,t){if(!e.equals(t)){var n=e.v;Ls?cs.set(e,t):cs.set(e,n),e.v=t;var s=ls.ensure();if(s.capture(e,n),(e.f&At)!==0){const i=e;(e.f&Tt)!==0&&Ll(i),Il(i)}e.wv=Eu(),cu(e,Tt),Eo()&&De!==null&&(De.f&kt)!==0&&(De.f&(kn|$s))===0&&(on===null?ep([e]):on.push(e)),!s.is_fork&&ul.size>0&&!ru&&Bf()}return t}function Bf(){ru=!1;for(const e of ul)(e.f&kt)!==0&&ct(e,xn),Po(e)&&ci(e);ul.clear()}function Ti(e){k(e,e.v+1)}function cu(e,t){var n=e.reactions;if(n!==null)for(var s=Eo(),i=n.length,a=0;a<i;a++){var o=n[a],r=o.f;if(!(!s&&o===De)){var c=(r&Tt)===0;if(c&&ct(o,t),(r&At)!==0){var l=o;Pt==null||Pt.delete(l),(r&Is)===0&&(r&dn&&(o.f|=Is),cu(l,xn))}else c&&((r&Vn)!==0&&pn!==null&&pn.add(o),gn(o))}}}function Qt(e){if(typeof e!="object"||e===null||os in e)return e;const t=Dl(e);if(t!==Xh&&t!==Wh)return e;var n=new Map,s=Rl(e),i=z(0),a=Ts,o=r=>{if(Ts===a)return r();var c=ke,l=Ts;hn(null),_c(a);var d=r();return hn(c),_c(l),d};return s&&n.set("length",z(e.length)),new Proxy(e,{defineProperty(r,c,l){(!("value"in l)||l.configurable===!1||l.enumerable===!1||l.writable===!1)&&cf();var d=n.get(c);return d===void 0?o(()=>{var f=z(l.value);return n.set(c,f),f}):k(d,l.value,!0),!0},deleteProperty(r,c){var l=n.get(c);if(l===void 0){if(c in r){const d=o(()=>z(Et));n.set(c,d),Ti(i)}}else k(l,Et),Ti(i);return!0},get(r,c,l){var p;if(c===os)return e;var d=n.get(c),f=c in r;if(d===void 0&&(!f||(p=Pi(r,c))!=null&&p.writable)&&(d=o(()=>{var g=Qt(f?r[c]:Et),x=z(g);return x}),n.set(c,d)),d!==void 0){var h=u(d);return h===Et?void 0:h}return Reflect.get(r,c,l)},getOwnPropertyDescriptor(r,c){var l=Reflect.getOwnPropertyDescriptor(r,c);if(l&&"value"in l){var d=n.get(c);d&&(l.value=u(d))}else if(l===void 0){var f=n.get(c),h=f==null?void 0:f.v;if(f!==void 0&&h!==Et)return{enumerable:!0,configurable:!0,value:h,writable:!0}}return l},has(r,c){var h;if(c===os)return!0;var l=n.get(c),d=l!==void 0&&l.v!==Et||Reflect.has(r,c);if(l!==void 0||De!==null&&(!d||(h=Pi(r,c))!=null&&h.writable)){l===void 0&&(l=o(()=>{var p=d?Qt(r[c]):Et,g=z(p);return g}),n.set(c,l));var f=u(l);if(f===Et)return!1}return d},set(r,c,l,d){var R;var f=n.get(c),h=c in r;if(s&&c==="length")for(var p=l;p<f.v;p+=1){var g=n.get(p+"");g!==void 0?k(g,Et):p in r&&(g=o(()=>z(Et)),n.set(p+"",g))}if(f===void 0)(!h||(R=Pi(r,c))!=null&&R.writable)&&(f=o(()=>z(void 0)),k(f,Qt(l)),n.set(c,f));else{h=f.v!==Et;var x=o(()=>Qt(l));k(f,x)}var b=Reflect.getOwnPropertyDescriptor(r,c);if(b!=null&&b.set&&b.set.call(d,l),!h){if(s&&typeof c=="string"){var E=n.get("length"),I=Number(c);Number.isInteger(I)&&I>=E.v&&k(E,I+1)}Ti(i)}return!0},ownKeys(r){u(i);var c=Reflect.ownKeys(r).filter(f=>{var h=n.get(f);return h===void 0||h.v!==Et});for(var[l,d]of n)d.v!==Et&&!(l in r)&&c.push(l);return c},setPrototypeOf(){df()}})}function hc(e){try{if(e!==null&&typeof e=="object"&&os in e)return e[os]}catch{}return e}function Uf(e,t){return Object.is(hc(e),hc(t))}var fc,du,uu,hu;function Zf(){if(fc===void 0){fc=window,du=/Firefox/.test(navigator.userAgent);var e=Element.prototype,t=Node.prototype,n=Text.prototype;uu=Pi(t,"firstChild").get,hu=Pi(t,"nextSibling").get,cc(e)&&(e.__click=void 0,e.__className=void 0,e.__attributes=null,e.__style=void 0,e.__e=void 0),cc(n)&&(n.__t=void 0)}}function Yn(e=""){return document.createTextNode(e)}function ar(e){return uu.call(e)}function Co(e){return hu.call(e)}function m(e,t){return ar(e)}function Gn(e,t=!1){{var n=ar(e);return n instanceof Comment&&n.data===""?Co(n):n}}function _(e,t=1,n=!1){let s=e;for(;t--;)s=Co(s);return s}function Yf(e){e.textContent=""}function fu(){return!1}function Gf(e,t,n){return document.createElementNS(Gd,e,void 0)}let pc=!1;function Vf(){pc||(pc=!0,document.addEventListener("reset",e=>{Promise.resolve().then(()=>{var t;if(!e.defaultPrevented)for(const n of e.target.elements)(t=n.__on_r)==null||t.call(n)})},{capture:!0}))}function Ol(e){var t=ke,n=De;hn(null),Ln(null);try{return e()}finally{hn(t),Ln(n)}}function pu(e,t,n,s=n){e.addEventListener(t,()=>Ol(n));const i=e.__on_r;i?e.__on_r=()=>{i(),s(!0)}:e.__on_r=()=>s(!0),Vf()}function vu(e){De===null&&(ke===null&&rf(),of()),Ls&&af()}function Xf(e,t){var n=t.last;n===null?t.last=t.first=e:(n.next=e,e.prev=n,t.last=e)}function On(e,t,n){var s=De;s!==null&&(s.f&tn)!==0&&(e|=tn);var i={ctx:dt,deps:null,nodes:null,f:e|Tt|dn,first:null,fn:t,last:null,next:null,parent:s,b:s&&s.b,prev:null,teardown:null,wv:0,ac:null};if(n)try{ci(i)}catch(r){throw Gt(i),r}else t!==null&&gn(i);var a=i;if(n&&a.deps===null&&a.teardown===null&&a.nodes===null&&a.first===a.last&&(a.f&pi)===0&&(a=a.first,(e&Vn)!==0&&(e&oi)!==0&&a!==null&&(a.f|=oi)),a!==null&&(a.parent=s,s!==null&&Xf(a,s),ke!==null&&(ke.f&At)!==0&&(e&$s)===0)){var o=ke;(o.effects??(o.effects=[])).push(a)}return i}function Fl(){return ke!==null&&!bn}function _u(e){const t=On(Mo,null,!1);return ct(t,kt),t.teardown=e,t}function or(e){vu();var t=De.f,n=!ke&&(t&kn)!==0&&(t&zs)===0;if(n){var s=dt;(s.e??(s.e=[])).push(e)}else return mu(e)}function mu(e){return On(ko|Zd,e,!1)}function Wf(e){return vu(),On(Mo|Zd,e,!0)}function Kf(e){ls.ensure();const t=On($s|pi,e,!0);return(n={})=>new Promise(s=>{n.outro?As(t,()=>{Gt(t),s(void 0)}):(Gt(t),s(void 0))})}function gu(e){return On(ko,e,!1)}function qf(e){return On(zl|pi,e,!0)}function Nl(e,t=0){return On(Mo|t,e,!0)}function he(e,t=[],n=[],s=[]){Lf(s,t,n,i=>{On(Mo,()=>e(...i.map(u)),!0)})}function $l(e,t=0){var n=On(Vn|t,e,!0);return n}function ln(e){return On(kn|pi,e,!0)}function bu(e){var t=e.teardown;if(t!==null){const n=Ls,s=ke;vc(!0),hn(null);try{t.call(null)}finally{vc(n),hn(s)}}}function Hl(e,t=!1){var n=e.first;for(e.first=e.last=null;n!==null;){const i=n.ac;i!==null&&Ol(()=>{i.abort(_s)});var s=n.next;(n.f&$s)!==0?n.parent=null:Gt(n,t),n=s}}function Qf(e){for(var t=e.first;t!==null;){var n=t.next;(t.f&kn)===0&&Gt(t),t=n}}function Gt(e,t=!0){var n=!1;(t||(e.f&Ud)!==0)&&e.nodes!==null&&e.nodes.end!==null&&(Jf(e.nodes.start,e.nodes.end),n=!0),Hl(e,t&&!n),Oi(e,0),ct(e,is);var s=e.nodes&&e.nodes.t;if(s!==null)for(const a of s)a.stop();bu(e);var i=e.parent;i!==null&&i.first!==null&&yu(e),e.next=e.prev=e.teardown=e.ctx=e.deps=e.fn=e.nodes=e.ac=null}function Jf(e,t){for(;e!==null;){var n=e===t?null:Co(e);e.remove(),e=n}}function yu(e){var t=e.parent,n=e.prev,s=e.next;n!==null&&(n.next=s),s!==null&&(s.prev=n),t!==null&&(t.first===e&&(t.first=s),t.last===e&&(t.last=n))}function As(e,t,n=!0){var s=[];wu(e,s,!0);var i=()=>{n&&Gt(e),t&&t()},a=s.length;if(a>0){var o=()=>--a||i();for(var r of s)r.out(o)}else i()}function wu(e,t,n){if((e.f&tn)===0){e.f^=tn;var s=e.nodes&&e.nodes.t;if(s!==null)for(const r of s)(r.is_global||n)&&t.push(r);for(var i=e.first;i!==null;){var a=i.next,o=(i.f&oi)!==0||(i.f&kn)!==0&&(e.f&Vn)!==0;wu(i,t,o?n:!1),i=a}}}function jl(e){xu(e,!0)}function xu(e,t){if((e.f&tn)!==0){e.f^=tn,(e.f&kt)===0&&(ct(e,Tt),gn(e));for(var n=e.first;n!==null;){var s=n.next,i=(n.f&oi)!==0||(n.f&kn)!==0;xu(n,i?t:!1),n=s}var a=e.nodes&&e.nodes.t;if(a!==null)for(const o of a)(o.is_global||t)&&o.in()}}function ku(e,t){if(e.nodes)for(var n=e.nodes.start,s=e.nodes.end;n!==null;){var i=n===s?null:Co(n);t.append(n),n=i}}let Jo=!1,Ls=!1;function vc(e){Ls=e}let ke=null,bn=!1;function hn(e){ke=e}let De=null;function Ln(e){De=e}let un=null;function Mu(e){ke!==null&&(un===null?un=[e]:un.push(e))}let Bt=null,Vt=0,on=null;function ep(e){on=e}let Su=1,gs=0,Ts=gs;function _c(e){Ts=e}function Eu(){return++Su}function Po(e){var t=e.f;if((t&Tt)!==0)return!0;if(t&At&&(e.f&=~Is),(t&xn)!==0){for(var n=e.deps,s=n.length,i=0;i<s;i++){var a=n[i];if(Po(a)&&au(a),a.wv>e.wv)return!0}(t&dn)!==0&&Pt===null&&ct(e,kt)}return!1}function Cu(e,t,n=!0){var s=e.reactions;if(s!==null&&!(un!==null&&ai.call(un,e)))for(var i=0;i<s.length;i++){var a=s[i];(a.f&At)!==0?Cu(a,t,!1):t===a&&(n?ct(a,Tt):(a.f&kt)!==0&&ct(a,xn),gn(a))}}function Pu(e){var x;var t=Bt,n=Vt,s=on,i=ke,a=un,o=dt,r=bn,c=Ts,l=e.f;Bt=null,Vt=0,on=null,ke=(l&(kn|$s))===0?e:null,un=null,ri(e.ctx),bn=!1,Ts=++gs,e.ac!==null&&(Ol(()=>{e.ac.abort(_s)}),e.ac=null);try{e.f|=sl;var d=e.fn,f=d();e.f|=zs;var h=e.deps,p=ue==null?void 0:ue.is_fork;if(Bt!==null){var g;if(p||Oi(e,Vt),h!==null&&Vt>0)for(h.length=Vt+Bt.length,g=0;g<Bt.length;g++)h[Vt+g]=Bt[g];else e.deps=h=Bt;if(Fl()&&(e.f&dn)!==0)for(g=Vt;g<h.length;g++)((x=h[g]).reactions??(x.reactions=[])).push(e)}else!p&&h!==null&&Vt<h.length&&(Oi(e,Vt),h.length=Vt);if(Eo()&&on!==null&&!bn&&h!==null&&(e.f&(At|xn|Tt))===0)for(g=0;g<on.length;g++)Cu(on[g],e);if(i!==null&&i!==e){if(gs++,i.deps!==null)for(let b=0;b<n;b+=1)i.deps[b].rv=gs;if(t!==null)for(const b of t)b.rv=gs;on!==null&&(s===null?s=on:s.push(...on))}return(e.f&as)!==0&&(e.f^=as),f}catch(b){return Kd(b)}finally{e.f^=sl,Bt=t,Vt=n,on=s,ke=i,un=a,ri(o),bn=r,Ts=c}}function tp(e,t){let n=t.reactions;if(n!==null){var s=Gh.call(n,e);if(s!==-1){var i=n.length-1;i===0?n=t.reactions=null:(n[s]=n[i],n.pop())}}if(n===null&&(t.f&At)!==0&&(Bt===null||!ai.call(Bt,t))){var a=t;(a.f&dn)!==0&&(a.f^=dn,a.f&=~Is),Il(a),jf(a),Oi(a,0)}}function Oi(e,t){var n=e.deps;if(n!==null)for(var s=t;s<n.length;s++)tp(e,n[s])}function ci(e){var t=e.f;if((t&is)===0){ct(e,kt);var n=De,s=Jo;De=e,Jo=!0;try{(t&(Vn|Bd))!==0?Qf(e):Hl(e),bu(e);var i=Pu(e);e.teardown=typeof i=="function"?i:null,e.wv=Su;var a;el&&xf&&(e.f&Tt)!==0&&e.deps}finally{Jo=s,De=n}}}async function np(){await Promise.resolve(),Ef()}function u(e){var t=e.f,n=(t&At)!==0;if(ke!==null&&!bn){var s=De!==null&&(De.f&is)!==0;if(!s&&(un===null||!ai.call(un,e))){var i=ke.deps;if((ke.f&sl)!==0)e.rv<gs&&(e.rv=gs,Bt===null&&i!==null&&i[Vt]===e?Vt++:Bt===null?Bt=[e]:Bt.push(e));else{(ke.deps??(ke.deps=[])).push(e);var a=e.reactions;a===null?e.reactions=[ke]:ai.call(a,ke)||a.push(ke)}}}if(Ls&&cs.has(e))return cs.get(e);if(n){var o=e;if(Ls){var r=o.v;return((o.f&kt)===0&&o.reactions!==null||Tu(o))&&(r=Ll(o)),cs.set(o,r),r}var c=(o.f&dn)===0&&!bn&&ke!==null&&(Jo||(ke.f&dn)!==0),l=(o.f&zs)===0;Po(o)&&(c&&(o.f|=dn),au(o)),c&&!l&&(ou(o),Au(o))}if(Pt!=null&&Pt.has(e))return Pt.get(e);if((e.f&as)!==0)throw e.v;return e.v}function Au(e){if(e.f|=dn,e.deps!==null)for(const t of e.deps)(t.reactions??(t.reactions=[])).push(e),(t.f&At)!==0&&(t.f&dn)===0&&(ou(t),Au(t))}function Tu(e){if(e.v===Et)return!0;if(e.deps===null)return!1;for(const t of e.deps)if(cs.has(t)||(t.f&At)!==0&&Tu(t))return!0;return!1}function Ao(e){var t=bn;try{return bn=!0,e()}finally{bn=t}}function sp(e){if(!(typeof e!="object"||!e||e instanceof EventTarget)){if(os in e)hl(e);else if(!Array.isArray(e))for(let t in e){const n=e[t];typeof n=="object"&&n&&os in n&&hl(n)}}}function hl(e,t=new Set){if(typeof e=="object"&&e!==null&&!(e instanceof EventTarget)&&!t.has(e)){t.add(e),e instanceof Date&&e.getTime();for(let s in e)try{hl(e[s],t)}catch{}const n=Dl(e);if(n!==Object.prototype&&n!==Array.prototype&&n!==Map.prototype&&n!==Set.prototype&&n!==Date.prototype){const s=Hd(n);for(let i in s){const a=s[i].get;if(a)try{a.call(e)}catch{}}}}}const ip=["touchstart","touchmove"];function ap(e){return ip.includes(e)}const bs=Symbol("events"),Ru=new Set,fl=new Set;function D(e,t,n){(t[bs]??(t[bs]={}))[e]=n}function Xn(e){for(var t=0;t<e.length;t++)Ru.add(e[t]);for(var n of fl)n(e)}let mc=null;function gc(e){var b,E;var t=this,n=t.ownerDocument,s=e.type,i=((b=e.composedPath)==null?void 0:b.call(e))||[],a=i[0]||e.target;mc=e;var o=0,r=mc===e&&e[bs];if(r){var c=i.indexOf(r);if(c!==-1&&(t===document||t===window)){e[bs]=t;return}var l=i.indexOf(t);if(l===-1)return;c<=l&&(o=c)}if(a=i[o]||e.target,a!==t){Vh(e,"currentTarget",{configurable:!0,get(){return a||n}});var d=ke,f=De;hn(null),Ln(null);try{for(var h,p=[];a!==null;){var g=a.assignedSlot||a.parentNode||a.host||null;try{var x=(E=a[bs])==null?void 0:E[s];x!=null&&(!a.disabled||e.target===a)&&x.call(a,e)}catch(I){h?p.push(I):h=I}if(e.cancelBubble||g===t||g===null)break;a=g}if(h){for(let I of p)queueMicrotask(()=>{throw I});throw h}}finally{e[bs]=t,delete e.currentTarget,hn(d),Ln(f)}}}var Id;const Mr=((Id=globalThis==null?void 0:globalThis.window)==null?void 0:Id.trustedTypes)&&globalThis.window.trustedTypes.createPolicy("svelte-trusted-html",{createHTML:e=>e});function op(e){return(Mr==null?void 0:Mr.createHTML(e))??e}function rp(e){var t=Gf("template");return t.innerHTML=op(e.replaceAll("<!>","<!---->")),t.content}function rr(e,t){var n=De;n.nodes===null&&(n.nodes={start:e,end:t,a:null,t:null})}function ee(e,t){var n=(t&mf)!==0,s=(t&gf)!==0,i,a=!e.startsWith("<!>");return()=>{i===void 0&&(i=rp(a?e:"<!>"+e),n||(i=ar(i)));var o=s||du?document.importNode(i,!0):i.cloneNode(!0);if(n){var r=ar(o),c=o.lastChild;rr(r,c)}else rr(o,o);return o}}function Fi(e=""){{var t=Yn(e+"");return rr(t,t),t}}function lp(){var e=document.createDocumentFragment(),t=document.createComment(""),n=Yn();return e.append(t,n),rr(t,n),e}function K(e,t){e!==null&&e.before(t)}function B(e,t){var n=t==null?"":typeof t=="object"?t+"":t;n!==(e.__t??(e.__t=e.nodeValue))&&(e.__t=n,e.nodeValue=n+"")}function cp(e,t){return dp(e,t)}const $o=new Map;function dp(e,{target:t,anchor:n,props:s={},events:i,context:a,intro:o=!0,transformError:r}){Zf();var c=void 0,l=Kf(()=>{var d=n??t.appendChild(Yn());Tf(d,{pending:()=>{}},p=>{sn({});var g=dt;a&&(g.c=a),i&&(s.$$events=i),c=e(p,s)||{},an()},r);var f=new Set,h=p=>{for(var g=0;g<p.length;g++){var x=p[g];if(!f.has(x)){f.add(x);var b=ap(x);for(const R of[t,document]){var E=$o.get(R);E===void 0&&(E=new Map,$o.set(R,E));var I=E.get(x);I===void 0?(R.addEventListener(x,gc,{passive:b}),E.set(x,1)):E.set(x,I+1)}}}};return h(_r(Ru)),fl.add(h),()=>{var b;for(var p of f)for(const E of[t,document]){var g=$o.get(E),x=g.get(p);--x==0?(E.removeEventListener(p,gc),g.delete(p),g.size===0&&$o.delete(E)):g.set(p,x)}fl.delete(h),d!==n&&((b=d.parentNode)==null||b.removeChild(d))}});return up.set(c,l),c}let up=new WeakMap;var _n,An,Kt,Ps,Ki,qi,vr;class hp{constructor(t,n=!0){O(this,"anchor");L(this,_n,new Map);L(this,An,new Map);L(this,Kt,new Map);L(this,Ps,new Set);L(this,Ki,!0);L(this,qi,()=>{var t=ue;if(v(this,_n).has(t)){var n=v(this,_n).get(t),s=v(this,An).get(n);if(s)jl(s),v(this,Ps).delete(n);else{var i=v(this,Kt).get(n);i&&(v(this,An).set(n,i.effect),v(this,Kt).delete(n),i.fragment.lastChild.remove(),this.anchor.before(i.fragment),s=i.effect)}for(const[a,o]of v(this,_n)){if(v(this,_n).delete(a),a===t)break;const r=v(this,Kt).get(o);r&&(Gt(r.effect),v(this,Kt).delete(o))}for(const[a,o]of v(this,An)){if(a===n||v(this,Ps).has(a))continue;const r=()=>{if(Array.from(v(this,_n).values()).includes(a)){var l=document.createDocumentFragment();ku(o,l),l.append(Yn()),v(this,Kt).set(a,{effect:o,fragment:l})}else Gt(o);v(this,Ps).delete(a),v(this,An).delete(a)};v(this,Ki)||!s?(v(this,Ps).add(a),As(o,r,!1)):r()}}});L(this,vr,t=>{v(this,_n).delete(t);const n=Array.from(v(this,_n).values());for(const[s,i]of v(this,Kt))n.includes(s)||(Gt(i.effect),v(this,Kt).delete(s))});this.anchor=t,ge(this,Ki,n)}ensure(t,n){var s=ue,i=fu();if(n&&!v(this,An).has(t)&&!v(this,Kt).has(t))if(i){var a=document.createDocumentFragment(),o=Yn();a.append(o),v(this,Kt).set(t,{effect:ln(()=>n(o)),fragment:a})}else v(this,An).set(t,ln(()=>n(this.anchor)));if(v(this,_n).set(s,t),i){for(const[r,c]of v(this,An))r===t?s.unskip_effect(c):s.skip_effect(c);for(const[r,c]of v(this,Kt))r===t?s.unskip_effect(c.effect):s.skip_effect(c.effect);s.oncommit(v(this,qi)),s.ondiscard(v(this,vr))}else v(this,qi).call(this)}}_n=new WeakMap,An=new WeakMap,Kt=new WeakMap,Ps=new WeakMap,Ki=new WeakMap,qi=new WeakMap,vr=new WeakMap;function Me(e,t,n=!1){var s=new hp(e),i=n?oi:0;function a(o,r){s.ensure(o,r)}$l(()=>{var o=!1;t((r,c=0)=>{o=!0,a(c,r)}),o||a(!1,null)},i)}function Dn(e,t){return t}function fp(e,t,n){for(var s=[],i=t.length,a,o=t.length,r=0;r<i;r++){let f=t[r];As(f,()=>{if(a){if(a.pending.delete(f),a.done.add(f),a.pending.size===0){var h=e.outrogroups;pl(_r(a.done)),h.delete(a),h.size===0&&(e.outrogroups=null)}}else o-=1},!1)}if(o===0){var c=s.length===0&&n!==null;if(c){var l=n,d=l.parentNode;Yf(d),d.append(l),e.items.clear()}pl(t,!c)}else a={pending:new Set(t),done:new Set},(e.outrogroups??(e.outrogroups=new Set)).add(a)}function pl(e,t=!0){for(var n=0;n<e.length;n++)Gt(e[n],t)}var bc;function Zt(e,t,n,s,i,a=null){var o=e,r=new Map,c=(t&Yd)!==0;if(c){var l=e;o=l.appendChild(Yn())}var d=null,f=iu(()=>{var E=n();return Rl(E)?E:E==null?[]:_r(E)}),h,p=!0;function g(){b.fallback=d,pp(b,h,o,t,s),d!==null&&(h.length===0?(d.f&Zn)===0?jl(d):(d.f^=Zn,ki(d,null,o)):As(d,()=>{d=null}))}var x=$l(()=>{h=u(f);for(var E=h.length,I=new Set,R=ue,y=fu(),C=0;C<E;C+=1){var $=h[C],S=s($,C),P=p?null:r.get(S);P?(P.v&&li(P.v,$),P.i&&li(P.i,C),y&&R.unskip_effect(P.e)):(P=vp(r,p?o:bc??(bc=Yn()),$,S,C,i,t,n),p||(P.e.f|=Zn),r.set(S,P)),I.add(S)}if(E===0&&a&&!d&&(p?d=ln(()=>a(o)):(d=ln(()=>a(bc??(bc=Yn()))),d.f|=Zn)),E>I.size&&sf(),!p)if(y){for(const[M,A]of r)I.has(M)||R.skip_effect(A.e);R.oncommit(g),R.ondiscard(()=>{})}else g();u(f)}),b={effect:x,items:r,outrogroups:null,fallback:d};p=!1}function bi(e){for(;e!==null&&(e.f&kn)===0;)e=e.next;return e}function pp(e,t,n,s,i){var A,T,j,ne,se,Q,U,N,oe;var a=(s&vf)!==0,o=t.length,r=e.items,c=bi(e.effect.first),l,d=null,f,h=[],p=[],g,x,b,E;if(a)for(E=0;E<o;E+=1)g=t[E],x=i(g,E),b=r.get(x).e,(b.f&Zn)===0&&((T=(A=b.nodes)==null?void 0:A.a)==null||T.measure(),(f??(f=new Set)).add(b));for(E=0;E<o;E+=1){if(g=t[E],x=i(g,E),b=r.get(x).e,e.outrogroups!==null)for(const ae of e.outrogroups)ae.pending.delete(b),ae.done.delete(b);if((b.f&Zn)!==0)if(b.f^=Zn,b===c)ki(b,null,n);else{var I=d?d.next:c;b===e.effect.last&&(e.effect.last=b.prev),b.prev&&(b.prev.next=b.next),b.next&&(b.next.prev=b.prev),Wn(e,d,b),Wn(e,b,I),ki(b,I,n),d=b,h=[],p=[],c=bi(d.next);continue}if((b.f&tn)!==0&&(jl(b),a&&((ne=(j=b.nodes)==null?void 0:j.a)==null||ne.unfix(),(f??(f=new Set)).delete(b))),b!==c){if(l!==void 0&&l.has(b)){if(h.length<p.length){var R=p[0],y;d=R.prev;var C=h[0],$=h[h.length-1];for(y=0;y<h.length;y+=1)ki(h[y],R,n);for(y=0;y<p.length;y+=1)l.delete(p[y]);Wn(e,C.prev,$.next),Wn(e,d,C),Wn(e,$,R),c=R,d=$,E-=1,h=[],p=[]}else l.delete(b),ki(b,c,n),Wn(e,b.prev,b.next),Wn(e,b,d===null?e.effect.first:d.next),Wn(e,d,b),d=b;continue}for(h=[],p=[];c!==null&&c!==b;)(l??(l=new Set)).add(c),p.push(c),c=bi(c.next);if(c===null)continue}(b.f&Zn)===0&&h.push(b),d=b,c=bi(b.next)}if(e.outrogroups!==null){for(const ae of e.outrogroups)ae.pending.size===0&&(pl(_r(ae.done)),(se=e.outrogroups)==null||se.delete(ae));e.outrogroups.size===0&&(e.outrogroups=null)}if(c!==null||l!==void 0){var S=[];if(l!==void 0)for(b of l)(b.f&tn)===0&&S.push(b);for(;c!==null;)(c.f&tn)===0&&c!==e.fallback&&S.push(c),c=bi(c.next);var P=S.length;if(P>0){var M=(s&Yd)!==0&&o===0?n:null;if(a){for(E=0;E<P;E+=1)(U=(Q=S[E].nodes)==null?void 0:Q.a)==null||U.measure();for(E=0;E<P;E+=1)(oe=(N=S[E].nodes)==null?void 0:N.a)==null||oe.fix()}fp(e,S,M)}}a&&rs(()=>{var ae,ve;if(f!==void 0)for(b of f)(ve=(ae=b.nodes)==null?void 0:ae.a)==null||ve.apply()})}function vp(e,t,n,s,i,a,o,r){var c=(o&ff)!==0?(o&_f)===0?lu(n,!1,!1):fs(n):null,l=(o&pf)!==0?fs(i):null;return{v:c,i:l,e:ln(()=>(a(t,c??n,l??i,r),()=>{e.delete(s)}))}}function ki(e,t,n){if(e.nodes)for(var s=e.nodes.start,i=e.nodes.end,a=t&&(t.f&Zn)===0?t.nodes.start:n;s!==null;){var o=Co(s);if(a.before(s),s===i)return;s=o}}function Wn(e,t,n){t===null?e.effect.first=n:t.next=n,n===null?e.effect.last=t:n.prev=t}const yc=[...` 	
\r\fÂ \v\uFEFF`];function _p(e,t,n){var s=e==null?"":""+e;if(t&&(s=s?s+" "+t:t),n){for(var i of Object.keys(n))if(n[i])s=s?s+" "+i:i;else if(s.length)for(var a=i.length,o=0;(o=s.indexOf(i,o))>=0;){var r=o+a;(o===0||yc.includes(s[o-1]))&&(r===s.length||yc.includes(s[r]))?s=(o===0?"":s.substring(0,o))+s.substring(r+1):o=r}}return s===""?null:s}function wc(e,t=!1){var n=t?" !important;":";",s="";for(var i of Object.keys(e)){var a=e[i];a!=null&&a!==""&&(s+=" "+i+": "+a+n)}return s}function Sr(e){return e[0]!=="-"||e[1]!=="-"?e.toLowerCase():e}function mp(e,t){if(t){var n="",s,i;if(Array.isArray(t)?(s=t[0],i=t[1]):s=t,e){e=String(e).replaceAll(/\s*\/\*.*?\*\/\s*/g,"").trim();var a=!1,o=0,r=!1,c=[];s&&c.push(...Object.keys(s).map(Sr)),i&&c.push(...Object.keys(i).map(Sr));var l=0,d=-1;const x=e.length;for(var f=0;f<x;f++){var h=e[f];if(r?h==="/"&&e[f-1]==="*"&&(r=!1):a?a===h&&(a=!1):h==="/"&&e[f+1]==="*"?r=!0:h==='"'||h==="'"?a=h:h==="("?o++:h===")"&&o--,!r&&a===!1&&o===0){if(h===":"&&d===-1)d=f;else if(h===";"||f===x-1){if(d!==-1){var p=Sr(e.substring(l,d).trim());if(!c.includes(p)){h!==";"&&f++;var g=e.substring(l,f).trim();n+=" "+g+";"}}l=f+1,d=-1}}}}return s&&(n+=wc(s)),i&&(n+=wc(i,!0)),n=n.trim(),n===""?null:n}return e==null?null:String(e)}function Oe(e,t,n,s,i,a){var o=e.__className;if(o!==n||o===void 0){var r=_p(n,s,a);r==null?e.removeAttribute("class"):e.className=r,e.__className=n}else if(a&&i!==a)for(var c in a){var l=!!a[c];(i==null||l!==!!i[c])&&e.classList.toggle(c,l)}return a}function Er(e,t={},n,s){for(var i in n){var a=n[i];t[i]!==a&&(n[i]==null?e.style.removeProperty(i):e.style.setProperty(i,a,s))}}function Nn(e,t,n,s){var i=e.__style;if(i!==t){var a=mp(t,s);a==null?e.removeAttribute("style"):e.style.cssText=a,e.__style=t}else s&&(Array.isArray(s)?(Er(e,n==null?void 0:n[0],s[0]),Er(e,n==null?void 0:n[1],s[1],"important")):Er(e,n,s));return s}function Rs(e,t,n=!1){if(e.multiple){if(t==null)return;if(!Rl(t))return bf();for(var s of e.options)s.selected=t.includes(Ri(s));return}for(s of e.options){var i=Ri(s);if(Uf(i,t)){s.selected=!0;return}}(!n||t!==void 0)&&(e.selectedIndex=-1)}function Vs(e){var t=new MutationObserver(()=>{Rs(e,e.__value)});t.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),_u(()=>{t.disconnect()})}function Du(e,t,n=t){var s=new WeakSet,i=!0;pu(e,"change",a=>{var o=a?"[selected]":":checked",r;if(e.multiple)r=[].map.call(e.querySelectorAll(o),Ri);else{var c=e.querySelector(o)??e.querySelector("option:not([disabled])");r=c&&Ri(c)}n(r),ue!==null&&s.add(ue)}),gu(()=>{var a=t();if(e===document.activeElement){var o=ir??ue;if(s.has(o))return}if(Rs(e,a,i),i&&a===void 0){var r=e.querySelector(":checked");r!==null&&(a=Ri(r),n(a))}e.__value=a,i=!1}),Vs(e)}function Ri(e){return"__value"in e?e.__value:e.value}const gp=Symbol("is custom element"),bp=Symbol("is html"),yp=ef?"progress":"PROGRESS";function _t(e,t){var n=Bl(e);n.value===(n.value=t??void 0)||e.value===t&&(t!==0||e.nodeName!==yp)||(e.value=t??"")}function lr(e,t){var n=Bl(e);n.checked!==(n.checked=t??void 0)&&(e.checked=t)}function di(e,t,n,s){var i=Bl(e);i[t]!==(i[t]=n)&&(t==="loading"&&(e[Jh]=n),n==null?e.removeAttribute(t):typeof n!="string"&&wp(e).includes(t)?e[t]=n:e.setAttribute(t,n))}function Bl(e){return e.__attributes??(e.__attributes={[gp]:e.nodeName.includes("-"),[bp]:e.namespaceURI===Gd})}var xc=new Map;function wp(e){var t=e.getAttribute("is")||e.nodeName,n=xc.get(t);if(n)return n;xc.set(t,n=[]);for(var s,i=e,a=Element.prototype;a!==i;){s=Hd(i);for(var o in s)s[o].set&&n.push(o);i=Dl(i)}return n}function ys(e,t,n=t){var s=new WeakSet;pu(e,"input",async i=>{var a=i?e.defaultValue:e.value;if(a=Cr(e)?Pr(a):a,n(a),ue!==null&&s.add(ue),await np(),a!==(a=t())){var o=e.selectionStart,r=e.selectionEnd,c=e.value.length;if(e.value=a??"",r!==null){var l=e.value.length;o===r&&r===c&&l>c?(e.selectionStart=l,e.selectionEnd=l):(e.selectionStart=o,e.selectionEnd=Math.min(r,l))}}}),Ao(t)==null&&e.value&&(n(Cr(e)?Pr(e.value):e.value),ue!==null&&s.add(ue)),Nl(()=>{var i=t();if(e===document.activeElement){var a=ir??ue;if(s.has(a))return}Cr(e)&&i===Pr(e.value)||e.type==="date"&&!i&&!e.value||i!==e.value&&(e.value=i??"")})}function Cr(e){var t=e.type;return t==="number"||t==="range"}function Pr(e){return e===""?null:+e}function kc(e,t){return e===t||(e==null?void 0:e[os])===t}function er(e={},t,n,s){return gu(()=>{var i,a;return Nl(()=>{i=a,a=[],Ao(()=>{e!==n(...a)&&(t(e,...a),i&&kc(n(...i),e)&&t(null,...i))})}),()=>{rs(()=>{a&&kc(n(...a),e)&&t(null,...a)})}}),e}function To(e=!1){const t=dt,n=t.l.u;if(!n)return;let s=()=>sp(t.s);if(e){let i=0,a={};const o=gr(()=>{let r=!1;const c=t.s;for(const l in c)c[l]!==a[l]&&(a[l]=c[l],r=!0);return r&&i++,i});s=()=>u(o)}n.b.length&&Wf(()=>{Mc(t,s),tl(n.b)}),or(()=>{const i=Ao(()=>n.m.map(qh));return()=>{for(const a of i)typeof a=="function"&&a()}}),n.a.length&&or(()=>{Mc(t,s),tl(n.a)})}function Mc(e,t){if(e.l.s)for(const n of e.l.s)u(n);t()}function zu(e){var t=fs(0);return function(){return arguments.length===1?(k(t,u(t)+1),arguments[0]):(u(t),e())}}function Iu(e){dt===null&&tf(),So&&dt.l!==null?xp(dt).m.push(e):or(()=>{const t=Ao(e);if(typeof t=="function")return t})}function xp(e){var t=e.l;return t.u??(t.u={a:[],b:[],m:[]})}const kp="5";var Ld;typeof window<"u"&&((Ld=window.__svelte??(window.__svelte={})).v??(Ld.v=new Set)).add(kp);kf();let Mp=0;var Qi,Ji,ea,ta,na;class Sp{constructor(){L(this,Qi,z("file"));L(this,Ji,z("Ready"));L(this,ea,z(null));L(this,ta,z(Qt([])));L(this,na,z(null))}get activeTab(){return u(v(this,Qi))}set activeTab(t){k(v(this,Qi),t,!0)}get statusMessage(){return u(v(this,Ji))}set statusMessage(t){k(v(this,Ji),t,!0)}get currentTool(){return u(v(this,ea))}set currentTool(t){k(v(this,ea),t,!0)}get toasts(){return u(v(this,ta))}set toasts(t){k(v(this,ta),t,!0)}get confirmDialog(){return u(v(this,na))}set confirmDialog(t){k(v(this,na),t,!0)}toast(t,n="info"){const s=++Mp;this.toasts=[...this.toasts,{id:s,message:t,level:n}],setTimeout(()=>{this.toasts=this.toasts.filter(i=>i.id!==s)},3e3)}confirm(t,n){return new Promise(s=>{this.confirmDialog={title:t,message:n,resolve:s}})}closeConfirm(t){var n;(n=this.confirmDialog)==null||n.resolve(t),this.confirmDialog=null}}Qi=new WeakMap,Ji=new WeakMap,ea=new WeakMap,ta=new WeakMap,na=new WeakMap;const F=new Sp;var sa,ia,aa,oa;class Ep{constructor(){O(this,"undoStack",[]);O(this,"redoStack",[]);L(this,sa,z(!1));L(this,ia,z(!1));L(this,aa,z(0));L(this,oa,z(0));O(this,"MAX_HISTORY",20);O(this,"voxelGrids",{})}get canUndo(){return u(v(this,sa))}set canUndo(t){k(v(this,sa),t,!0)}get canRedo(){return u(v(this,ia))}set canRedo(t){k(v(this,ia),t,!0)}get undoCount(){return u(v(this,aa))}set undoCount(t){k(v(this,aa),t,!0)}get redoCount(){return u(v(this,oa))}set redoCount(t){k(v(this,oa),t,!0)}setVoxelGrids(t){this.voxelGrids=t}push(t){const n=new Map;for(const[s,i]of Object.entries(this.voxelGrids)){const a=i.createSnapshot();a&&n.set(s,a)}n.size!==0&&(this.undoStack.push({label:t,snapshots:n}),this.redoStack=[],this.undoStack.length>this.MAX_HISTORY&&this.undoStack.shift(),this._updateState())}undo(){if(this.undoStack.length===0)return null;const t=new Map;for(const[s,i]of Object.entries(this.voxelGrids)){const a=i.createSnapshot();a&&t.set(s,a)}this.redoStack.push({label:"redo",snapshots:t});const n=this.undoStack.pop();return n.snapshots.forEach((s,i)=>{const a=this.voxelGrids[i];a&&a.restoreSnapshot(s)}),this._updateState(),n.label}redo(){if(this.redoStack.length===0)return null;const t=new Map;for(const[s,i]of Object.entries(this.voxelGrids)){const a=i.createSnapshot();a&&t.set(s,a)}this.undoStack.push({label:"undo",snapshots:t});const n=this.redoStack.pop();return n.snapshots.forEach((s,i)=>{const a=this.voxelGrids[i];a&&a.restoreSnapshot(s)}),this._updateState(),n.label}clear(){this.undoStack=[],this.redoStack=[],this._updateState()}_updateState(){this.canUndo=this.undoStack.length>0,this.canRedo=this.redoStack.length>0,this.undoCount=this.undoStack.length,this.redoCount=this.redoStack.length}}sa=new WeakMap,ia=new WeakMap,aa=new WeakMap,oa=new WeakMap;const zt=new Ep;var Ar=zu(()=>F),Cp=ee("<button> </button>"),Pp=ee('<div class="menubar svelte-1ajdjds"><span class="logo svelte-1ajdjds">Spine Simulator</span> <div class="tab-group svelte-1ajdjds"></div> <div class="right svelte-1ajdjds"><button class="icon-btn svelte-1ajdjds" title="Undo (Ctrl+Z)" aria-label="Undo">&#8617;</button> <button class="icon-btn svelte-1ajdjds" title="Redo (Ctrl+Y)" aria-label="Redo">&#8618;</button></div></div>');function Ap(e,t){sn(t,!1);const n=[{id:"file",label:"File"},{id:"modeling",label:"Modeling"},{id:"material",label:"Material"},{id:"preprocess",label:"Pre-process"},{id:"solve",label:"Solve"},{id:"postprocess",label:"Post-process"}];function s(l){Ar(Ar().activeTab=l)}To();var i=Pp(),a=_(m(i),2);Zt(a,5,()=>n,Dn,(l,d)=>{var f=Cp();let h;var p=m(f);he(()=>{h=Oe(f,1,"tab-btn svelte-1ajdjds",null,h,{active:Ar().activeTab===u(d).id}),B(p,u(d).label)}),D("click",f,()=>s(u(d).id)),K(l,f)});var o=_(a,2),r=m(o),c=_(r,2);he(()=>{r.disabled=!zt.canUndo,c.disabled=!zt.canRedo}),D("click",r,()=>zt.undo()),D("click",c,()=>zt.redo()),K(e,i),an()}Xn(["click"]);const Sc={type:"change"},Ul={type:"start"},Lu={type:"end"},Ho=new Ih,Ec=new Cl,Tp=Math.cos(70*Lh.DEG2RAD),vt=new Y,Nt=2*Math.PI,Ne={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},Tr=1e-6;class Rp extends Od{constructor(t,n=null){super(t,n),this.state=Ne.NONE,this.enabled=!0,this.target=new Y,this.cursor=new Y,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:ns.ROTATE,MIDDLE:ns.DOLLY,RIGHT:ns.PAN},this.touches={ONE:Gs.ROTATE,TWO:Gs.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new Y,this._lastQuaternion=new Ut,this._lastTargetPosition=new Y,this._quat=new Ut().setFromUnitVectors(t.up,new Y(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new ac,this._sphericalDelta=new ac,this._scale=1,this._panOffset=new Y,this._rotateStart=new $t,this._rotateEnd=new $t,this._rotateDelta=new $t,this._panStart=new $t,this._panEnd=new $t,this._panDelta=new $t,this._dollyStart=new $t,this._dollyEnd=new $t,this._dollyDelta=new $t,this._dollyDirection=new Y,this._mouse=new $t,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=zp.bind(this),this._onPointerDown=Dp.bind(this),this._onPointerUp=Ip.bind(this),this._onContextMenu=jp.bind(this),this._onMouseWheel=Fp.bind(this),this._onKeyDown=Np.bind(this),this._onTouchStart=$p.bind(this),this._onTouchMove=Hp.bind(this),this._onMouseDown=Lp.bind(this),this._onMouseMove=Op.bind(this),this._interceptControlDown=Bp.bind(this),this._interceptControlUp=Up.bind(this),this.domElement!==null&&this.connect(),this.update()}connect(){this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents(),this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(t){t.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=t}stopListenToKeyEvents(){this._domElementKeyEvents!==null&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(Sc),this.update(),this.state=Ne.NONE}update(t=null){const n=this.object.position;vt.copy(n).sub(this.target),vt.applyQuaternion(this._quat),this._spherical.setFromVector3(vt),this.autoRotate&&this.state===Ne.NONE&&this._rotateLeft(this._getAutoRotationAngle(t)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let s=this.minAzimuthAngle,i=this.maxAzimuthAngle;isFinite(s)&&isFinite(i)&&(s<-Math.PI?s+=Nt:s>Math.PI&&(s-=Nt),i<-Math.PI?i+=Nt:i>Math.PI&&(i-=Nt),s<=i?this._spherical.theta=Math.max(s,Math.min(i,this._spherical.theta)):this._spherical.theta=this._spherical.theta>(s+i)/2?Math.max(s,this._spherical.theta):Math.min(i,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),this.enableDamping===!0?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let a=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const o=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),a=o!=this._spherical.radius}if(vt.setFromSpherical(this._spherical),vt.applyQuaternion(this._quatInverse),n.copy(this.target).add(vt),this.object.lookAt(this.target),this.enableDamping===!0?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let o=null;if(this.object.isPerspectiveCamera){const r=vt.length();o=this._clampDistance(r*this._scale);const c=r-o;this.object.position.addScaledVector(this._dollyDirection,c),this.object.updateMatrixWorld(),a=!!c}else if(this.object.isOrthographicCamera){const r=new Y(this._mouse.x,this._mouse.y,0);r.unproject(this.object);const c=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),a=c!==this.object.zoom;const l=new Y(this._mouse.x,this._mouse.y,0);l.unproject(this.object),this.object.position.sub(l).add(r),this.object.updateMatrixWorld(),o=vt.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),this.zoomToCursor=!1;o!==null&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(o).add(this.object.position):(Ho.origin.copy(this.object.position),Ho.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(Ho.direction))<Tp?this.object.lookAt(this.target):(Ec.setFromNormalAndCoplanarPoint(this.object.up,this.target),Ho.intersectPlane(Ec,this.target))))}else if(this.object.isOrthographicCamera){const o=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),o!==this.object.zoom&&(this.object.updateProjectionMatrix(),a=!0)}return this._scale=1,this._performCursorZoom=!1,a||this._lastPosition.distanceToSquared(this.object.position)>Tr||8*(1-this._lastQuaternion.dot(this.object.quaternion))>Tr||this._lastTargetPosition.distanceToSquared(this.target)>Tr?(this.dispatchEvent(Sc),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0):!1}_getAutoRotationAngle(t){return t!==null?Nt/60*this.autoRotateSpeed*t:Nt/60/60*this.autoRotateSpeed}_getZoomScale(t){const n=Math.abs(t*.01);return Math.pow(.95,this.zoomSpeed*n)}_rotateLeft(t){this._sphericalDelta.theta-=t}_rotateUp(t){this._sphericalDelta.phi-=t}_panLeft(t,n){vt.setFromMatrixColumn(n,0),vt.multiplyScalar(-t),this._panOffset.add(vt)}_panUp(t,n){this.screenSpacePanning===!0?vt.setFromMatrixColumn(n,1):(vt.setFromMatrixColumn(n,0),vt.crossVectors(this.object.up,vt)),vt.multiplyScalar(t),this._panOffset.add(vt)}_pan(t,n){const s=this.domElement;if(this.object.isPerspectiveCamera){const i=this.object.position;vt.copy(i).sub(this.target);let a=vt.length();a*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*t*a/s.clientHeight,this.object.matrix),this._panUp(2*n*a/s.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(t*(this.object.right-this.object.left)/this.object.zoom/s.clientWidth,this.object.matrix),this._panUp(n*(this.object.top-this.object.bottom)/this.object.zoom/s.clientHeight,this.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),this.enablePan=!1)}_dollyOut(t){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=t:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_dollyIn(t){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=t:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_updateZoomParameters(t,n){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const s=this.domElement.getBoundingClientRect(),i=t-s.left,a=n-s.top,o=s.width,r=s.height;this._mouse.x=i/o*2-1,this._mouse.y=-(a/r)*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(t){return Math.max(this.minDistance,Math.min(this.maxDistance,t))}_handleMouseDownRotate(t){this._rotateStart.set(t.clientX,t.clientY)}_handleMouseDownDolly(t){this._updateZoomParameters(t.clientX,t.clientX),this._dollyStart.set(t.clientX,t.clientY)}_handleMouseDownPan(t){this._panStart.set(t.clientX,t.clientY)}_handleMouseMoveRotate(t){this._rotateEnd.set(t.clientX,t.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const n=this.domElement;this._rotateLeft(Nt*this._rotateDelta.x/n.clientHeight),this._rotateUp(Nt*this._rotateDelta.y/n.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(t){this._dollyEnd.set(t.clientX,t.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(t){this._panEnd.set(t.clientX,t.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(t){this._updateZoomParameters(t.clientX,t.clientY),t.deltaY<0?this._dollyIn(this._getZoomScale(t.deltaY)):t.deltaY>0&&this._dollyOut(this._getZoomScale(t.deltaY)),this.update()}_handleKeyDown(t){let n=!1;switch(t.code){case this.keys.UP:t.ctrlKey||t.metaKey||t.shiftKey?this._rotateUp(Nt*this.rotateSpeed/this.domElement.clientHeight):this._pan(0,this.keyPanSpeed),n=!0;break;case this.keys.BOTTOM:t.ctrlKey||t.metaKey||t.shiftKey?this._rotateUp(-Nt*this.rotateSpeed/this.domElement.clientHeight):this._pan(0,-this.keyPanSpeed),n=!0;break;case this.keys.LEFT:t.ctrlKey||t.metaKey||t.shiftKey?this._rotateLeft(Nt*this.rotateSpeed/this.domElement.clientHeight):this._pan(this.keyPanSpeed,0),n=!0;break;case this.keys.RIGHT:t.ctrlKey||t.metaKey||t.shiftKey?this._rotateLeft(-Nt*this.rotateSpeed/this.domElement.clientHeight):this._pan(-this.keyPanSpeed,0),n=!0;break}n&&(t.preventDefault(),this.update())}_handleTouchStartRotate(t){if(this._pointers.length===1)this._rotateStart.set(t.pageX,t.pageY);else{const n=this._getSecondPointerPosition(t),s=.5*(t.pageX+n.x),i=.5*(t.pageY+n.y);this._rotateStart.set(s,i)}}_handleTouchStartPan(t){if(this._pointers.length===1)this._panStart.set(t.pageX,t.pageY);else{const n=this._getSecondPointerPosition(t),s=.5*(t.pageX+n.x),i=.5*(t.pageY+n.y);this._panStart.set(s,i)}}_handleTouchStartDolly(t){const n=this._getSecondPointerPosition(t),s=t.pageX-n.x,i=t.pageY-n.y,a=Math.sqrt(s*s+i*i);this._dollyStart.set(0,a)}_handleTouchStartDollyPan(t){this.enableZoom&&this._handleTouchStartDolly(t),this.enablePan&&this._handleTouchStartPan(t)}_handleTouchStartDollyRotate(t){this.enableZoom&&this._handleTouchStartDolly(t),this.enableRotate&&this._handleTouchStartRotate(t)}_handleTouchMoveRotate(t){if(this._pointers.length==1)this._rotateEnd.set(t.pageX,t.pageY);else{const s=this._getSecondPointerPosition(t),i=.5*(t.pageX+s.x),a=.5*(t.pageY+s.y);this._rotateEnd.set(i,a)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const n=this.domElement;this._rotateLeft(Nt*this._rotateDelta.x/n.clientHeight),this._rotateUp(Nt*this._rotateDelta.y/n.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(t){if(this._pointers.length===1)this._panEnd.set(t.pageX,t.pageY);else{const n=this._getSecondPointerPosition(t),s=.5*(t.pageX+n.x),i=.5*(t.pageY+n.y);this._panEnd.set(s,i)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(t){const n=this._getSecondPointerPosition(t),s=t.pageX-n.x,i=t.pageY-n.y,a=Math.sqrt(s*s+i*i);this._dollyEnd.set(0,a),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const o=(t.pageX+n.x)*.5,r=(t.pageY+n.y)*.5;this._updateZoomParameters(o,r)}_handleTouchMoveDollyPan(t){this.enableZoom&&this._handleTouchMoveDolly(t),this.enablePan&&this._handleTouchMovePan(t)}_handleTouchMoveDollyRotate(t){this.enableZoom&&this._handleTouchMoveDolly(t),this.enableRotate&&this._handleTouchMoveRotate(t)}_addPointer(t){this._pointers.push(t.pointerId)}_removePointer(t){delete this._pointerPositions[t.pointerId];for(let n=0;n<this._pointers.length;n++)if(this._pointers[n]==t.pointerId){this._pointers.splice(n,1);return}}_isTrackingPointer(t){for(let n=0;n<this._pointers.length;n++)if(this._pointers[n]==t.pointerId)return!0;return!1}_trackPointer(t){let n=this._pointerPositions[t.pointerId];n===void 0&&(n=new $t,this._pointerPositions[t.pointerId]=n),n.set(t.pageX,t.pageY)}_getSecondPointerPosition(t){const n=t.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[n]}_customWheelEvent(t){const n=t.deltaMode,s={clientX:t.clientX,clientY:t.clientY,deltaY:t.deltaY};switch(n){case 1:s.deltaY*=16;break;case 2:s.deltaY*=100;break}return t.ctrlKey&&!this._controlActive&&(s.deltaY*=10),s}}function Dp(e){this.enabled!==!1&&(this._pointers.length===0&&(this.domElement.setPointerCapture(e.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),!this._isTrackingPointer(e)&&(this._addPointer(e),e.pointerType==="touch"?this._onTouchStart(e):this._onMouseDown(e)))}function zp(e){this.enabled!==!1&&(e.pointerType==="touch"?this._onTouchMove(e):this._onMouseMove(e))}function Ip(e){switch(this._removePointer(e),this._pointers.length){case 0:this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent(Lu),this.state=Ne.NONE;break;case 1:const t=this._pointers[0],n=this._pointerPositions[t];this._onTouchStart({pointerId:t,pageX:n.x,pageY:n.y});break}}function Lp(e){let t;switch(e.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=-1}switch(t){case ns.DOLLY:if(this.enableZoom===!1)return;this._handleMouseDownDolly(e),this.state=Ne.DOLLY;break;case ns.ROTATE:if(e.ctrlKey||e.metaKey||e.shiftKey){if(this.enablePan===!1)return;this._handleMouseDownPan(e),this.state=Ne.PAN}else{if(this.enableRotate===!1)return;this._handleMouseDownRotate(e),this.state=Ne.ROTATE}break;case ns.PAN:if(e.ctrlKey||e.metaKey||e.shiftKey){if(this.enableRotate===!1)return;this._handleMouseDownRotate(e),this.state=Ne.ROTATE}else{if(this.enablePan===!1)return;this._handleMouseDownPan(e),this.state=Ne.PAN}break;default:this.state=Ne.NONE}this.state!==Ne.NONE&&this.dispatchEvent(Ul)}function Op(e){switch(this.state){case Ne.ROTATE:if(this.enableRotate===!1)return;this._handleMouseMoveRotate(e);break;case Ne.DOLLY:if(this.enableZoom===!1)return;this._handleMouseMoveDolly(e);break;case Ne.PAN:if(this.enablePan===!1)return;this._handleMouseMovePan(e);break}}function Fp(e){this.enabled===!1||this.enableZoom===!1||this.state!==Ne.NONE||(e.preventDefault(),this.dispatchEvent(Ul),this._handleMouseWheel(this._customWheelEvent(e)),this.dispatchEvent(Lu))}function Np(e){this.enabled===!1||this.enablePan===!1||this._handleKeyDown(e)}function $p(e){switch(this._trackPointer(e),this._pointers.length){case 1:switch(this.touches.ONE){case Gs.ROTATE:if(this.enableRotate===!1)return;this._handleTouchStartRotate(e),this.state=Ne.TOUCH_ROTATE;break;case Gs.PAN:if(this.enablePan===!1)return;this._handleTouchStartPan(e),this.state=Ne.TOUCH_PAN;break;default:this.state=Ne.NONE}break;case 2:switch(this.touches.TWO){case Gs.DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchStartDollyPan(e),this.state=Ne.TOUCH_DOLLY_PAN;break;case Gs.DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchStartDollyRotate(e),this.state=Ne.TOUCH_DOLLY_ROTATE;break;default:this.state=Ne.NONE}break;default:this.state=Ne.NONE}this.state!==Ne.NONE&&this.dispatchEvent(Ul)}function Hp(e){switch(this._trackPointer(e),this.state){case Ne.TOUCH_ROTATE:if(this.enableRotate===!1)return;this._handleTouchMoveRotate(e),this.update();break;case Ne.TOUCH_PAN:if(this.enablePan===!1)return;this._handleTouchMovePan(e),this.update();break;case Ne.TOUCH_DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchMoveDollyPan(e),this.update();break;case Ne.TOUCH_DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchMoveDollyRotate(e),this.update();break;default:this.state=Ne.NONE}}function jp(e){this.enabled!==!1&&e.preventDefault()}function Bp(e){e.key==="Control"&&(this._controlActive=!0,this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}function Up(e){e.key==="Control"&&(this._controlActive=!1,this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}class Zl extends Oh{constructor(t){super(t)}load(t,n,s,i){const a=this,o=new Fh(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(t,function(r){try{n(a.parse(r))}catch(c){i?i(c):console.error(c),a.manager.itemError(t)}},s,i)}parse(t){function n(l){const d=new DataView(l),f=32/8*3+32/8*3*3+16/8,h=d.getUint32(80,!0);if(80+32/8+h*f===d.byteLength)return!0;const g=[115,111,108,105,100];for(let x=0;x<5;x++)if(s(g,d,x))return!1;return!0}function s(l,d,f){for(let h=0,p=l.length;h<p;h++)if(l[h]!==d.getUint8(f+h))return!1;return!0}function i(l){const d=new DataView(l),f=d.getUint32(80,!0);let h,p,g,x=!1,b,E,I,R,y;for(let T=0;T<70;T++)d.getUint32(T,!1)==1129270351&&d.getUint8(T+4)==82&&d.getUint8(T+5)==61&&(x=!0,b=new Float32Array(f*3*3),E=d.getUint8(T+6)/255,I=d.getUint8(T+7)/255,R=d.getUint8(T+8)/255,y=d.getUint8(T+9)/255);const C=84,$=50,S=new en,P=new Float32Array(f*3*3),M=new Float32Array(f*3*3),A=new ni;for(let T=0;T<f;T++){const j=C+T*$,ne=d.getFloat32(j,!0),se=d.getFloat32(j+4,!0),Q=d.getFloat32(j+8,!0);if(x){const U=d.getUint16(j+48,!0);(U&32768)===0?(h=(U&31)/31,p=(U>>5&31)/31,g=(U>>10&31)/31):(h=E,p=I,g=R)}for(let U=1;U<=3;U++){const N=j+U*12,oe=T*3*3+(U-1)*3;P[oe]=d.getFloat32(N,!0),P[oe+1]=d.getFloat32(N+4,!0),P[oe+2]=d.getFloat32(N+8,!0),M[oe]=ne,M[oe+1]=se,M[oe+2]=Q,x&&(A.setRGB(h,p,g,Fd),b[oe]=A.r,b[oe+1]=A.g,b[oe+2]=A.b)}}return S.setAttribute("position",new Lt(P,3)),S.setAttribute("normal",new Lt(M,3)),x&&(S.setAttribute("color",new Lt(b,3)),S.hasColors=!0,S.alpha=y),S}function a(l){const d=new en,f=/solid([\s\S]*?)endsolid/g,h=/facet([\s\S]*?)endfacet/g,p=/solid\s(.+)/;let g=0;const x=/[\s]+([+-]?(?:\d*)(?:\.\d*)?(?:[eE][+-]?\d+)?)/.source,b=new RegExp("vertex"+x+x+x,"g"),E=new RegExp("normal"+x+x+x,"g"),I=[],R=[],y=[],C=new Y;let $,S=0,P=0,M=0;for(;($=f.exec(l))!==null;){P=M;const A=$[0],T=($=p.exec(A))!==null?$[1]:"";for(y.push(T);($=h.exec(A))!==null;){let se=0,Q=0;const U=$[0];for(;($=E.exec(U))!==null;)C.x=parseFloat($[1]),C.y=parseFloat($[2]),C.z=parseFloat($[3]),Q++;for(;($=b.exec(U))!==null;)I.push(parseFloat($[1]),parseFloat($[2]),parseFloat($[3])),R.push(C.x,C.y,C.z),se++,M++;Q!==1&&console.error("THREE.STLLoader: Something isn't right with the normal of face number "+g),se!==3&&console.error("THREE.STLLoader: Something isn't right with the vertices of face number "+g),g++}const j=P,ne=M-P;d.userData.groupNames=y,d.addGroup(j,ne,S),S++}return d.setAttribute("position",new Ds(I,3)),d.setAttribute("normal",new Ds(R,3)),d}function o(l){return typeof l!="string"?new TextDecoder().decode(l):l}function r(l){if(typeof l=="string"){const d=new Uint8Array(l.length);for(let f=0;f<l.length;f++)d[f]=l.charCodeAt(f)&255;return d.buffer||d}else return l}const c=r(t);return n(c)?i(c):a(o(t))}}function Yl(e){e.applyMatrix4(new fi().makeRotationX(-Math.PI/2))}class Zp{constructor(t){O(this,"scene");O(this,"camera");O(this,"renderer");O(this,"controls");O(this,"raycaster");O(this,"mouse");O(this,"gridHelper");O(this,"axesHelper");O(this,"ambientLight");O(this,"dirLight");O(this,"container");O(this,"animationId",0);O(this,"stlLoader");O(this,"frameCount",0);O(this,"lastTime",performance.now());O(this,"fps",0);O(this,"onBeforeRender",null);O(this,"handleResize",()=>{const t=this.container.clientWidth,n=this.container.clientHeight;this.camera.aspect=t/n,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,n)});this.container=t;const n=t.clientWidth,s=t.clientHeight;this.scene=new Nh,this.scene.background=new ni(15263976),this.camera=new $h(60,n/s,.1,2e3),this.camera.position.set(150,150,150),this.camera.lookAt(0,0,0),this.renderer=new Hh({antialias:!0}),this.renderer.setSize(n,s),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!0,this.renderer.outputColorSpace=Fd,t.appendChild(this.renderer.domElement),this.controls=new Rp(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.mouseButtons={MIDDLE:ns.PAN,RIGHT:ns.ROTATE},this.raycaster=new si,this.mouse=new $t,this.ambientLight=new jh(16777215,.6),this.scene.add(this.ambientLight),this.dirLight=new oc(16777215,.7),this.dirLight.position.set(100,200,100),this.dirLight.castShadow=!0,this.scene.add(this.dirLight);const i=new oc(16777215,.3);i.position.set(-100,50,-100),this.scene.add(i),this.gridHelper=new rc(300,30,12303291,13421772),this.scene.add(this.gridHelper),this.axesHelper=new Bh(50),this.scene.add(this.axesHelper),this.stlLoader=new Zl,window.addEventListener("resize",this.handleResize)}start(){const t=()=>{var s;this.animationId=requestAnimationFrame(t),this.controls.update(),this.frameCount++;const n=performance.now();n-this.lastTime>=1e3&&(this.fps=this.frameCount,this.frameCount=0,this.lastTime=n),(s=this.onBeforeRender)==null||s.call(this),this.renderer.render(this.scene,this.camera)};t()}stop(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=0)}async loadSTL(t,n,s=13421772){return new Promise((i,a)=>{this.stlLoader.load(t,o=>{o.computeVertexNormals(),Yl(o);const r=new Pl({color:s,roughness:.6,metalness:.1,transparent:!1,opacity:1,depthWrite:!0,side:wn}),c=new W(o,r);c.name=n,c.castShadow=!0,c.receiveShadow=!0,this.scene.add(c),i(c)},void 0,a)})}adjustGrid(t){if(t.length===0)return;const n=new mn;t.forEach(o=>n.expandByObject(o));const s=n.getSize(new Y),i=Math.max(s.x,s.y,s.z),a=Math.ceil(i*2/10)*10;this.scene.remove(this.gridHelper),this.gridHelper=new rc(a,a/10,12303291,13421772),this.scene.add(this.gridHelper)}focusOnMesh(t){const n=new mn().setFromObject(t),s=n.getCenter(new Y),i=n.getSize(new Y),a=Math.max(i.x,i.y,i.z);this.controls.target.copy(s),this.camera.position.set(s.x+a*.8,s.y+a*.6,s.z+a*1.8),this.camera.up.set(0,1,0),this.controls.update()}focusOnAllMeshes(t){if(t.length===0)return;const n=new mn;t.forEach(o=>n.expandByObject(o));const s=n.getCenter(new Y),i=n.getSize(new Y),a=Math.max(i.x,i.y,i.z);this.controls.target.copy(s),this.camera.position.set(s.x+a*.8,s.y+a*.6,s.z+a*1.8),this.camera.up.set(0,1,0),this.controls.update()}dispose(){for(this.stop(),window.removeEventListener("resize",this.handleResize),this.controls.dispose(),this.scene.traverse(t=>{var n,s,i;(t instanceof W||t instanceof Al)&&((n=t.geometry)==null||n.dispose(),Array.isArray(t.material)?t.material.forEach(a=>{this._disposeMaterial(a)}):t.material&&this._disposeMaterial(t.material)),t instanceof En&&((s=t.geometry)==null||s.dispose(),t.material instanceof lc&&this._disposeMaterial(t.material)),t instanceof sr&&((i=t.geometry)==null||i.dispose(),t.material instanceof lc&&this._disposeMaterial(t.material))});this.scene.children.length>0;)this.scene.remove(this.scene.children[0]);this.renderer.dispose(),this.renderer.forceContextLoss(),this.renderer.domElement.parentElement&&this.renderer.domElement.parentElement.removeChild(this.renderer.domElement),this.onBeforeRender=null}_disposeMaterial(t){const n=t,s=["map","normalMap","roughnessMap","metalnessMap","aoMap","emissiveMap","bumpMap","displacementMap","envMap"];for(const i of s){const a=n[i];a&&a.dispose()}t.dispose()}}const ps=new si,Dt=new Y,Kn=new Y,qe=new Ut,Cc={X:new Y(1,0,0),Y:new Y(0,1,0),Z:new Y(0,0,1)},Rr={type:"change"},Pc={type:"mouseDown",mode:null},Ac={type:"mouseUp",mode:null},Tc={type:"objectChange"};class Yp extends Od{constructor(t,n=null){super(void 0,n);const s=new qp(this);this._root=s;const i=new Qp;this._gizmo=i,s.add(i);const a=new Jp;this._plane=a,s.add(a);const o=this;function r(R,y){let C=y;Object.defineProperty(o,R,{get:function(){return C!==void 0?C:y},set:function($){C!==$&&(C=$,a[R]=$,i[R]=$,o.dispatchEvent({type:R+"-changed",value:$}),o.dispatchEvent(Rr))}}),o[R]=y,a[R]=y,i[R]=y}r("camera",t),r("object",void 0),r("enabled",!0),r("axis",null),r("mode","translate"),r("translationSnap",null),r("rotationSnap",null),r("scaleSnap",null),r("space","world"),r("size",1),r("dragging",!1),r("showX",!0),r("showY",!0),r("showZ",!0),r("minX",-1/0),r("maxX",1/0),r("minY",-1/0),r("maxY",1/0),r("minZ",-1/0),r("maxZ",1/0);const c=new Y,l=new Y,d=new Ut,f=new Ut,h=new Y,p=new Ut,g=new Y,x=new Y,b=new Y,E=0,I=new Y;r("worldPosition",c),r("worldPositionStart",l),r("worldQuaternion",d),r("worldQuaternionStart",f),r("cameraPosition",h),r("cameraQuaternion",p),r("pointStart",g),r("pointEnd",x),r("rotationAxis",b),r("rotationAngle",E),r("eye",I),this._offset=new Y,this._startNorm=new Y,this._endNorm=new Y,this._cameraScale=new Y,this._parentPosition=new Y,this._parentQuaternion=new Ut,this._parentQuaternionInv=new Ut,this._parentScale=new Y,this._worldScaleStart=new Y,this._worldQuaternionInv=new Ut,this._worldScale=new Y,this._positionStart=new Y,this._quaternionStart=new Ut,this._scaleStart=new Y,this._getPointer=Gp.bind(this),this._onPointerDown=Xp.bind(this),this._onPointerHover=Vp.bind(this),this._onPointerMove=Wp.bind(this),this._onPointerUp=Kp.bind(this),n!==null&&this.connect()}connect(){this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="auto"}getHelper(){return this._root}pointerHover(t){if(this.object===void 0||this.dragging===!0)return;t!==null&&ps.setFromCamera(t,this.camera);const n=Dr(this._gizmo.picker[this.mode],ps);n?this.axis=n.object.name:this.axis=null}pointerDown(t){if(!(this.object===void 0||this.dragging===!0||t!=null&&t.button!==0)&&this.axis!==null){t!==null&&ps.setFromCamera(t,this.camera);const n=Dr(this._plane,ps,!0);n&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(n.point).sub(this.worldPositionStart)),this.dragging=!0,Pc.mode=this.mode,this.dispatchEvent(Pc)}}pointerMove(t){const n=this.axis,s=this.mode,i=this.object;let a=this.space;if(s==="scale"?a="local":(n==="E"||n==="XYZE"||n==="XYZ")&&(a="world"),i===void 0||n===null||this.dragging===!1||t!==null&&t.button!==-1)return;t!==null&&ps.setFromCamera(t,this.camera);const o=Dr(this._plane,ps,!0);if(o){if(this.pointEnd.copy(o.point).sub(this.worldPositionStart),s==="translate")this._offset.copy(this.pointEnd).sub(this.pointStart),a==="local"&&n!=="XYZ"&&this._offset.applyQuaternion(this._worldQuaternionInv),n.indexOf("X")===-1&&(this._offset.x=0),n.indexOf("Y")===-1&&(this._offset.y=0),n.indexOf("Z")===-1&&(this._offset.z=0),a==="local"&&n!=="XYZ"?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),i.position.copy(this._offset).add(this._positionStart),this.translationSnap&&(a==="local"&&(i.position.applyQuaternion(qe.copy(this._quaternionStart).invert()),n.search("X")!==-1&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),n.search("Y")!==-1&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),n.search("Z")!==-1&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.position.applyQuaternion(this._quaternionStart)),a==="world"&&(i.parent&&i.position.add(Dt.setFromMatrixPosition(i.parent.matrixWorld)),n.search("X")!==-1&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),n.search("Y")!==-1&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),n.search("Z")!==-1&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.parent&&i.position.sub(Dt.setFromMatrixPosition(i.parent.matrixWorld)))),i.position.x=Math.max(this.minX,Math.min(this.maxX,i.position.x)),i.position.y=Math.max(this.minY,Math.min(this.maxY,i.position.y)),i.position.z=Math.max(this.minZ,Math.min(this.maxZ,i.position.z));else if(s==="scale"){if(n.search("XYZ")!==-1){let r=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(r*=-1),Kn.set(r,r,r)}else Dt.copy(this.pointStart),Kn.copy(this.pointEnd),Dt.applyQuaternion(this._worldQuaternionInv),Kn.applyQuaternion(this._worldQuaternionInv),Kn.divide(Dt),n.search("X")===-1&&(Kn.x=1),n.search("Y")===-1&&(Kn.y=1),n.search("Z")===-1&&(Kn.z=1);i.scale.copy(this._scaleStart).multiply(Kn),this.scaleSnap&&(n.search("X")!==-1&&(i.scale.x=Math.round(i.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),n.search("Y")!==-1&&(i.scale.y=Math.round(i.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),n.search("Z")!==-1&&(i.scale.z=Math.round(i.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(s==="rotate"){this._offset.copy(this.pointEnd).sub(this.pointStart);const r=20/this.worldPosition.distanceTo(Dt.setFromMatrixPosition(this.camera.matrixWorld));let c=!1;n==="XYZE"?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(Dt.copy(this.rotationAxis).cross(this.eye))*r):(n==="X"||n==="Y"||n==="Z")&&(this.rotationAxis.copy(Cc[n]),Dt.copy(Cc[n]),a==="local"&&Dt.applyQuaternion(this.worldQuaternion),Dt.cross(this.eye),Dt.length()===0?c=!0:this.rotationAngle=this._offset.dot(Dt.normalize())*r),(n==="E"||c)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),a==="local"&&n!=="E"&&n!=="XYZE"?(i.quaternion.copy(this._quaternionStart),i.quaternion.multiply(qe.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),i.quaternion.copy(qe.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),i.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(Rr),this.dispatchEvent(Tc)}}pointerUp(t){t!==null&&t.button!==0||(this.dragging&&this.axis!==null&&(Ac.mode=this.mode,this.dispatchEvent(Ac)),this.dragging=!1,this.axis=null)}dispose(){this.disconnect(),this._root.dispose()}attach(t){return this.object=t,this._root.visible=!0,this}detach(){return this.object=void 0,this.axis=null,this._root.visible=!1,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(Rr),this.dispatchEvent(Tc),this.pointStart.copy(this.pointEnd))}getRaycaster(){return ps}getMode(){return this.mode}setMode(t){this.mode=t}setTranslationSnap(t){this.translationSnap=t}setRotationSnap(t){this.rotationSnap=t}setScaleSnap(t){this.scaleSnap=t}setSize(t){this.size=t}setSpace(t){this.space=t}}function Gp(e){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:e.button};{const t=this.domElement.getBoundingClientRect();return{x:(e.clientX-t.left)/t.width*2-1,y:-(e.clientY-t.top)/t.height*2+1,button:e.button}}}function Vp(e){if(this.enabled)switch(e.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(e));break}}function Xp(e){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(e.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(e)),this.pointerDown(this._getPointer(e)))}function Wp(e){this.enabled&&this.pointerMove(this._getPointer(e))}function Kp(e){this.enabled&&(this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(e)))}function Dr(e,t,n){const s=t.intersectObject(e,!0);for(let i=0;i<s.length;i++)if(s[i].object.visible||n)return s[i];return!1}const jo=new Uh,$e=new Y(0,1,0),Rc=new Y(0,0,0),Dc=new fi,Bo=new Ut,tr=new Ut,Mn=new Y,zc=new fi,Mi=new Y(1,0,0),vs=new Y(0,1,0),Si=new Y(0,0,1),Uo=new Y,yi=new Y,wi=new Y;class qp extends Qr{constructor(t){super(),this.isTransformControlsRoot=!0,this.controls=t,this.visible=!1}updateMatrixWorld(t){const n=this.controls;n.object!==void 0&&(n.object.updateMatrixWorld(),n.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):n.object.parent.matrixWorld.decompose(n._parentPosition,n._parentQuaternion,n._parentScale),n.object.matrixWorld.decompose(n.worldPosition,n.worldQuaternion,n._worldScale),n._parentQuaternionInv.copy(n._parentQuaternion).invert(),n._worldQuaternionInv.copy(n.worldQuaternion).invert()),n.camera.updateMatrixWorld(),n.camera.matrixWorld.decompose(n.cameraPosition,n.cameraQuaternion,n._cameraScale),n.camera.isOrthographicCamera?n.camera.getWorldDirection(n.eye).negate():n.eye.copy(n.cameraPosition).sub(n.worldPosition).normalize(),super.updateMatrixWorld(t)}dispose(){this.traverse(function(t){t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})}}class Qp extends Qr{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const t=new ii({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),n=new Nd({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),s=t.clone();s.opacity=.15;const i=n.clone();i.opacity=.5;const a=t.clone();a.color.setHex(16711680);const o=t.clone();o.color.setHex(65280);const r=t.clone();r.color.setHex(255);const c=t.clone();c.color.setHex(16711680),c.opacity=.5;const l=t.clone();l.color.setHex(65280),l.opacity=.5;const d=t.clone();d.color.setHex(255),d.opacity=.5;const f=t.clone();f.opacity=.25;const h=t.clone();h.color.setHex(16776960),h.opacity=.25,t.clone().color.setHex(16776960);const g=t.clone();g.color.setHex(7895160);const x=new Ft(0,.04,.1,12);x.translate(0,.05,0);const b=new St(.08,.08,.08);b.translate(0,.04,0);const E=new en;E.setAttribute("position",new Ds([0,0,0,1,0,0],3));const I=new Ft(.0075,.0075,.5,3);I.translate(0,.25,0);function R(Q,U){const N=new gi(Q,.0075,3,64,U*Math.PI*2);return N.rotateY(Math.PI/2),N.rotateX(Math.PI/2),N}function y(){const Q=new en;return Q.setAttribute("position",new Ds([0,0,0,1,1,1],3)),Q}const C={X:[[new W(x,a),[.5,0,0],[0,0,-Math.PI/2]],[new W(x,a),[-.5,0,0],[0,0,Math.PI/2]],[new W(I,a),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new W(x,o),[0,.5,0]],[new W(x,o),[0,-.5,0],[Math.PI,0,0]],[new W(I,o)]],Z:[[new W(x,r),[0,0,.5],[Math.PI/2,0,0]],[new W(x,r),[0,0,-.5],[-Math.PI/2,0,0]],[new W(I,r),null,[Math.PI/2,0,0]]],XYZ:[[new W(new Fo(.1,0),f.clone()),[0,0,0]]],XY:[[new W(new St(.15,.15,.01),d.clone()),[.15,.15,0]]],YZ:[[new W(new St(.15,.15,.01),c.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new W(new St(.15,.15,.01),l.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},$={X:[[new W(new Ft(.2,0,.6,4),s),[.3,0,0],[0,0,-Math.PI/2]],[new W(new Ft(.2,0,.6,4),s),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new W(new Ft(.2,0,.6,4),s),[0,.3,0]],[new W(new Ft(.2,0,.6,4),s),[0,-.3,0],[0,0,Math.PI]]],Z:[[new W(new Ft(.2,0,.6,4),s),[0,0,.3],[Math.PI/2,0,0]],[new W(new Ft(.2,0,.6,4),s),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new W(new Fo(.2,0),s)]],XY:[[new W(new St(.2,.2,.01),s),[.15,.15,0]]],YZ:[[new W(new St(.2,.2,.01),s),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new W(new St(.2,.2,.01),s),[.15,0,.15],[-Math.PI/2,0,0]]]},S={START:[[new W(new Fo(.01,2),i),null,null,null,"helper"]],END:[[new W(new Fo(.01,2),i),null,null,null,"helper"]],DELTA:[[new En(y(),i),null,null,null,"helper"]],X:[[new En(E,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new En(E,i.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new En(E,i.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},P={XYZE:[[new W(R(.5,1),g),null,[0,Math.PI/2,0]]],X:[[new W(R(.5,.5),a)]],Y:[[new W(R(.5,.5),o),null,[0,0,-Math.PI/2]]],Z:[[new W(R(.5,.5),r),null,[0,Math.PI/2,0]]],E:[[new W(R(.75,1),h),null,[0,Math.PI/2,0]]]},M={AXIS:[[new En(E,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},A={XYZE:[[new W(new Tl(.25,10,8),s)]],X:[[new W(new gi(.5,.1,4,24),s),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new W(new gi(.5,.1,4,24),s),[0,0,0],[Math.PI/2,0,0]]],Z:[[new W(new gi(.5,.1,4,24),s),[0,0,0],[0,0,-Math.PI/2]]],E:[[new W(new gi(.75,.1,2,24),s)]]},T={X:[[new W(b,a),[.5,0,0],[0,0,-Math.PI/2]],[new W(I,a),[0,0,0],[0,0,-Math.PI/2]],[new W(b,a),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new W(b,o),[0,.5,0]],[new W(I,o)],[new W(b,o),[0,-.5,0],[0,0,Math.PI]]],Z:[[new W(b,r),[0,0,.5],[Math.PI/2,0,0]],[new W(I,r),[0,0,0],[Math.PI/2,0,0]],[new W(b,r),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new W(new St(.15,.15,.01),d),[.15,.15,0]]],YZ:[[new W(new St(.15,.15,.01),c),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new W(new St(.15,.15,.01),l),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new W(new St(.1,.1,.1),f.clone())]]},j={X:[[new W(new Ft(.2,0,.6,4),s),[.3,0,0],[0,0,-Math.PI/2]],[new W(new Ft(.2,0,.6,4),s),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new W(new Ft(.2,0,.6,4),s),[0,.3,0]],[new W(new Ft(.2,0,.6,4),s),[0,-.3,0],[0,0,Math.PI]]],Z:[[new W(new Ft(.2,0,.6,4),s),[0,0,.3],[Math.PI/2,0,0]],[new W(new Ft(.2,0,.6,4),s),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new W(new St(.2,.2,.01),s),[.15,.15,0]]],YZ:[[new W(new St(.2,.2,.01),s),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new W(new St(.2,.2,.01),s),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new W(new St(.2,.2,.2),s),[0,0,0]]]},ne={X:[[new En(E,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new En(E,i.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new En(E,i.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function se(Q){const U=new Qr;for(const N in Q)for(let oe=Q[N].length;oe--;){const ae=Q[N][oe][0].clone(),ve=Q[N][oe][1],He=Q[N][oe][2],Ae=Q[N][oe][3],Ve=Q[N][oe][4];ae.name=N,ae.tag=Ve,ve&&ae.position.set(ve[0],ve[1],ve[2]),He&&ae.rotation.set(He[0],He[1],He[2]),Ae&&ae.scale.set(Ae[0],Ae[1],Ae[2]),ae.updateMatrix();const je=ae.geometry.clone();je.applyMatrix4(ae.matrix),ae.geometry=je,ae.renderOrder=1/0,ae.position.set(0,0,0),ae.rotation.set(0,0,0),ae.scale.set(1,1,1),U.add(ae)}return U}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=se(C)),this.add(this.gizmo.rotate=se(P)),this.add(this.gizmo.scale=se(T)),this.add(this.picker.translate=se($)),this.add(this.picker.rotate=se(A)),this.add(this.picker.scale=se(j)),this.add(this.helper.translate=se(S)),this.add(this.helper.rotate=se(M)),this.add(this.helper.scale=se(ne)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(t){const s=(this.mode==="scale"?"local":this.space)==="local"?this.worldQuaternion:tr;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let i=[];i=i.concat(this.picker[this.mode].children),i=i.concat(this.gizmo[this.mode].children),i=i.concat(this.helper[this.mode].children);for(let a=0;a<i.length;a++){const o=i[a];o.visible=!0,o.rotation.set(0,0,0),o.position.copy(this.worldPosition);let r;if(this.camera.isOrthographicCamera?r=(this.camera.top-this.camera.bottom)/this.camera.zoom:r=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),o.scale.set(1,1,1).multiplyScalar(r*this.size/4),o.tag==="helper"){o.visible=!1,o.name==="AXIS"?(o.visible=!!this.axis,this.axis==="X"&&(qe.setFromEuler(jo.set(0,0,0)),o.quaternion.copy(s).multiply(qe),Math.abs($e.copy(Mi).applyQuaternion(s).dot(this.eye))>.9&&(o.visible=!1)),this.axis==="Y"&&(qe.setFromEuler(jo.set(0,0,Math.PI/2)),o.quaternion.copy(s).multiply(qe),Math.abs($e.copy(vs).applyQuaternion(s).dot(this.eye))>.9&&(o.visible=!1)),this.axis==="Z"&&(qe.setFromEuler(jo.set(0,Math.PI/2,0)),o.quaternion.copy(s).multiply(qe),Math.abs($e.copy(Si).applyQuaternion(s).dot(this.eye))>.9&&(o.visible=!1)),this.axis==="XYZE"&&(qe.setFromEuler(jo.set(0,Math.PI/2,0)),$e.copy(this.rotationAxis),o.quaternion.setFromRotationMatrix(Dc.lookAt(Rc,$e,vs)),o.quaternion.multiply(qe),o.visible=this.dragging),this.axis==="E"&&(o.visible=!1)):o.name==="START"?(o.position.copy(this.worldPositionStart),o.visible=this.dragging):o.name==="END"?(o.position.copy(this.worldPosition),o.visible=this.dragging):o.name==="DELTA"?(o.position.copy(this.worldPositionStart),o.quaternion.copy(this.worldQuaternionStart),Dt.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),Dt.applyQuaternion(this.worldQuaternionStart.clone().invert()),o.scale.copy(Dt),o.visible=this.dragging):(o.quaternion.copy(s),this.dragging?o.position.copy(this.worldPositionStart):o.position.copy(this.worldPosition),this.axis&&(o.visible=this.axis.search(o.name)!==-1));continue}o.quaternion.copy(s),this.mode==="translate"||this.mode==="scale"?(o.name==="X"&&Math.abs($e.copy(Mi).applyQuaternion(s).dot(this.eye))>.99&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),o.name==="Y"&&Math.abs($e.copy(vs).applyQuaternion(s).dot(this.eye))>.99&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),o.name==="Z"&&Math.abs($e.copy(Si).applyQuaternion(s).dot(this.eye))>.99&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),o.name==="XY"&&Math.abs($e.copy(Si).applyQuaternion(s).dot(this.eye))<.2&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),o.name==="YZ"&&Math.abs($e.copy(Mi).applyQuaternion(s).dot(this.eye))<.2&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),o.name==="XZ"&&Math.abs($e.copy(vs).applyQuaternion(s).dot(this.eye))<.2&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1)):this.mode==="rotate"&&(Bo.copy(s),$e.copy(this.eye).applyQuaternion(qe.copy(s).invert()),o.name.search("E")!==-1&&o.quaternion.setFromRotationMatrix(Dc.lookAt(this.eye,Rc,vs)),o.name==="X"&&(qe.setFromAxisAngle(Mi,Math.atan2(-$e.y,$e.z)),qe.multiplyQuaternions(Bo,qe),o.quaternion.copy(qe)),o.name==="Y"&&(qe.setFromAxisAngle(vs,Math.atan2($e.x,$e.z)),qe.multiplyQuaternions(Bo,qe),o.quaternion.copy(qe)),o.name==="Z"&&(qe.setFromAxisAngle(Si,Math.atan2($e.y,$e.x)),qe.multiplyQuaternions(Bo,qe),o.quaternion.copy(qe))),o.visible=o.visible&&(o.name.indexOf("X")===-1||this.showX),o.visible=o.visible&&(o.name.indexOf("Y")===-1||this.showY),o.visible=o.visible&&(o.name.indexOf("Z")===-1||this.showZ),o.visible=o.visible&&(o.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),o.material._color=o.material._color||o.material.color.clone(),o.material._opacity=o.material._opacity||o.material.opacity,o.material.color.copy(o.material._color),o.material.opacity=o.material._opacity,this.enabled&&this.axis&&(o.name===this.axis||this.axis.split("").some(function(c){return o.name===c}))&&(o.material.color.setHex(16776960),o.material.opacity=1)}super.updateMatrixWorld(t)}}class Jp extends W{constructor(){super(new Zh(1e5,1e5,2,2),new ii({visible:!1,wireframe:!0,side:wn,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(t){let n=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(n="local"),Uo.copy(Mi).applyQuaternion(n==="local"?this.worldQuaternion:tr),yi.copy(vs).applyQuaternion(n==="local"?this.worldQuaternion:tr),wi.copy(Si).applyQuaternion(n==="local"?this.worldQuaternion:tr),$e.copy(yi),this.mode){case"translate":case"scale":switch(this.axis){case"X":$e.copy(this.eye).cross(Uo),Mn.copy(Uo).cross($e);break;case"Y":$e.copy(this.eye).cross(yi),Mn.copy(yi).cross($e);break;case"Z":$e.copy(this.eye).cross(wi),Mn.copy(wi).cross($e);break;case"XY":Mn.copy(wi);break;case"YZ":Mn.copy(Uo);break;case"XZ":$e.copy(wi),Mn.copy(yi);break;case"XYZ":case"E":Mn.set(0,0,0);break}break;case"rotate":default:Mn.set(0,0,0)}Mn.length()===0?this.quaternion.copy(this.cameraQuaternion):(zc.lookAt(Dt.set(0,0,0),Mn,$e),this.quaternion.setFromRotationMatrix(zc)),super.updateMatrixWorld(t)}}const Ic={titanium:8952234,peek:13417352,cobalt_chrome:10070732,stainless_steel:11184810},e0=16763904,t0=1.5,n0=16729156;var ra,la;class s0{constructor(t,n,s,i){O(this,"scene");O(this,"camera");O(this,"renderer");O(this,"orbitControls");O(this,"implants",{});L(this,ra,z(0));L(this,la,z(null));O(this,"boneMeshes",[]);O(this,"transformControls",null);O(this,"_transformMode","translate");O(this,"_objectChangeCleanup",null);O(this,"_entryMarker",null);O(this,"_previewLine",null);O(this,"_previewLineGeo",null);O(this,"stlLoader");this.scene=t,this.camera=n,this.renderer=s,this.orbitControls=i??null,this.stlLoader=new Zl,this._initTransformControls()}get implantCount(){return u(v(this,ra))}set implantCount(t){k(v(this,ra),t,!0)}get selectedImplant(){return u(v(this,la))}set selectedImplant(t){k(v(this,la),t,!0)}_initTransformControls(){var n,s;this.transformControls=new Yp(this.camera,this.renderer.domElement),this.transformControls.setSize(.8);const t=(s=(n=this.transformControls).getHelper)==null?void 0:s.call(n);t&&this.scene.add(t),this.transformControls.addEventListener("dragging-changed",i=>{this.orbitControls&&(this.orbitControls.enabled=!i.value)})}async loadImplantFromURL(t,n,s="titanium",i="screw",a){var p;const o=await fetch(t);if(!o.ok)throw new Error(`STL fetch ì¤í¨: ${t} (${o.status})`);const r=await o.arrayBuffer();n||(n=((p=t.split("/").pop())==null?void 0:p.replace(/\.[^/.]+$/,""))??"implant");let c=n;if(this.implants[c]){let g=2;for(;this.implants[`${c}_${g}`];)g++;c=`${c}_${g}`}const l=this.stlLoader.parse(r);l.computeVertexNormals(),l.computeBoundingBox();const d=Ic[s]??8952234,f=new ss({color:d,flatShading:!1,side:wn,shininess:60,transparent:!0,opacity:.85}),h=new W(l,f);return h.name="implant_"+c,h.userData.isImplant=!0,h.userData.implantName=c,h.userData.materialType=s,h.userData.implantCategory=i,h.userData.stlUrl=t,h.castShadow=!0,h.visible=!1,this.scene.add(h),this.implants[c]={mesh:h,stlPath:t,material:s,category:i,originalColor:d,heightMm:a},this.implantCount++,c}async loadImplantFromFile(t,n="titanium",s="screw"){const i=await t.arrayBuffer();let o=t.name.replace(/\.[^/.]+$/,"");if(this.implants[o]){let h=2;for(;this.implants[`${o}_${h}`];)h++;o=`${o}_${h}`}const r=this.stlLoader.parse(i);r.computeVertexNormals(),r.computeBoundingBox();const c=Ic[n]??8952234,l=new ss({color:c,flatShading:!1,side:wn,shininess:60,transparent:!0,opacity:.85}),d=new W(r,l);d.name="implant_"+o,d.userData.isImplant=!0,d.userData.implantName=o,d.userData.materialType=n,d.userData.implantCategory=s,d.userData.stlUrl=t.name,d.castShadow=!0;const f=new mn;return this.scene.traverse(h=>{h.isMesh&&!h.userData.isImplant&&f.expandByObject(h)}),f.isEmpty()||d.position.copy(f.getCenter(new Y)),this.scene.add(d),this.implants[o]={mesh:d,stlPath:t.name,material:n,category:s,originalColor:c},this.implantCount++,o}placeImplantAtSurface(t,n,s){const i=this.implants[t];if(!i)return;const a=i.mesh;a.position.copy(n);const o=new Y(0,1,0),r=s.clone().normalize();if(Math.abs(r.dot(o))<.999){const c=new Ut().setFromUnitVectors(o,r);a.quaternion.copy(c)}a.visible=!0,this.selectImplant(t)}showEntryMarker(t){this.hideEntryMarker();const n=new Tl(t0,16,16),s=new ss({color:e0,shininess:80,transparent:!0,opacity:.9});this._entryMarker=new W(n,s),this._entryMarker.position.copy(t),this._entryMarker.name="__entryMarker__",this.scene.add(this._entryMarker);const i=new Float32Array(6);i[0]=t.x,i[1]=t.y,i[2]=t.z,i[3]=t.x,i[4]=t.y,i[5]=t.z,this._previewLineGeo=new en,this._previewLineGeo.setAttribute("position",new Lt(i,3));const a=new Nd({color:n0,linewidth:2,transparent:!0,opacity:.7});this._previewLine=new En(this._previewLineGeo,a),this._previewLine.name="__previewLine__",this._previewLine.frustumCulled=!1,this.scene.add(this._previewLine)}updatePreviewLine(t){if(!this._previewLineGeo||!this._entryMarker)return;const n=this._previewLineGeo.getAttribute("position");n.setXYZ(1,t.x,t.y,t.z),n.needsUpdate=!0}hideEntryMarker(){var t;this._entryMarker&&(this.scene.remove(this._entryMarker),this._entryMarker.geometry.dispose(),this._entryMarker.material.dispose(),this._entryMarker=null),this._previewLine&&(this.scene.remove(this._previewLine),(t=this._previewLineGeo)==null||t.dispose(),this._previewLine.material.dispose(),this._previewLine=null,this._previewLineGeo=null)}selectImplant(t){var s;if(!this.implants[t])return;this._objectChangeCleanup&&(this._objectChangeCleanup(),this._objectChangeCleanup=null),this.selectedImplant=t;const n=this.implants[t];if(this.transformControls&&(this.transformControls.attach(n.mesh),this.transformControls.setMode(this._transformMode)),n.category==="cage"){const i=()=>{const a=this.checkCageCollision(t);this.setCageCollisionVisual(t,a)};(s=this.transformControls)==null||s.addEventListener("objectChange",i),this._objectChangeCleanup=()=>{var a;(a=this.transformControls)==null||a.removeEventListener("objectChange",i)}}}deselectImplant(){var t;this._objectChangeCleanup&&(this._objectChangeCleanup(),this._objectChangeCleanup=null),this.selectedImplant=null,(t=this.transformControls)==null||t.detach()}setTransformMode(t){var n;this._transformMode=t,(n=this.transformControls)==null||n.setMode(t)}checkCageCollision(t){const n=this.implants[t];if(!n||n.category!=="cage"||this.boneMeshes.length===0)return!1;const s=new mn().setFromObject(n.mesh);for(const i of this.boneMeshes){if(!i.visible)continue;const a=new mn().setFromObject(i);if(s.intersectsBox(a))return!0}return!1}setCageCollisionVisual(t,n){const s=this.implants[t];if(!s)return;const i=s.mesh.material;n?(i.color.setHex(16720418),i.opacity=.65):(i.color.setHex(s.originalColor),i.opacity=.85)}applyDistraction(t){const n=this.implants[t];if(!n||n.category!=="cage"||this.boneMeshes.length===0)return null;const s=new mn().setFromObject(n.mesh),i=(s.max.y+s.min.y)/2,a=n.heightMm??s.max.y-s.min.y;let o=null,r=null,c=1/0,l=-1/0;for(const h of this.boneMeshes){if(!h.visible)continue;const p=new mn().setFromObject(h);(p.max.y+p.min.y)/2>i?p.min.y<c&&(c=p.min.y,o=h):p.max.y>l&&(l=p.max.y,r=h)}if(!o)return null;const d=r?Math.max(0,c-l):0,f=a-d;return f<=.5?null:(o.position.y+=f,n.mesh.position.y+=f*.5,this.selectedImplant===t&&this.transformControls&&this.transformControls.attach(n.mesh),{superiorMesh:o,deltaH:f,originalGap:d,cageHeight:a})}undoDistraction(t,n){const s=this.implants[t];s&&(n.superiorMesh.position.y-=n.deltaH,s.mesh.position.y-=n.deltaH*.5,this.selectedImplant===t&&this.transformControls&&this.transformControls.attach(s.mesh))}removeImplant(t){const n=this.implants[t];n&&(this.selectedImplant===t&&this.deselectImplant(),this.scene.remove(n.mesh),n.mesh.geometry.dispose(),n.mesh.material.dispose(),delete this.implants[t],this.implantCount--)}removeAll(){Object.keys(this.implants).forEach(n=>this.removeImplant(n))}getImplantNames(){return Object.keys(this.implants)}getImplantTransform(t){const n=this.implants[t];if(!n)return null;const s=n.mesh;return{position:[s.position.x,s.position.y,s.position.z],rotation:[s.rotation.x,s.rotation.y,s.rotation.z],scale:[s.scale.x,s.scale.y,s.scale.z]}}exportPlan(){const t=[];for(const[n,s]of Object.entries(this.implants)){const i=this.getImplantTransform(n);t.push({name:n,stl_path:s.stlPath,category:s.category,position:i.position,rotation:i.rotation,scale:i.scale,material:s.material})}return{implants:t,bone_modifications:{}}}importPlan(t){if(t!=null&&t.implants)for(const n of t.implants){const s=this.implants[n.name];if(!s)continue;const i=s.mesh;n.position&&i.position.set(...n.position),n.rotation&&i.rotation.set(...n.rotation),n.scale&&i.scale.set(...n.scale),n.material&&(s.material=n.material)}}setOrbitControls(t){this.orbitControls=t}dispose(){var t,n;if(this.hideEntryMarker(),this.removeAll(),this.transformControls){const s=(n=(t=this.transformControls).getHelper)==null?void 0:n.call(t);s&&this.scene.remove(s),this.transformControls.dispose(),this.transformControls=null}}}ra=new WeakMap,la=new WeakMap;var ca,da,ua,ha,fa,pa,va,_a,ma,ga,ba;class i0{constructor(){L(this,ca,z("none"));L(this,da,z(3));L(this,ua,z(5));L(this,ha,z(!0));L(this,fa,z(Qt([0,-100,0])));L(this,pa,z(null));L(this,va,z(null));L(this,_a,z("titanium"));L(this,ma,z("screw"));L(this,ga,z(void 0));L(this,ba,z(!1))}get mode(){return u(v(this,ca))}set mode(t){k(v(this,ca),t,!0)}get drillRadius(){return u(v(this,da))}set drillRadius(t){k(v(this,da),t,!0)}get brushRadius(){return u(v(this,ua))}set brushRadius(t){k(v(this,ua),t,!0)}get showDrillPreview(){return u(v(this,ha))}set showDrillPreview(t){k(v(this,ha),t,!0)}get forceVector(){return u(v(this,fa))}set forceVector(t){k(v(this,fa),t,!0)}get pendingImplantUrl(){return u(v(this,pa))}set pendingImplantUrl(t){k(v(this,pa),t,!0)}get pendingImplantName(){return u(v(this,va))}set pendingImplantName(t){k(v(this,va),t,!0)}get pendingImplantMat(){return u(v(this,_a))}set pendingImplantMat(t){k(v(this,_a),t,!0)}get pendingImplantCategory(){return u(v(this,ma))}set pendingImplantCategory(t){k(v(this,ma),t,!0)}get pendingImplantHeightMm(){return u(v(this,ga))}set pendingImplantHeightMm(t){k(v(this,ga),t,!0)}get forceEditMode3D(){return u(v(this,ba))}set forceEditMode3D(t){k(v(this,ba),t,!0)}setMode(t){this.mode=t}reset(){this.mode="none"}enterImplantPlaceMode(t,n,s,i,a){this.pendingImplantUrl=t,this.pendingImplantName=n,this.pendingImplantMat=s,this.pendingImplantCategory=i,this.pendingImplantHeightMm=a,this.mode="implantPlace"}exitImplantPlaceMode(){this.pendingImplantUrl=null,this.pendingImplantName=null,this.mode="none"}}ca=new WeakMap,da=new WeakMap,ua=new WeakMap,ha=new WeakMap,fa=new WeakMap,pa=new WeakMap,va=new WeakMap,_a=new WeakMap,ma=new WeakMap,ga=new WeakMap,ba=new WeakMap;const q=new i0,a0=16720418,o0=16737792,r0=5,Lc=40,Oc=8;class l0{constructor(t,n,s){O(this,"scene");O(this,"camera");O(this,"arrowHelper");O(this,"tailMesh");O(this,"group");O(this,"_visible",!1);this.scene=t,this.camera=n;const i=new Y(0,-1,0),a=Lc+100/Oc;this.arrowHelper=new Yh(i,new Y(0,0,0),a,a0,10,6);const o=new Tl(r0,16,16),r=new ss({color:o0,shininess:80,transparent:!0,opacity:.85});this.tailMesh=new W(o,r),this.tailMesh.name="__forceArrowTail__",this.tailMesh.userData.isForceHandle=!1,this.group=new $d,this.group.name="__forceArrow__",this.group.add(this.arrowHelper),this.group.add(this.tailMesh),this.group.visible=!1,t.add(this.group),this._syncFromForceVector()}setVisible(t){this._visible=t,this.group.visible=t,t&&this._syncFromForceVector()}get isVisible(){return this._visible}syncFromForceVector(){this._visible&&this._syncFromForceVector()}_syncFromForceVector(){const[t,n,s]=q.forceVector,i=new Y(t,n,s),a=i.length();if(a<.001)return;const o=i.clone().normalize(),r=Lc+a/Oc;this.arrowHelper.setDirection(o),this.arrowHelper.setLength(r,10,6)}setOrigin(t){this.group.position.copy(t)}getOrigin(){return this.group.position.clone()}setScale(t){this.group.scale.setScalar(t)}updateFromDrag(t,n,s,i){const a=new si;a.setFromCamera(t,this.camera);const o=new Cl().setFromNormalAndCoplanarPoint(n,s),r=new Y;if(!a.ray.intersectPlane(o,r))return;const c=this.group.position,l=r.clone().sub(c);l.length()<.001||(l.normalize(),q.forceVector=[l.x*i,l.y*i,l.z*i],this._syncFromForceVector())}dispose(){this.scene.remove(this.group),this.tailMesh.geometry.dispose(),this.tailMesh.material.dispose()}}var ya,wa,xa,ka,Ma;class c0{constructor(){L(this,ya,z(null));L(this,wa,z(Qt([])));L(this,xa,z(0));L(this,ka,z(null));L(this,Ma,z(null))}get manager(){return u(v(this,ya))}set manager(t){k(v(this,ya),t,!0)}get models(){return u(v(this,wa))}set models(t){k(v(this,wa),t,!0)}get fps(){return u(v(this,xa))}set fps(t){k(v(this,xa),t,!0)}get implantManager(){return u(v(this,ka))}set implantManager(t){k(v(this,ka),t,!0)}get forceArrowHandle(){return u(v(this,Ma))}set forceArrowHandle(t){k(v(this,Ma),t,!0)}addModel(t,n){var i,a;const s=n.geometry;this.models.push({name:t,mesh:n,visible:!0,vertexCount:((i=s.attributes.position)==null?void 0:i.count)??0,faceCount:s.index?s.index.count/3:(((a=s.attributes.position)==null?void 0:a.count)??0)/3})}removeModel(t){var s;const n=this.models.findIndex(i=>i.name===t);if(n>=0){const i=this.models[n];i.mesh.geometry.dispose(),Array.isArray(i.mesh.material)?i.mesh.material.forEach(a=>a.dispose()):i.mesh.material.dispose(),(s=this.manager)==null||s.scene.remove(i.mesh),this.models.splice(n,1)}}clearAll(){this.models.map(n=>n.name).forEach(n=>this.removeModel(n))}toggleVisibility(t){const n=this.models.find(s=>s.name===t);n&&(n.visible=!n.visible,n.mesh.visible=n.visible)}}ya=new WeakMap,wa=new WeakMap,xa=new WeakMap,ka=new WeakMap,Ma=new WeakMap;const H=new c0;class Ou{constructor(t=64){O(this,"resolution");O(this,"data",null);O(this,"bounds",null);O(this,"cellSize",0);O(this,"gridSize",null);this.resolution=t}createSnapshot(){return this.data?new Uint8Array(this.data):null}restoreSnapshot(t){!t||!this.data||this.data.set(t)}getSlice(t,n){if(!this.data||!this.gridSize)return null;let s,i,a;if(t==="z"){s=this.gridSize.x,i=this.gridSize.y,a=new Uint8Array(s*i);for(let o=0;o<i;o++)for(let r=0;r<s;r++)a[r+o*s]=this.get(r,o,n)}else if(t==="y"){s=this.gridSize.x,i=this.gridSize.z,a=new Uint8Array(s*i);for(let o=0;o<i;o++)for(let r=0;r<s;r++)a[r+o*s]=this.get(r,n,o)}else{s=this.gridSize.y,i=this.gridSize.z,a=new Uint8Array(s*i);for(let o=0;o<i;o++)for(let r=0;r<s;r++)a[r+o*s]=this.get(n,r,o)}return{width:s,height:i,data:a}}fromNRRD(t,n=.5,s=0){console.time("NRRD to Voxel");const{header:i,data:a}=t,[o,r,c]=i.sizes,l=i.spacing||[1,1,1];let d=1/0,f=-1/0;for(let P=0;P<a.length;P++)a[P]<d&&(d=a[P]),a[P]>f&&(f=a[P]);const h=d>=0&&f<=255&&Number.isInteger(f);let p=o,g=r,x=c,b=1,E=!1;s>0&&(b=Math.max(o,r,c)/s,(b>1||b<1)&&(E=b<1,p=Math.ceil(o/b),g=Math.ceil(r/b),x=Math.ceil(c/b))),this.gridSize={x:p,y:g,z:x};const I={x:o*l[0],y:r*l[1],z:c*l[2]},R=i.spaceOrigin||[0,0,0];this.bounds={min:new Y(R[0],R[1],R[2]),max:new Y(R[0]+I.x,R[1]+I.y,R[2]+I.z)},this.cellSize=Math.max(I.x/p,I.y/g,I.z/x),this.resolution=Math.max(p,g,x);const y=p*g*x;this.data=new Uint8Array(y);const C=(P,M,A)=>(P=Math.max(0,Math.min(o-1,P)),M=Math.max(0,Math.min(r-1,M)),A=Math.max(0,Math.min(c-1,A)),a[P+M*o+A*o*r]),$=(P,M,A)=>{const T=Math.floor(P),j=Math.min(T+1,o-1),ne=Math.floor(M),se=Math.min(ne+1,r-1),Q=Math.floor(A),U=Math.min(Q+1,c-1),N=P-T,oe=M-ne,ae=A-Q,ve=C(T,ne,Q),He=C(j,ne,Q),Ae=C(T,se,Q),Ve=C(j,se,Q),je=C(T,ne,U),Qe=C(j,ne,U),Se=C(T,se,U),Ye=C(j,se,U),Xe=ve*(1-N)+He*N,ut=je*(1-N)+Qe*N,Mt=Ae*(1-N)+Ve*N,G=Se*(1-N)+Ye*N,te=Xe*(1-oe)+Mt*oe,Z=ut*(1-oe)+G*oe;return te*(1-ae)+Z*ae};let S=0;for(let P=0;P<x;P++)for(let M=0;M<g;M++)for(let A=0;A<p;A++){const T=A*b,j=M*b,ne=P*b,se=A+M*p+P*p*g;let Q;if(h)Q=C(Math.round(T),Math.round(j),Math.round(ne))>0?1:0;else{let U;E?U=$(T,j,ne):U=C(Math.floor(T),Math.floor(j),Math.floor(ne)),Q=(U-d)/(f-d)>n?1:0}this.data[se]=Q,Q>0&&S++}return console.timeEnd("NRRD to Voxel"),console.log(`ì±ìì§ ë³µì: ${S} / ${y} (${(S/y*100).toFixed(1)}%)`),this}fromMesh(t){console.time("Voxelization");const n=t.geometry;n.computeBoundingBox();const s=n.boundingBox.clone();s.applyMatrix4(t.matrixWorld);const i=2;s.min.subScalar(i),s.max.addScalar(i),this.bounds={min:s.min.clone(),max:s.max.clone()};const a=s.getSize(new Y),o=Math.max(a.x,a.y,a.z);this.cellSize=o/this.resolution,this.gridSize={x:Math.ceil(a.x/this.cellSize),y:Math.ceil(a.y/this.cellSize),z:Math.ceil(a.z/this.cellSize)};const r=this.gridSize.x*this.gridSize.y*this.gridSize.z;this.data=new Uint8Array(r),this._voxelizeMesh(t),console.timeEnd("Voxelization");const c=this.data.reduce((l,d)=>l+d,0);return console.log(`Filled voxels: ${c} / ${r}`),this}_voxelizeMesh(t){const n=new si,s=new Y(1,0,0);for(let i=0;i<this.gridSize.z;i++)for(let a=0;a<this.gridSize.y;a++){const o=this.gridToWorld(0,a,i);o.x=this.bounds.min.x-1,n.set(o,s);const c=n.intersectObject(t).map(l=>l.point.x).sort((l,d)=>l-d);for(let l=0;l<this.gridSize.x;l++){const d=this.gridToWorld(l,a,i);let f=0;for(const h of c)if(d.x>h)f++;else break;f%2===1&&this.set(l,a,i,1)}}}index(t,n,s){return t+n*this.gridSize.x+s*this.gridSize.x*this.gridSize.y}get(t,n,s){return t<0||t>=this.gridSize.x||n<0||n>=this.gridSize.y||s<0||s>=this.gridSize.z?0:this.data[this.index(t,n,s)]}set(t,n,s,i){t<0||t>=this.gridSize.x||n<0||n>=this.gridSize.y||s<0||s>=this.gridSize.z||(this.data[this.index(t,n,s)]=i)}worldToGrid(t){return{x:Math.floor((t.x-this.bounds.min.x)/this.cellSize),y:Math.floor((t.y-this.bounds.min.y)/this.cellSize),z:Math.floor((t.z-this.bounds.min.z)/this.cellSize)}}gridToWorld(t,n,s){return new Y(this.bounds.min.x+(t+.5)*this.cellSize,this.bounds.min.y+(n+.5)*this.cellSize,this.bounds.min.z+(s+.5)*this.cellSize)}drillSphere(t,n){const s=this.worldToGrid(t),i=Math.ceil(n/this.cellSize);let a=0;for(let o=-i;o<=i;o++)for(let r=-i;r<=i;r++)for(let c=-i;c<=i;c++){const l=s.x+c,d=s.y+r,f=s.z+o;this.gridToWorld(l,d,f).distanceTo(t)<=n&&this.get(l,d,f)===1&&(this.set(l,d,f,0),a++)}return a}previewDrill(t,n){const s=this.worldToGrid({x:t.x-n,y:t.y-n,z:t.z-n}),i=this.worldToGrid({x:t.x+n,y:t.y+n,z:t.z+n});s.x=Math.max(0,s.x),s.y=Math.max(0,s.y),s.z=Math.max(0,s.z),i.x=Math.min(this.gridSize.x-1,i.x),i.y=Math.min(this.gridSize.y-1,i.y),i.z=Math.min(this.gridSize.z-1,i.z);const a=[];for(let o=s.z;o<=i.z;o++)for(let r=s.y;r<=i.y;r++)for(let c=s.x;c<=i.x;c++){if(this.get(c,r,o)!==1)continue;this.gridToWorld(c,r,o).distanceTo(t)<=n&&a.push({x:c,y:r,z:o})}return a}drillWithSphere(t,n){const s=this.previewDrill(t,n);return s.forEach(i=>this.set(i.x,i.y,i.z,0)),s.length}toMesh(){console.time("Marching Cubes");const t=[];for(let s=0;s<this.gridSize.z-1;s++)for(let i=0;i<this.gridSize.y-1;i++)for(let a=0;a<this.gridSize.x-1;a++)this._processCube(a,i,s,t);console.timeEnd("Marching Cubes"),console.log(`Generated ${t.length/9} triangles`);const n=new en;return n.setAttribute("position",new Ds(t,3)),n.computeVertexNormals(),n}_processCube(t,n,s,i){const a=[this.get(t,n,s),this.get(t+1,n,s),this.get(t+1,n,s+1),this.get(t,n,s+1),this.get(t,n+1,s),this.get(t+1,n+1,s),this.get(t+1,n+1,s+1),this.get(t,n+1,s+1)];let o=0;for(let h=0;h<8;h++)a[h]>0&&(o|=1<<h);if(o===0||o===255)return;const r=d0[o];if(r===0)return;const c=[this.gridToWorld(t,n,s),this.gridToWorld(t+1,n,s),this.gridToWorld(t+1,n,s+1),this.gridToWorld(t,n,s+1),this.gridToWorld(t,n+1,s),this.gridToWorld(t+1,n+1,s),this.gridToWorld(t+1,n+1,s+1),this.gridToWorld(t,n+1,s+1)],l=new Array(12),d=[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]];for(let h=0;h<12;h++)if(r&1<<h){const[p,g]=d[h];l[h]=c[p].clone().lerp(c[g],.5)}const f=u0[o];for(let h=0;f[h]!==-1;h+=3){const p=l[f[h]],g=l[f[h+1]],x=l[f[h+2]];p&&g&&x&&i.push(p.x,p.y,p.z,g.x,g.y,g.z,x.x,x.y,x.z)}}}const d0=[0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0],u0=[[-1],[0,8,3,-1],[0,1,9,-1],[1,8,3,9,8,1,-1],[1,2,10,-1],[0,8,3,1,2,10,-1],[9,2,10,0,2,9,-1],[2,8,3,2,10,8,10,9,8,-1],[3,11,2,-1],[0,11,2,8,11,0,-1],[1,9,0,2,3,11,-1],[1,11,2,1,9,11,9,8,11,-1],[3,10,1,11,10,3,-1],[0,10,1,0,8,10,8,11,10,-1],[3,9,0,3,11,9,11,10,9,-1],[9,8,10,10,8,11,-1],[4,7,8,-1],[4,3,0,7,3,4,-1],[0,1,9,8,4,7,-1],[4,1,9,4,7,1,7,3,1,-1],[1,2,10,8,4,7,-1],[3,4,7,3,0,4,1,2,10,-1],[9,2,10,9,0,2,8,4,7,-1],[2,10,9,2,9,7,2,7,3,7,9,4,-1],[8,4,7,3,11,2,-1],[11,4,7,11,2,4,2,0,4,-1],[9,0,1,8,4,7,2,3,11,-1],[4,7,11,9,4,11,9,11,2,9,2,1,-1],[3,10,1,3,11,10,7,8,4,-1],[1,11,10,1,4,11,1,0,4,7,11,4,-1],[4,7,8,9,0,11,9,11,10,11,0,3,-1],[4,7,11,4,11,9,9,11,10,-1],[9,5,4,-1],[9,5,4,0,8,3,-1],[0,5,4,1,5,0,-1],[8,5,4,8,3,5,3,1,5,-1],[1,2,10,9,5,4,-1],[3,0,8,1,2,10,4,9,5,-1],[5,2,10,5,4,2,4,0,2,-1],[2,10,5,3,2,5,3,5,4,3,4,8,-1],[9,5,4,2,3,11,-1],[0,11,2,0,8,11,4,9,5,-1],[0,5,4,0,1,5,2,3,11,-1],[2,1,5,2,5,8,2,8,11,4,8,5,-1],[10,3,11,10,1,3,9,5,4,-1],[4,9,5,0,8,1,8,10,1,8,11,10,-1],[5,4,0,5,0,11,5,11,10,11,0,3,-1],[5,4,8,5,8,10,10,8,11,-1],[9,7,8,5,7,9,-1],[9,3,0,9,5,3,5,7,3,-1],[0,7,8,0,1,7,1,5,7,-1],[1,5,3,3,5,7,-1],[9,7,8,9,5,7,10,1,2,-1],[10,1,2,9,5,0,5,3,0,5,7,3,-1],[8,0,2,8,2,5,8,5,7,10,5,2,-1],[2,10,5,2,5,3,3,5,7,-1],[7,9,5,7,8,9,3,11,2,-1],[9,5,7,9,7,2,9,2,0,2,7,11,-1],[2,3,11,0,1,8,1,7,8,1,5,7,-1],[11,2,1,11,1,7,7,1,5,-1],[9,5,8,8,5,7,10,1,3,10,3,11,-1],[5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1],[11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1],[11,10,5,7,11,5,-1],[10,6,5,-1],[0,8,3,5,10,6,-1],[9,0,1,5,10,6,-1],[1,8,3,1,9,8,5,10,6,-1],[1,6,5,2,6,1,-1],[1,6,5,1,2,6,3,0,8,-1],[9,6,5,9,0,6,0,2,6,-1],[5,9,8,5,8,2,5,2,6,3,2,8,-1],[2,3,11,10,6,5,-1],[11,0,8,11,2,0,10,6,5,-1],[0,1,9,2,3,11,5,10,6,-1],[5,10,6,1,9,2,9,11,2,9,8,11,-1],[6,3,11,6,5,3,5,1,3,-1],[0,8,11,0,11,5,0,5,1,5,11,6,-1],[3,11,6,0,3,6,0,6,5,0,5,9,-1],[6,5,9,6,9,11,11,9,8,-1],[5,10,6,4,7,8,-1],[4,3,0,4,7,3,6,5,10,-1],[1,9,0,5,10,6,8,4,7,-1],[10,6,5,1,9,7,1,7,3,7,9,4,-1],[6,1,2,6,5,1,4,7,8,-1],[1,2,5,5,2,6,3,0,4,3,4,7,-1],[8,4,7,9,0,5,0,6,5,0,2,6,-1],[7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1],[3,11,2,7,8,4,10,6,5,-1],[5,10,6,4,7,2,4,2,0,2,7,11,-1],[0,1,9,4,7,8,2,3,11,5,10,6,-1],[9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1],[8,4,7,3,11,5,3,5,1,5,11,6,-1],[5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1],[0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1],[6,5,9,6,9,11,4,7,9,7,11,9,-1],[10,4,9,6,4,10,-1],[4,10,6,4,9,10,0,8,3,-1],[10,0,1,10,6,0,6,4,0,-1],[8,3,1,8,1,6,8,6,4,6,1,10,-1],[1,4,9,1,2,4,2,6,4,-1],[3,0,8,1,2,9,2,4,9,2,6,4,-1],[0,2,4,4,2,6,-1],[8,3,2,8,2,4,4,2,6,-1],[10,4,9,10,6,4,11,2,3,-1],[0,8,2,2,8,11,4,9,10,4,10,6,-1],[3,11,2,0,1,6,0,6,4,6,1,10,-1],[6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1],[9,6,4,9,3,6,9,1,3,11,6,3,-1],[8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1],[3,11,6,3,6,0,0,6,4,-1],[6,4,8,11,6,8,-1],[7,10,6,7,8,10,8,9,10,-1],[0,7,3,0,10,7,0,9,10,6,7,10,-1],[10,6,7,1,10,7,1,7,8,1,8,0,-1],[10,6,7,10,7,1,1,7,3,-1],[1,2,6,1,6,8,1,8,9,8,6,7,-1],[2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1],[7,8,0,7,0,6,6,0,2,-1],[7,3,2,6,7,2,-1],[2,3,11,10,6,8,10,8,9,8,6,7,-1],[2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1],[1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1],[11,2,1,11,1,7,10,6,1,6,7,1,-1],[8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1],[0,9,1,11,6,7,-1],[7,8,0,7,0,6,3,11,0,11,6,0,-1],[7,11,6,-1],[7,6,11,-1],[3,0,8,11,7,6,-1],[0,1,9,11,7,6,-1],[8,1,9,8,3,1,11,7,6,-1],[10,1,2,6,11,7,-1],[1,2,10,3,0,8,6,11,7,-1],[2,9,0,2,10,9,6,11,7,-1],[6,11,7,2,10,3,10,8,3,10,9,8,-1],[7,2,3,6,2,7,-1],[7,0,8,7,6,0,6,2,0,-1],[2,7,6,2,3,7,0,1,9,-1],[1,6,2,1,8,6,1,9,8,8,7,6,-1],[10,7,6,10,1,7,1,3,7,-1],[10,7,6,1,7,10,1,8,7,1,0,8,-1],[0,3,7,0,7,10,0,10,9,6,10,7,-1],[7,6,10,7,10,8,8,10,9,-1],[6,8,4,11,8,6,-1],[3,6,11,3,0,6,0,4,6,-1],[8,6,11,8,4,6,9,0,1,-1],[9,4,6,9,6,3,9,3,1,11,3,6,-1],[6,8,4,6,11,8,2,10,1,-1],[1,2,10,3,0,11,0,6,11,0,4,6,-1],[4,11,8,4,6,11,0,2,9,2,10,9,-1],[10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1],[8,2,3,8,4,2,4,6,2,-1],[0,4,2,4,6,2,-1],[1,9,0,2,3,4,2,4,6,4,3,8,-1],[1,9,4,1,4,2,2,4,6,-1],[8,1,3,8,6,1,8,4,6,6,10,1,-1],[10,1,0,10,0,6,6,0,4,-1],[4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1],[10,9,4,6,10,4,-1],[4,9,5,7,6,11,-1],[0,8,3,4,9,5,11,7,6,-1],[5,0,1,5,4,0,7,6,11,-1],[11,7,6,8,3,4,3,5,4,3,1,5,-1],[9,5,4,10,1,2,7,6,11,-1],[6,11,7,1,2,10,0,8,3,4,9,5,-1],[7,6,11,5,4,10,4,2,10,4,0,2,-1],[3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1],[7,2,3,7,6,2,5,4,9,-1],[9,5,4,0,8,6,0,6,2,6,8,7,-1],[3,6,2,3,7,6,1,5,0,5,4,0,-1],[6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1],[9,5,4,10,1,6,1,7,6,1,3,7,-1],[1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1],[4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1],[7,6,10,7,10,8,5,4,10,4,8,10,-1],[6,9,5,6,11,9,11,8,9,-1],[3,6,11,0,6,3,0,5,6,0,9,5,-1],[0,11,8,0,5,11,0,1,5,5,6,11,-1],[6,11,3,6,3,5,5,3,1,-1],[1,2,10,9,5,11,9,11,8,11,5,6,-1],[0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1],[11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1],[6,11,3,6,3,5,2,10,3,10,5,3,-1],[5,8,9,5,2,8,5,6,2,3,8,2,-1],[9,5,6,9,6,0,0,6,2,-1],[1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1],[1,5,6,2,1,6,-1],[1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1],[10,1,0,10,0,6,9,5,0,5,6,0,-1],[0,3,8,5,6,10,-1],[10,5,6,-1],[11,5,10,7,5,11,-1],[11,5,10,11,7,5,8,3,0,-1],[5,11,7,5,10,11,1,9,0,-1],[10,7,5,10,11,7,9,8,1,8,3,1,-1],[11,1,2,11,7,1,7,5,1,-1],[0,8,3,1,2,7,1,7,5,7,2,11,-1],[9,7,5,9,2,7,9,0,2,2,11,7,-1],[7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1],[2,5,10,2,3,5,3,7,5,-1],[8,2,0,8,5,2,8,7,5,10,2,5,-1],[9,0,1,5,10,3,5,3,7,3,10,2,-1],[9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1],[1,3,5,3,7,5,-1],[0,8,7,0,7,1,1,7,5,-1],[9,0,3,9,3,5,5,3,7,-1],[9,8,7,5,9,7,-1],[5,8,4,5,10,8,10,11,8,-1],[5,0,4,5,11,0,5,10,11,11,3,0,-1],[0,1,9,8,4,10,8,10,11,10,4,5,-1],[10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1],[2,5,1,2,8,5,2,11,8,4,5,8,-1],[0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1],[0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1],[9,4,5,2,11,3,-1],[2,5,10,3,5,2,3,4,5,3,8,4,-1],[5,10,2,5,2,4,4,2,0,-1],[3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1],[5,10,2,5,2,4,1,9,2,9,4,2,-1],[8,4,5,8,5,3,3,5,1,-1],[0,4,5,1,0,5,-1],[8,4,5,8,5,3,9,0,5,0,3,5,-1],[9,4,5,-1],[4,11,7,4,9,11,9,10,11,-1],[0,8,3,4,9,7,9,11,7,9,10,11,-1],[1,10,11,1,11,4,1,4,0,7,4,11,-1],[3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1],[4,11,7,9,11,4,9,2,11,9,1,2,-1],[9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1],[11,7,4,11,4,2,2,4,0,-1],[11,7,4,11,4,2,8,3,4,3,2,4,-1],[2,9,10,2,7,9,2,3,7,7,4,9,-1],[9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1],[3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1],[1,10,2,8,7,4,-1],[4,9,1,4,1,7,7,1,3,-1],[4,9,1,4,1,7,0,8,1,8,7,1,-1],[4,0,3,7,4,3,-1],[4,8,7,-1],[9,10,8,10,11,8,-1],[3,0,9,3,9,11,11,9,10,-1],[0,1,10,0,10,8,8,10,11,-1],[3,1,10,11,3,10,-1],[1,2,11,1,11,9,9,11,8,-1],[3,0,9,3,9,11,1,2,9,2,11,9,-1],[0,2,11,8,0,11,-1],[3,2,11,-1],[2,3,8,2,8,10,10,8,9,-1],[9,10,2,0,9,2,-1],[2,3,8,2,8,10,0,1,8,1,10,8,-1],[1,10,2,-1],[1,3,8,9,1,8,-1],[0,9,1,-1],[0,3,8,-1],[-1]];/*! pako 2.1.0 https://github.com/nodeca/pako @license (MIT AND Zlib) */const h0=4,Fc=0,Nc=1,f0=2;function vi(e){let t=e.length;for(;--t>=0;)e[t]=0}const p0=0,Fu=1,v0=2,_0=3,m0=258,Gl=29,Ro=256,Ni=Ro+1+Gl,Xs=30,Vl=19,Nu=2*Ni+1,ws=15,zr=16,g0=7,Xl=256,$u=16,Hu=17,ju=18,vl=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),nr=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),b0=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),Bu=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),y0=512,$n=new Array((Ni+2)*2);vi($n);const Di=new Array(Xs*2);vi(Di);const $i=new Array(y0);vi($i);const Hi=new Array(m0-_0+1);vi(Hi);const Wl=new Array(Gl);vi(Wl);const cr=new Array(Xs);vi(cr);function Ir(e,t,n,s,i){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=s,this.max_length=i,this.has_stree=e&&e.length}let Uu,Zu,Yu;function Lr(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}const Gu=e=>e<256?$i[e]:$i[256+(e>>>7)],ji=(e,t)=>{e.pending_buf[e.pending++]=t&255,e.pending_buf[e.pending++]=t>>>8&255},Yt=(e,t,n)=>{e.bi_valid>zr-n?(e.bi_buf|=t<<e.bi_valid&65535,ji(e,e.bi_buf),e.bi_buf=t>>zr-e.bi_valid,e.bi_valid+=n-zr):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)},Tn=(e,t,n)=>{Yt(e,n[t*2],n[t*2+1])},Vu=(e,t)=>{let n=0;do n|=e&1,e>>>=1,n<<=1;while(--t>0);return n>>>1},w0=e=>{e.bi_valid===16?(ji(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=e.bi_buf&255,e.bi_buf>>=8,e.bi_valid-=8)},x0=(e,t)=>{const n=t.dyn_tree,s=t.max_code,i=t.stat_desc.static_tree,a=t.stat_desc.has_stree,o=t.stat_desc.extra_bits,r=t.stat_desc.extra_base,c=t.stat_desc.max_length;let l,d,f,h,p,g,x=0;for(h=0;h<=ws;h++)e.bl_count[h]=0;for(n[e.heap[e.heap_max]*2+1]=0,l=e.heap_max+1;l<Nu;l++)d=e.heap[l],h=n[n[d*2+1]*2+1]+1,h>c&&(h=c,x++),n[d*2+1]=h,!(d>s)&&(e.bl_count[h]++,p=0,d>=r&&(p=o[d-r]),g=n[d*2],e.opt_len+=g*(h+p),a&&(e.static_len+=g*(i[d*2+1]+p)));if(x!==0){do{for(h=c-1;e.bl_count[h]===0;)h--;e.bl_count[h]--,e.bl_count[h+1]+=2,e.bl_count[c]--,x-=2}while(x>0);for(h=c;h!==0;h--)for(d=e.bl_count[h];d!==0;)f=e.heap[--l],!(f>s)&&(n[f*2+1]!==h&&(e.opt_len+=(h-n[f*2+1])*n[f*2],n[f*2+1]=h),d--)}},Xu=(e,t,n)=>{const s=new Array(ws+1);let i=0,a,o;for(a=1;a<=ws;a++)i=i+n[a-1]<<1,s[a]=i;for(o=0;o<=t;o++){let r=e[o*2+1];r!==0&&(e[o*2]=Vu(s[r]++,r))}},k0=()=>{let e,t,n,s,i;const a=new Array(ws+1);for(n=0,s=0;s<Gl-1;s++)for(Wl[s]=n,e=0;e<1<<vl[s];e++)Hi[n++]=s;for(Hi[n-1]=s,i=0,s=0;s<16;s++)for(cr[s]=i,e=0;e<1<<nr[s];e++)$i[i++]=s;for(i>>=7;s<Xs;s++)for(cr[s]=i<<7,e=0;e<1<<nr[s]-7;e++)$i[256+i++]=s;for(t=0;t<=ws;t++)a[t]=0;for(e=0;e<=143;)$n[e*2+1]=8,e++,a[8]++;for(;e<=255;)$n[e*2+1]=9,e++,a[9]++;for(;e<=279;)$n[e*2+1]=7,e++,a[7]++;for(;e<=287;)$n[e*2+1]=8,e++,a[8]++;for(Xu($n,Ni+1,a),e=0;e<Xs;e++)Di[e*2+1]=5,Di[e*2]=Vu(e,5);Uu=new Ir($n,vl,Ro+1,Ni,ws),Zu=new Ir(Di,nr,0,Xs,ws),Yu=new Ir(new Array(0),b0,0,Vl,g0)},Wu=e=>{let t;for(t=0;t<Ni;t++)e.dyn_ltree[t*2]=0;for(t=0;t<Xs;t++)e.dyn_dtree[t*2]=0;for(t=0;t<Vl;t++)e.bl_tree[t*2]=0;e.dyn_ltree[Xl*2]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},Ku=e=>{e.bi_valid>8?ji(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},$c=(e,t,n,s)=>{const i=t*2,a=n*2;return e[i]<e[a]||e[i]===e[a]&&s[t]<=s[n]},Or=(e,t,n)=>{const s=e.heap[n];let i=n<<1;for(;i<=e.heap_len&&(i<e.heap_len&&$c(t,e.heap[i+1],e.heap[i],e.depth)&&i++,!$c(t,s,e.heap[i],e.depth));)e.heap[n]=e.heap[i],n=i,i<<=1;e.heap[n]=s},Hc=(e,t,n)=>{let s,i,a=0,o,r;if(e.sym_next!==0)do s=e.pending_buf[e.sym_buf+a++]&255,s+=(e.pending_buf[e.sym_buf+a++]&255)<<8,i=e.pending_buf[e.sym_buf+a++],s===0?Tn(e,i,t):(o=Hi[i],Tn(e,o+Ro+1,t),r=vl[o],r!==0&&(i-=Wl[o],Yt(e,i,r)),s--,o=Gu(s),Tn(e,o,n),r=nr[o],r!==0&&(s-=cr[o],Yt(e,s,r)));while(a<e.sym_next);Tn(e,Xl,t)},_l=(e,t)=>{const n=t.dyn_tree,s=t.stat_desc.static_tree,i=t.stat_desc.has_stree,a=t.stat_desc.elems;let o,r,c=-1,l;for(e.heap_len=0,e.heap_max=Nu,o=0;o<a;o++)n[o*2]!==0?(e.heap[++e.heap_len]=c=o,e.depth[o]=0):n[o*2+1]=0;for(;e.heap_len<2;)l=e.heap[++e.heap_len]=c<2?++c:0,n[l*2]=1,e.depth[l]=0,e.opt_len--,i&&(e.static_len-=s[l*2+1]);for(t.max_code=c,o=e.heap_len>>1;o>=1;o--)Or(e,n,o);l=a;do o=e.heap[1],e.heap[1]=e.heap[e.heap_len--],Or(e,n,1),r=e.heap[1],e.heap[--e.heap_max]=o,e.heap[--e.heap_max]=r,n[l*2]=n[o*2]+n[r*2],e.depth[l]=(e.depth[o]>=e.depth[r]?e.depth[o]:e.depth[r])+1,n[o*2+1]=n[r*2+1]=l,e.heap[1]=l++,Or(e,n,1);while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],x0(e,t),Xu(n,c,e.bl_count)},jc=(e,t,n)=>{let s,i=-1,a,o=t[1],r=0,c=7,l=4;for(o===0&&(c=138,l=3),t[(n+1)*2+1]=65535,s=0;s<=n;s++)a=o,o=t[(s+1)*2+1],!(++r<c&&a===o)&&(r<l?e.bl_tree[a*2]+=r:a!==0?(a!==i&&e.bl_tree[a*2]++,e.bl_tree[$u*2]++):r<=10?e.bl_tree[Hu*2]++:e.bl_tree[ju*2]++,r=0,i=a,o===0?(c=138,l=3):a===o?(c=6,l=3):(c=7,l=4))},Bc=(e,t,n)=>{let s,i=-1,a,o=t[1],r=0,c=7,l=4;for(o===0&&(c=138,l=3),s=0;s<=n;s++)if(a=o,o=t[(s+1)*2+1],!(++r<c&&a===o)){if(r<l)do Tn(e,a,e.bl_tree);while(--r!==0);else a!==0?(a!==i&&(Tn(e,a,e.bl_tree),r--),Tn(e,$u,e.bl_tree),Yt(e,r-3,2)):r<=10?(Tn(e,Hu,e.bl_tree),Yt(e,r-3,3)):(Tn(e,ju,e.bl_tree),Yt(e,r-11,7));r=0,i=a,o===0?(c=138,l=3):a===o?(c=6,l=3):(c=7,l=4)}},M0=e=>{let t;for(jc(e,e.dyn_ltree,e.l_desc.max_code),jc(e,e.dyn_dtree,e.d_desc.max_code),_l(e,e.bl_desc),t=Vl-1;t>=3&&e.bl_tree[Bu[t]*2+1]===0;t--);return e.opt_len+=3*(t+1)+5+5+4,t},S0=(e,t,n,s)=>{let i;for(Yt(e,t-257,5),Yt(e,n-1,5),Yt(e,s-4,4),i=0;i<s;i++)Yt(e,e.bl_tree[Bu[i]*2+1],3);Bc(e,e.dyn_ltree,t-1),Bc(e,e.dyn_dtree,n-1)},E0=e=>{let t=4093624447,n;for(n=0;n<=31;n++,t>>>=1)if(t&1&&e.dyn_ltree[n*2]!==0)return Fc;if(e.dyn_ltree[18]!==0||e.dyn_ltree[20]!==0||e.dyn_ltree[26]!==0)return Nc;for(n=32;n<Ro;n++)if(e.dyn_ltree[n*2]!==0)return Nc;return Fc};let Uc=!1;const C0=e=>{Uc||(k0(),Uc=!0),e.l_desc=new Lr(e.dyn_ltree,Uu),e.d_desc=new Lr(e.dyn_dtree,Zu),e.bl_desc=new Lr(e.bl_tree,Yu),e.bi_buf=0,e.bi_valid=0,Wu(e)},qu=(e,t,n,s)=>{Yt(e,(p0<<1)+(s?1:0),3),Ku(e),ji(e,n),ji(e,~n),n&&e.pending_buf.set(e.window.subarray(t,t+n),e.pending),e.pending+=n},P0=e=>{Yt(e,Fu<<1,3),Tn(e,Xl,$n),w0(e)},A0=(e,t,n,s)=>{let i,a,o=0;e.level>0?(e.strm.data_type===f0&&(e.strm.data_type=E0(e)),_l(e,e.l_desc),_l(e,e.d_desc),o=M0(e),i=e.opt_len+3+7>>>3,a=e.static_len+3+7>>>3,a<=i&&(i=a)):i=a=n+5,n+4<=i&&t!==-1?qu(e,t,n,s):e.strategy===h0||a===i?(Yt(e,(Fu<<1)+(s?1:0),3),Hc(e,$n,Di)):(Yt(e,(v0<<1)+(s?1:0),3),S0(e,e.l_desc.max_code+1,e.d_desc.max_code+1,o+1),Hc(e,e.dyn_ltree,e.dyn_dtree)),Wu(e),s&&Ku(e)},T0=(e,t,n)=>(e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=n,t===0?e.dyn_ltree[n*2]++:(e.matches++,t--,e.dyn_ltree[(Hi[n]+Ro+1)*2]++,e.dyn_dtree[Gu(t)*2]++),e.sym_next===e.sym_end);var R0=C0,D0=qu,z0=A0,I0=T0,L0=P0,O0={_tr_init:R0,_tr_stored_block:D0,_tr_flush_block:z0,_tr_tally:I0,_tr_align:L0};const F0=(e,t,n,s)=>{let i=e&65535|0,a=e>>>16&65535|0,o=0;for(;n!==0;){o=n>2e3?2e3:n,n-=o;do i=i+t[s++]|0,a=a+i|0;while(--o);i%=65521,a%=65521}return i|a<<16|0};var Bi=F0;const N0=()=>{let e,t=[];for(var n=0;n<256;n++){e=n;for(var s=0;s<8;s++)e=e&1?3988292384^e>>>1:e>>>1;t[n]=e}return t},$0=new Uint32Array(N0()),H0=(e,t,n,s)=>{const i=$0,a=s+n;e^=-1;for(let o=s;o<a;o++)e=e>>>8^i[(e^t[o])&255];return e^-1};var wt=H0,Os={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Do={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:j0,_tr_stored_block:ml,_tr_flush_block:B0,_tr_tally:ds,_tr_align:U0}=O0,{Z_NO_FLUSH:us,Z_PARTIAL_FLUSH:Z0,Z_FULL_FLUSH:Y0,Z_FINISH:cn,Z_BLOCK:Zc,Z_OK:Ct,Z_STREAM_END:Yc,Z_STREAM_ERROR:zn,Z_DATA_ERROR:G0,Z_BUF_ERROR:Fr,Z_DEFAULT_COMPRESSION:V0,Z_FILTERED:X0,Z_HUFFMAN_ONLY:Zo,Z_RLE:W0,Z_FIXED:K0,Z_DEFAULT_STRATEGY:q0,Z_UNKNOWN:Q0,Z_DEFLATED:br}=Do,J0=9,ev=15,tv=8,nv=29,sv=256,gl=sv+1+nv,iv=30,av=19,ov=2*gl+1,rv=15,Ee=3,ts=258,In=ts+Ee+1,lv=32,ui=42,Kl=57,bl=69,yl=73,wl=91,xl=103,xs=113,Ei=666,Ot=1,_i=2,Fs=3,mi=4,cv=3,ks=(e,t)=>(e.msg=Os[t],t),Gc=e=>e*2-(e>4?9:0),Qn=e=>{let t=e.length;for(;--t>=0;)e[t]=0},dv=e=>{let t,n,s,i=e.w_size;t=e.hash_size,s=t;do n=e.head[--s],e.head[s]=n>=i?n-i:0;while(--t);t=i,s=t;do n=e.prev[--s],e.prev[s]=n>=i?n-i:0;while(--t)};let uv=(e,t,n)=>(t<<e.hash_shift^n)&e.hash_mask,hs=uv;const Xt=e=>{const t=e.state;let n=t.pending;n>e.avail_out&&(n=e.avail_out),n!==0&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+n),e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,t.pending===0&&(t.pending_out=0))},Jt=(e,t)=>{B0(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,Xt(e.strm)},Re=(e,t)=>{e.pending_buf[e.pending++]=t},xi=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=t&255},kl=(e,t,n,s)=>{let i=e.avail_in;return i>s&&(i=s),i===0?0:(e.avail_in-=i,t.set(e.input.subarray(e.next_in,e.next_in+i),n),e.state.wrap===1?e.adler=Bi(e.adler,t,i,n):e.state.wrap===2&&(e.adler=wt(e.adler,t,i,n)),e.next_in+=i,e.total_in+=i,i)},Qu=(e,t)=>{let n=e.max_chain_length,s=e.strstart,i,a,o=e.prev_length,r=e.nice_match;const c=e.strstart>e.w_size-In?e.strstart-(e.w_size-In):0,l=e.window,d=e.w_mask,f=e.prev,h=e.strstart+ts;let p=l[s+o-1],g=l[s+o];e.prev_length>=e.good_match&&(n>>=2),r>e.lookahead&&(r=e.lookahead);do if(i=t,!(l[i+o]!==g||l[i+o-1]!==p||l[i]!==l[s]||l[++i]!==l[s+1])){s+=2,i++;do;while(l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&l[++s]===l[++i]&&s<h);if(a=ts-(h-s),s=h-ts,a>o){if(e.match_start=t,o=a,a>=r)break;p=l[s+o-1],g=l[s+o]}}while((t=f[t&d])>c&&--n!==0);return o<=e.lookahead?o:e.lookahead},hi=e=>{const t=e.w_size;let n,s,i;do{if(s=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-In)&&(e.window.set(e.window.subarray(t,t+t-s),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,e.insert>e.strstart&&(e.insert=e.strstart),dv(e),s+=t),e.strm.avail_in===0)break;if(n=kl(e.strm,e.window,e.strstart+e.lookahead,s),e.lookahead+=n,e.lookahead+e.insert>=Ee)for(i=e.strstart-e.insert,e.ins_h=e.window[i],e.ins_h=hs(e,e.ins_h,e.window[i+1]);e.insert&&(e.ins_h=hs(e,e.ins_h,e.window[i+Ee-1]),e.prev[i&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=i,i++,e.insert--,!(e.lookahead+e.insert<Ee)););}while(e.lookahead<In&&e.strm.avail_in!==0)},Ju=(e,t)=>{let n=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,s,i,a,o=0,r=e.strm.avail_in;do{if(s=65535,a=e.bi_valid+42>>3,e.strm.avail_out<a||(a=e.strm.avail_out-a,i=e.strstart-e.block_start,s>i+e.strm.avail_in&&(s=i+e.strm.avail_in),s>a&&(s=a),s<n&&(s===0&&t!==cn||t===us||s!==i+e.strm.avail_in)))break;o=t===cn&&s===i+e.strm.avail_in?1:0,ml(e,0,0,o),e.pending_buf[e.pending-4]=s,e.pending_buf[e.pending-3]=s>>8,e.pending_buf[e.pending-2]=~s,e.pending_buf[e.pending-1]=~s>>8,Xt(e.strm),i&&(i>s&&(i=s),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+i),e.strm.next_out),e.strm.next_out+=i,e.strm.avail_out-=i,e.strm.total_out+=i,e.block_start+=i,s-=i),s&&(kl(e.strm,e.strm.output,e.strm.next_out,s),e.strm.next_out+=s,e.strm.avail_out-=s,e.strm.total_out+=s)}while(o===0);return r-=e.strm.avail_in,r&&(r>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=r&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-r,e.strm.next_in),e.strstart),e.strstart+=r,e.insert+=r>e.w_size-e.insert?e.w_size-e.insert:r),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),o?mi:t!==us&&t!==cn&&e.strm.avail_in===0&&e.strstart===e.block_start?_i:(a=e.window_size-e.strstart,e.strm.avail_in>a&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,a+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),a>e.strm.avail_in&&(a=e.strm.avail_in),a&&(kl(e.strm,e.window,e.strstart,a),e.strstart+=a,e.insert+=a>e.w_size-e.insert?e.w_size-e.insert:a),e.high_water<e.strstart&&(e.high_water=e.strstart),a=e.bi_valid+42>>3,a=e.pending_buf_size-a>65535?65535:e.pending_buf_size-a,n=a>e.w_size?e.w_size:a,i=e.strstart-e.block_start,(i>=n||(i||t===cn)&&t!==us&&e.strm.avail_in===0&&i<=a)&&(s=i>a?a:i,o=t===cn&&e.strm.avail_in===0&&s===i?1:0,ml(e,e.block_start,s,o),e.block_start+=s,Xt(e.strm)),o?Fs:Ot)},Nr=(e,t)=>{let n,s;for(;;){if(e.lookahead<In){if(hi(e),e.lookahead<In&&t===us)return Ot;if(e.lookahead===0)break}if(n=0,e.lookahead>=Ee&&(e.ins_h=hs(e,e.ins_h,e.window[e.strstart+Ee-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),n!==0&&e.strstart-n<=e.w_size-In&&(e.match_length=Qu(e,n)),e.match_length>=Ee)if(s=ds(e,e.strstart-e.match_start,e.match_length-Ee),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=Ee){e.match_length--;do e.strstart++,e.ins_h=hs(e,e.ins_h,e.window[e.strstart+Ee-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart;while(--e.match_length!==0);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=hs(e,e.ins_h,e.window[e.strstart+1]);else s=ds(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(s&&(Jt(e,!1),e.strm.avail_out===0))return Ot}return e.insert=e.strstart<Ee-1?e.strstart:Ee-1,t===cn?(Jt(e,!0),e.strm.avail_out===0?Fs:mi):e.sym_next&&(Jt(e,!1),e.strm.avail_out===0)?Ot:_i},Bs=(e,t)=>{let n,s,i;for(;;){if(e.lookahead<In){if(hi(e),e.lookahead<In&&t===us)return Ot;if(e.lookahead===0)break}if(n=0,e.lookahead>=Ee&&(e.ins_h=hs(e,e.ins_h,e.window[e.strstart+Ee-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=Ee-1,n!==0&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-In&&(e.match_length=Qu(e,n),e.match_length<=5&&(e.strategy===X0||e.match_length===Ee&&e.strstart-e.match_start>4096)&&(e.match_length=Ee-1)),e.prev_length>=Ee&&e.match_length<=e.prev_length){i=e.strstart+e.lookahead-Ee,s=ds(e,e.strstart-1-e.prev_match,e.prev_length-Ee),e.lookahead-=e.prev_length-1,e.prev_length-=2;do++e.strstart<=i&&(e.ins_h=hs(e,e.ins_h,e.window[e.strstart+Ee-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart);while(--e.prev_length!==0);if(e.match_available=0,e.match_length=Ee-1,e.strstart++,s&&(Jt(e,!1),e.strm.avail_out===0))return Ot}else if(e.match_available){if(s=ds(e,0,e.window[e.strstart-1]),s&&Jt(e,!1),e.strstart++,e.lookahead--,e.strm.avail_out===0)return Ot}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(s=ds(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<Ee-1?e.strstart:Ee-1,t===cn?(Jt(e,!0),e.strm.avail_out===0?Fs:mi):e.sym_next&&(Jt(e,!1),e.strm.avail_out===0)?Ot:_i},hv=(e,t)=>{let n,s,i,a;const o=e.window;for(;;){if(e.lookahead<=ts){if(hi(e),e.lookahead<=ts&&t===us)return Ot;if(e.lookahead===0)break}if(e.match_length=0,e.lookahead>=Ee&&e.strstart>0&&(i=e.strstart-1,s=o[i],s===o[++i]&&s===o[++i]&&s===o[++i])){a=e.strstart+ts;do;while(s===o[++i]&&s===o[++i]&&s===o[++i]&&s===o[++i]&&s===o[++i]&&s===o[++i]&&s===o[++i]&&s===o[++i]&&i<a);e.match_length=ts-(a-i),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=Ee?(n=ds(e,1,e.match_length-Ee),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(n=ds(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),n&&(Jt(e,!1),e.strm.avail_out===0))return Ot}return e.insert=0,t===cn?(Jt(e,!0),e.strm.avail_out===0?Fs:mi):e.sym_next&&(Jt(e,!1),e.strm.avail_out===0)?Ot:_i},fv=(e,t)=>{let n;for(;;){if(e.lookahead===0&&(hi(e),e.lookahead===0)){if(t===us)return Ot;break}if(e.match_length=0,n=ds(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,n&&(Jt(e,!1),e.strm.avail_out===0))return Ot}return e.insert=0,t===cn?(Jt(e,!0),e.strm.avail_out===0?Fs:mi):e.sym_next&&(Jt(e,!1),e.strm.avail_out===0)?Ot:_i};function Sn(e,t,n,s,i){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=s,this.func=i}const Ci=[new Sn(0,0,0,0,Ju),new Sn(4,4,8,4,Nr),new Sn(4,5,16,8,Nr),new Sn(4,6,32,32,Nr),new Sn(4,4,16,16,Bs),new Sn(8,16,32,32,Bs),new Sn(8,16,128,128,Bs),new Sn(8,32,128,256,Bs),new Sn(32,128,258,1024,Bs),new Sn(32,258,258,4096,Bs)],pv=e=>{e.window_size=2*e.w_size,Qn(e.head),e.max_lazy_match=Ci[e.level].max_lazy,e.good_match=Ci[e.level].good_length,e.nice_match=Ci[e.level].nice_length,e.max_chain_length=Ci[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=Ee-1,e.match_available=0,e.ins_h=0};function vv(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=br,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(ov*2),this.dyn_dtree=new Uint16Array((2*iv+1)*2),this.bl_tree=new Uint16Array((2*av+1)*2),Qn(this.dyn_ltree),Qn(this.dyn_dtree),Qn(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(rv+1),this.heap=new Uint16Array(2*gl+1),Qn(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*gl+1),Qn(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const zo=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.status!==ui&&t.status!==Kl&&t.status!==bl&&t.status!==yl&&t.status!==wl&&t.status!==xl&&t.status!==xs&&t.status!==Ei?1:0},eh=e=>{if(zo(e))return ks(e,zn);e.total_in=e.total_out=0,e.data_type=Q0;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap===2?Kl:t.wrap?ui:xs,e.adler=t.wrap===2?0:1,t.last_flush=-2,j0(t),Ct},th=e=>{const t=eh(e);return t===Ct&&pv(e.state),t},_v=(e,t)=>zo(e)||e.state.wrap!==2?zn:(e.state.gzhead=t,Ct),nh=(e,t,n,s,i,a)=>{if(!e)return zn;let o=1;if(t===V0&&(t=6),s<0?(o=0,s=-s):s>15&&(o=2,s-=16),i<1||i>J0||n!==br||s<8||s>15||t<0||t>9||a<0||a>K0||s===8&&o!==1)return ks(e,zn);s===8&&(s=9);const r=new vv;return e.state=r,r.strm=e,r.status=ui,r.wrap=o,r.gzhead=null,r.w_bits=s,r.w_size=1<<r.w_bits,r.w_mask=r.w_size-1,r.hash_bits=i+7,r.hash_size=1<<r.hash_bits,r.hash_mask=r.hash_size-1,r.hash_shift=~~((r.hash_bits+Ee-1)/Ee),r.window=new Uint8Array(r.w_size*2),r.head=new Uint16Array(r.hash_size),r.prev=new Uint16Array(r.w_size),r.lit_bufsize=1<<i+6,r.pending_buf_size=r.lit_bufsize*4,r.pending_buf=new Uint8Array(r.pending_buf_size),r.sym_buf=r.lit_bufsize,r.sym_end=(r.lit_bufsize-1)*3,r.level=t,r.strategy=a,r.method=n,th(e)},mv=(e,t)=>nh(e,t,br,ev,tv,q0),gv=(e,t)=>{if(zo(e)||t>Zc||t<0)return e?ks(e,zn):zn;const n=e.state;if(!e.output||e.avail_in!==0&&!e.input||n.status===Ei&&t!==cn)return ks(e,e.avail_out===0?Fr:zn);const s=n.last_flush;if(n.last_flush=t,n.pending!==0){if(Xt(e),e.avail_out===0)return n.last_flush=-1,Ct}else if(e.avail_in===0&&Gc(t)<=Gc(s)&&t!==cn)return ks(e,Fr);if(n.status===Ei&&e.avail_in!==0)return ks(e,Fr);if(n.status===ui&&n.wrap===0&&(n.status=xs),n.status===ui){let i=br+(n.w_bits-8<<4)<<8,a=-1;if(n.strategy>=Zo||n.level<2?a=0:n.level<6?a=1:n.level===6?a=2:a=3,i|=a<<6,n.strstart!==0&&(i|=lv),i+=31-i%31,xi(n,i),n.strstart!==0&&(xi(n,e.adler>>>16),xi(n,e.adler&65535)),e.adler=1,n.status=xs,Xt(e),n.pending!==0)return n.last_flush=-1,Ct}if(n.status===Kl){if(e.adler=0,Re(n,31),Re(n,139),Re(n,8),n.gzhead)Re(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),Re(n,n.gzhead.time&255),Re(n,n.gzhead.time>>8&255),Re(n,n.gzhead.time>>16&255),Re(n,n.gzhead.time>>24&255),Re(n,n.level===9?2:n.strategy>=Zo||n.level<2?4:0),Re(n,n.gzhead.os&255),n.gzhead.extra&&n.gzhead.extra.length&&(Re(n,n.gzhead.extra.length&255),Re(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(e.adler=wt(e.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=bl;else if(Re(n,0),Re(n,0),Re(n,0),Re(n,0),Re(n,0),Re(n,n.level===9?2:n.strategy>=Zo||n.level<2?4:0),Re(n,cv),n.status=xs,Xt(e),n.pending!==0)return n.last_flush=-1,Ct}if(n.status===bl){if(n.gzhead.extra){let i=n.pending,a=(n.gzhead.extra.length&65535)-n.gzindex;for(;n.pending+a>n.pending_buf_size;){let r=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+r),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>i&&(e.adler=wt(e.adler,n.pending_buf,n.pending-i,i)),n.gzindex+=r,Xt(e),n.pending!==0)return n.last_flush=-1,Ct;i=0,a-=r}let o=new Uint8Array(n.gzhead.extra);n.pending_buf.set(o.subarray(n.gzindex,n.gzindex+a),n.pending),n.pending+=a,n.gzhead.hcrc&&n.pending>i&&(e.adler=wt(e.adler,n.pending_buf,n.pending-i,i)),n.gzindex=0}n.status=yl}if(n.status===yl){if(n.gzhead.name){let i=n.pending,a;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>i&&(e.adler=wt(e.adler,n.pending_buf,n.pending-i,i)),Xt(e),n.pending!==0)return n.last_flush=-1,Ct;i=0}n.gzindex<n.gzhead.name.length?a=n.gzhead.name.charCodeAt(n.gzindex++)&255:a=0,Re(n,a)}while(a!==0);n.gzhead.hcrc&&n.pending>i&&(e.adler=wt(e.adler,n.pending_buf,n.pending-i,i)),n.gzindex=0}n.status=wl}if(n.status===wl){if(n.gzhead.comment){let i=n.pending,a;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>i&&(e.adler=wt(e.adler,n.pending_buf,n.pending-i,i)),Xt(e),n.pending!==0)return n.last_flush=-1,Ct;i=0}n.gzindex<n.gzhead.comment.length?a=n.gzhead.comment.charCodeAt(n.gzindex++)&255:a=0,Re(n,a)}while(a!==0);n.gzhead.hcrc&&n.pending>i&&(e.adler=wt(e.adler,n.pending_buf,n.pending-i,i))}n.status=xl}if(n.status===xl){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(Xt(e),n.pending!==0))return n.last_flush=-1,Ct;Re(n,e.adler&255),Re(n,e.adler>>8&255),e.adler=0}if(n.status=xs,Xt(e),n.pending!==0)return n.last_flush=-1,Ct}if(e.avail_in!==0||n.lookahead!==0||t!==us&&n.status!==Ei){let i=n.level===0?Ju(n,t):n.strategy===Zo?fv(n,t):n.strategy===W0?hv(n,t):Ci[n.level].func(n,t);if((i===Fs||i===mi)&&(n.status=Ei),i===Ot||i===Fs)return e.avail_out===0&&(n.last_flush=-1),Ct;if(i===_i&&(t===Z0?U0(n):t!==Zc&&(ml(n,0,0,!1),t===Y0&&(Qn(n.head),n.lookahead===0&&(n.strstart=0,n.block_start=0,n.insert=0))),Xt(e),e.avail_out===0))return n.last_flush=-1,Ct}return t!==cn?Ct:n.wrap<=0?Yc:(n.wrap===2?(Re(n,e.adler&255),Re(n,e.adler>>8&255),Re(n,e.adler>>16&255),Re(n,e.adler>>24&255),Re(n,e.total_in&255),Re(n,e.total_in>>8&255),Re(n,e.total_in>>16&255),Re(n,e.total_in>>24&255)):(xi(n,e.adler>>>16),xi(n,e.adler&65535)),Xt(e),n.wrap>0&&(n.wrap=-n.wrap),n.pending!==0?Ct:Yc)},bv=e=>{if(zo(e))return zn;const t=e.state.status;return e.state=null,t===xs?ks(e,G0):Ct},yv=(e,t)=>{let n=t.length;if(zo(e))return zn;const s=e.state,i=s.wrap;if(i===2||i===1&&s.status!==ui||s.lookahead)return zn;if(i===1&&(e.adler=Bi(e.adler,t,n,0)),s.wrap=0,n>=s.w_size){i===0&&(Qn(s.head),s.strstart=0,s.block_start=0,s.insert=0);let c=new Uint8Array(s.w_size);c.set(t.subarray(n-s.w_size,n),0),t=c,n=s.w_size}const a=e.avail_in,o=e.next_in,r=e.input;for(e.avail_in=n,e.next_in=0,e.input=t,hi(s);s.lookahead>=Ee;){let c=s.strstart,l=s.lookahead-(Ee-1);do s.ins_h=hs(s,s.ins_h,s.window[c+Ee-1]),s.prev[c&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=c,c++;while(--l);s.strstart=c,s.lookahead=Ee-1,hi(s)}return s.strstart+=s.lookahead,s.block_start=s.strstart,s.insert=s.lookahead,s.lookahead=0,s.match_length=s.prev_length=Ee-1,s.match_available=0,e.next_in=o,e.input=r,e.avail_in=a,s.wrap=i,Ct};var wv=mv,xv=nh,kv=th,Mv=eh,Sv=_v,Ev=gv,Cv=bv,Pv=yv,Av="pako deflate (from Nodeca project)",zi={deflateInit:wv,deflateInit2:xv,deflateReset:kv,deflateResetKeep:Mv,deflateSetHeader:Sv,deflate:Ev,deflateEnd:Cv,deflateSetDictionary:Pv,deflateInfo:Av};const Tv=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var Rv=function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const n=t.shift();if(n){if(typeof n!="object")throw new TypeError(n+"must be non-object");for(const s in n)Tv(n,s)&&(e[s]=n[s])}}return e},Dv=e=>{let t=0;for(let s=0,i=e.length;s<i;s++)t+=e[s].length;const n=new Uint8Array(t);for(let s=0,i=0,a=e.length;s<a;s++){let o=e[s];n.set(o,i),i+=o.length}return n},yr={assign:Rv,flattenChunks:Dv};let sh=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{sh=!1}const Ui=new Uint8Array(256);for(let e=0;e<256;e++)Ui[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;Ui[254]=Ui[254]=1;var zv=e=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(e);let t,n,s,i,a,o=e.length,r=0;for(i=0;i<o;i++)n=e.charCodeAt(i),(n&64512)===55296&&i+1<o&&(s=e.charCodeAt(i+1),(s&64512)===56320&&(n=65536+(n-55296<<10)+(s-56320),i++)),r+=n<128?1:n<2048?2:n<65536?3:4;for(t=new Uint8Array(r),a=0,i=0;a<r;i++)n=e.charCodeAt(i),(n&64512)===55296&&i+1<o&&(s=e.charCodeAt(i+1),(s&64512)===56320&&(n=65536+(n-55296<<10)+(s-56320),i++)),n<128?t[a++]=n:n<2048?(t[a++]=192|n>>>6,t[a++]=128|n&63):n<65536?(t[a++]=224|n>>>12,t[a++]=128|n>>>6&63,t[a++]=128|n&63):(t[a++]=240|n>>>18,t[a++]=128|n>>>12&63,t[a++]=128|n>>>6&63,t[a++]=128|n&63);return t};const Iv=(e,t)=>{if(t<65534&&e.subarray&&sh)return String.fromCharCode.apply(null,e.length===t?e:e.subarray(0,t));let n="";for(let s=0;s<t;s++)n+=String.fromCharCode(e[s]);return n};var Lv=(e,t)=>{const n=t||e.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(e.subarray(0,t));let s,i;const a=new Array(n*2);for(i=0,s=0;s<n;){let o=e[s++];if(o<128){a[i++]=o;continue}let r=Ui[o];if(r>4){a[i++]=65533,s+=r-1;continue}for(o&=r===2?31:r===3?15:7;r>1&&s<n;)o=o<<6|e[s++]&63,r--;if(r>1){a[i++]=65533;continue}o<65536?a[i++]=o:(o-=65536,a[i++]=55296|o>>10&1023,a[i++]=56320|o&1023)}return Iv(a,i)},Ov=(e,t)=>{t=t||e.length,t>e.length&&(t=e.length);let n=t-1;for(;n>=0&&(e[n]&192)===128;)n--;return n<0||n===0?t:n+Ui[e[n]]>t?n:t},Zi={string2buf:zv,buf2string:Lv,utf8border:Ov};function Fv(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var ih=Fv;const ah=Object.prototype.toString,{Z_NO_FLUSH:Nv,Z_SYNC_FLUSH:$v,Z_FULL_FLUSH:Hv,Z_FINISH:jv,Z_OK:dr,Z_STREAM_END:Bv,Z_DEFAULT_COMPRESSION:Uv,Z_DEFAULT_STRATEGY:Zv,Z_DEFLATED:Yv}=Do;function Io(e){this.options=yr.assign({level:Uv,method:Yv,chunkSize:16384,windowBits:15,memLevel:8,strategy:Zv},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new ih,this.strm.avail_out=0;let n=zi.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(n!==dr)throw new Error(Os[n]);if(t.header&&zi.deflateSetHeader(this.strm,t.header),t.dictionary){let s;if(typeof t.dictionary=="string"?s=Zi.string2buf(t.dictionary):ah.call(t.dictionary)==="[object ArrayBuffer]"?s=new Uint8Array(t.dictionary):s=t.dictionary,n=zi.deflateSetDictionary(this.strm,s),n!==dr)throw new Error(Os[n]);this._dict_set=!0}}Io.prototype.push=function(e,t){const n=this.strm,s=this.options.chunkSize;let i,a;if(this.ended)return!1;for(t===~~t?a=t:a=t===!0?jv:Nv,typeof e=="string"?n.input=Zi.string2buf(e):ah.call(e)==="[object ArrayBuffer]"?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;){if(n.avail_out===0&&(n.output=new Uint8Array(s),n.next_out=0,n.avail_out=s),(a===$v||a===Hv)&&n.avail_out<=6){this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;continue}if(i=zi.deflate(n,a),i===Bv)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),i=zi.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===dr;if(n.avail_out===0){this.onData(n.output);continue}if(a>0&&n.next_out>0){this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;continue}if(n.avail_in===0)break}return!0};Io.prototype.onData=function(e){this.chunks.push(e)};Io.prototype.onEnd=function(e){e===dr&&(this.result=yr.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};function ql(e,t){const n=new Io(t);if(n.push(e,!0),n.err)throw n.msg||Os[n.err];return n.result}function Gv(e,t){return t=t||{},t.raw=!0,ql(e,t)}function Vv(e,t){return t=t||{},t.gzip=!0,ql(e,t)}var Xv=Io,Wv=ql,Kv=Gv,qv=Vv,Qv={Deflate:Xv,deflate:Wv,deflateRaw:Kv,gzip:qv};const Yo=16209,Jv=16191;var e1=function(t,n){let s,i,a,o,r,c,l,d,f,h,p,g,x,b,E,I,R,y,C,$,S,P,M,A;const T=t.state;s=t.next_in,M=t.input,i=s+(t.avail_in-5),a=t.next_out,A=t.output,o=a-(n-t.avail_out),r=a+(t.avail_out-257),c=T.dmax,l=T.wsize,d=T.whave,f=T.wnext,h=T.window,p=T.hold,g=T.bits,x=T.lencode,b=T.distcode,E=(1<<T.lenbits)-1,I=(1<<T.distbits)-1;e:do{g<15&&(p+=M[s++]<<g,g+=8,p+=M[s++]<<g,g+=8),R=x[p&E];t:for(;;){if(y=R>>>24,p>>>=y,g-=y,y=R>>>16&255,y===0)A[a++]=R&65535;else if(y&16){C=R&65535,y&=15,y&&(g<y&&(p+=M[s++]<<g,g+=8),C+=p&(1<<y)-1,p>>>=y,g-=y),g<15&&(p+=M[s++]<<g,g+=8,p+=M[s++]<<g,g+=8),R=b[p&I];n:for(;;){if(y=R>>>24,p>>>=y,g-=y,y=R>>>16&255,y&16){if($=R&65535,y&=15,g<y&&(p+=M[s++]<<g,g+=8,g<y&&(p+=M[s++]<<g,g+=8)),$+=p&(1<<y)-1,$>c){t.msg="invalid distance too far back",T.mode=Yo;break e}if(p>>>=y,g-=y,y=a-o,$>y){if(y=$-y,y>d&&T.sane){t.msg="invalid distance too far back",T.mode=Yo;break e}if(S=0,P=h,f===0){if(S+=l-y,y<C){C-=y;do A[a++]=h[S++];while(--y);S=a-$,P=A}}else if(f<y){if(S+=l+f-y,y-=f,y<C){C-=y;do A[a++]=h[S++];while(--y);if(S=0,f<C){y=f,C-=y;do A[a++]=h[S++];while(--y);S=a-$,P=A}}}else if(S+=f-y,y<C){C-=y;do A[a++]=h[S++];while(--y);S=a-$,P=A}for(;C>2;)A[a++]=P[S++],A[a++]=P[S++],A[a++]=P[S++],C-=3;C&&(A[a++]=P[S++],C>1&&(A[a++]=P[S++]))}else{S=a-$;do A[a++]=A[S++],A[a++]=A[S++],A[a++]=A[S++],C-=3;while(C>2);C&&(A[a++]=A[S++],C>1&&(A[a++]=A[S++]))}}else if((y&64)===0){R=b[(R&65535)+(p&(1<<y)-1)];continue n}else{t.msg="invalid distance code",T.mode=Yo;break e}break}}else if((y&64)===0){R=x[(R&65535)+(p&(1<<y)-1)];continue t}else if(y&32){T.mode=Jv;break e}else{t.msg="invalid literal/length code",T.mode=Yo;break e}break}}while(s<i&&a<r);C=g>>3,s-=C,g-=C<<3,p&=(1<<g)-1,t.next_in=s,t.next_out=a,t.avail_in=s<i?5+(i-s):5-(s-i),t.avail_out=a<r?257+(r-a):257-(a-r),T.hold=p,T.bits=g};const Us=15,Vc=852,Xc=592,Wc=0,$r=1,Kc=2,t1=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),n1=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),s1=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),i1=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),a1=(e,t,n,s,i,a,o,r)=>{const c=r.bits;let l=0,d=0,f=0,h=0,p=0,g=0,x=0,b=0,E=0,I=0,R,y,C,$,S,P=null,M;const A=new Uint16Array(Us+1),T=new Uint16Array(Us+1);let j=null,ne,se,Q;for(l=0;l<=Us;l++)A[l]=0;for(d=0;d<s;d++)A[t[n+d]]++;for(p=c,h=Us;h>=1&&A[h]===0;h--);if(p>h&&(p=h),h===0)return i[a++]=1<<24|64<<16|0,i[a++]=1<<24|64<<16|0,r.bits=1,0;for(f=1;f<h&&A[f]===0;f++);for(p<f&&(p=f),b=1,l=1;l<=Us;l++)if(b<<=1,b-=A[l],b<0)return-1;if(b>0&&(e===Wc||h!==1))return-1;for(T[1]=0,l=1;l<Us;l++)T[l+1]=T[l]+A[l];for(d=0;d<s;d++)t[n+d]!==0&&(o[T[t[n+d]]++]=d);if(e===Wc?(P=j=o,M=20):e===$r?(P=t1,j=n1,M=257):(P=s1,j=i1,M=0),I=0,d=0,l=f,S=a,g=p,x=0,C=-1,E=1<<p,$=E-1,e===$r&&E>Vc||e===Kc&&E>Xc)return 1;for(;;){ne=l-x,o[d]+1<M?(se=0,Q=o[d]):o[d]>=M?(se=j[o[d]-M],Q=P[o[d]-M]):(se=96,Q=0),R=1<<l-x,y=1<<g,f=y;do y-=R,i[S+(I>>x)+y]=ne<<24|se<<16|Q|0;while(y!==0);for(R=1<<l-1;I&R;)R>>=1;if(R!==0?(I&=R-1,I+=R):I=0,d++,--A[l]===0){if(l===h)break;l=t[n+o[d]]}if(l>p&&(I&$)!==C){for(x===0&&(x=p),S+=f,g=l-x,b=1<<g;g+x<h&&(b-=A[g+x],!(b<=0));)g++,b<<=1;if(E+=1<<g,e===$r&&E>Vc||e===Kc&&E>Xc)return 1;C=I&$,i[C]=p<<24|g<<16|S-a|0}}return I!==0&&(i[S+I]=l-x<<24|64<<16|0),r.bits=p,0};var Ii=a1;const o1=0,oh=1,rh=2,{Z_FINISH:qc,Z_BLOCK:r1,Z_TREES:Go,Z_OK:Ns,Z_STREAM_END:l1,Z_NEED_DICT:c1,Z_STREAM_ERROR:fn,Z_DATA_ERROR:lh,Z_MEM_ERROR:ch,Z_BUF_ERROR:d1,Z_DEFLATED:Qc}=Do,wr=16180,Jc=16181,ed=16182,td=16183,nd=16184,sd=16185,id=16186,ad=16187,od=16188,rd=16189,ur=16190,Fn=16191,Hr=16192,ld=16193,jr=16194,cd=16195,dd=16196,ud=16197,hd=16198,Vo=16199,Xo=16200,fd=16201,pd=16202,vd=16203,_d=16204,md=16205,Br=16206,gd=16207,bd=16208,Ke=16209,dh=16210,uh=16211,u1=852,h1=592,f1=15,p1=f1,yd=e=>(e>>>24&255)+(e>>>8&65280)+((e&65280)<<8)+((e&255)<<24);function v1(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Hs=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.mode<wr||t.mode>uh?1:0},hh=e=>{if(Hs(e))return fn;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=t.wrap&1),t.mode=wr,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(u1),t.distcode=t.distdyn=new Int32Array(h1),t.sane=1,t.back=-1,Ns},fh=e=>{if(Hs(e))return fn;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,hh(e)},ph=(e,t)=>{let n;if(Hs(e))return fn;const s=e.state;return t<0?(n=0,t=-t):(n=(t>>4)+5,t<48&&(t&=15)),t&&(t<8||t>15)?fn:(s.window!==null&&s.wbits!==t&&(s.window=null),s.wrap=n,s.wbits=t,fh(e))},vh=(e,t)=>{if(!e)return fn;const n=new v1;e.state=n,n.strm=e,n.window=null,n.mode=wr;const s=ph(e,t);return s!==Ns&&(e.state=null),s},_1=e=>vh(e,p1);let wd=!0,Ur,Zr;const m1=e=>{if(wd){Ur=new Int32Array(512),Zr=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(Ii(oh,e.lens,0,288,Ur,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;Ii(rh,e.lens,0,32,Zr,0,e.work,{bits:5}),wd=!1}e.lencode=Ur,e.lenbits=9,e.distcode=Zr,e.distbits=5},_h=(e,t,n,s)=>{let i;const a=e.state;return a.window===null&&(a.wsize=1<<a.wbits,a.wnext=0,a.whave=0,a.window=new Uint8Array(a.wsize)),s>=a.wsize?(a.window.set(t.subarray(n-a.wsize,n),0),a.wnext=0,a.whave=a.wsize):(i=a.wsize-a.wnext,i>s&&(i=s),a.window.set(t.subarray(n-s,n-s+i),a.wnext),s-=i,s?(a.window.set(t.subarray(n-s,n),0),a.wnext=s,a.whave=a.wsize):(a.wnext+=i,a.wnext===a.wsize&&(a.wnext=0),a.whave<a.wsize&&(a.whave+=i))),0},g1=(e,t)=>{let n,s,i,a,o,r,c,l,d,f,h,p,g,x,b=0,E,I,R,y,C,$,S,P;const M=new Uint8Array(4);let A,T;const j=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Hs(e)||!e.output||!e.input&&e.avail_in!==0)return fn;n=e.state,n.mode===Fn&&(n.mode=Hr),o=e.next_out,i=e.output,c=e.avail_out,a=e.next_in,s=e.input,r=e.avail_in,l=n.hold,d=n.bits,f=r,h=c,P=Ns;e:for(;;)switch(n.mode){case wr:if(n.wrap===0){n.mode=Hr;break}for(;d<16;){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}if(n.wrap&2&&l===35615){n.wbits===0&&(n.wbits=15),n.check=0,M[0]=l&255,M[1]=l>>>8&255,n.check=wt(n.check,M,2,0),l=0,d=0,n.mode=Jc;break}if(n.head&&(n.head.done=!1),!(n.wrap&1)||(((l&255)<<8)+(l>>8))%31){e.msg="incorrect header check",n.mode=Ke;break}if((l&15)!==Qc){e.msg="unknown compression method",n.mode=Ke;break}if(l>>>=4,d-=4,S=(l&15)+8,n.wbits===0&&(n.wbits=S),S>15||S>n.wbits){e.msg="invalid window size",n.mode=Ke;break}n.dmax=1<<n.wbits,n.flags=0,e.adler=n.check=1,n.mode=l&512?rd:Fn,l=0,d=0;break;case Jc:for(;d<16;){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}if(n.flags=l,(n.flags&255)!==Qc){e.msg="unknown compression method",n.mode=Ke;break}if(n.flags&57344){e.msg="unknown header flags set",n.mode=Ke;break}n.head&&(n.head.text=l>>8&1),n.flags&512&&n.wrap&4&&(M[0]=l&255,M[1]=l>>>8&255,n.check=wt(n.check,M,2,0)),l=0,d=0,n.mode=ed;case ed:for(;d<32;){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}n.head&&(n.head.time=l),n.flags&512&&n.wrap&4&&(M[0]=l&255,M[1]=l>>>8&255,M[2]=l>>>16&255,M[3]=l>>>24&255,n.check=wt(n.check,M,4,0)),l=0,d=0,n.mode=td;case td:for(;d<16;){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}n.head&&(n.head.xflags=l&255,n.head.os=l>>8),n.flags&512&&n.wrap&4&&(M[0]=l&255,M[1]=l>>>8&255,n.check=wt(n.check,M,2,0)),l=0,d=0,n.mode=nd;case nd:if(n.flags&1024){for(;d<16;){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}n.length=l,n.head&&(n.head.extra_len=l),n.flags&512&&n.wrap&4&&(M[0]=l&255,M[1]=l>>>8&255,n.check=wt(n.check,M,2,0)),l=0,d=0}else n.head&&(n.head.extra=null);n.mode=sd;case sd:if(n.flags&1024&&(p=n.length,p>r&&(p=r),p&&(n.head&&(S=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(s.subarray(a,a+p),S)),n.flags&512&&n.wrap&4&&(n.check=wt(n.check,s,p,a)),r-=p,a+=p,n.length-=p),n.length))break e;n.length=0,n.mode=id;case id:if(n.flags&2048){if(r===0)break e;p=0;do S=s[a+p++],n.head&&S&&n.length<65536&&(n.head.name+=String.fromCharCode(S));while(S&&p<r);if(n.flags&512&&n.wrap&4&&(n.check=wt(n.check,s,p,a)),r-=p,a+=p,S)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=ad;case ad:if(n.flags&4096){if(r===0)break e;p=0;do S=s[a+p++],n.head&&S&&n.length<65536&&(n.head.comment+=String.fromCharCode(S));while(S&&p<r);if(n.flags&512&&n.wrap&4&&(n.check=wt(n.check,s,p,a)),r-=p,a+=p,S)break e}else n.head&&(n.head.comment=null);n.mode=od;case od:if(n.flags&512){for(;d<16;){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}if(n.wrap&4&&l!==(n.check&65535)){e.msg="header crc mismatch",n.mode=Ke;break}l=0,d=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=Fn;break;case rd:for(;d<32;){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}e.adler=n.check=yd(l),l=0,d=0,n.mode=ur;case ur:if(n.havedict===0)return e.next_out=o,e.avail_out=c,e.next_in=a,e.avail_in=r,n.hold=l,n.bits=d,c1;e.adler=n.check=1,n.mode=Fn;case Fn:if(t===r1||t===Go)break e;case Hr:if(n.last){l>>>=d&7,d-=d&7,n.mode=Br;break}for(;d<3;){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}switch(n.last=l&1,l>>>=1,d-=1,l&3){case 0:n.mode=ld;break;case 1:if(m1(n),n.mode=Vo,t===Go){l>>>=2,d-=2;break e}break;case 2:n.mode=dd;break;case 3:e.msg="invalid block type",n.mode=Ke}l>>>=2,d-=2;break;case ld:for(l>>>=d&7,d-=d&7;d<32;){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}if((l&65535)!==(l>>>16^65535)){e.msg="invalid stored block lengths",n.mode=Ke;break}if(n.length=l&65535,l=0,d=0,n.mode=jr,t===Go)break e;case jr:n.mode=cd;case cd:if(p=n.length,p){if(p>r&&(p=r),p>c&&(p=c),p===0)break e;i.set(s.subarray(a,a+p),o),r-=p,a+=p,c-=p,o+=p,n.length-=p;break}n.mode=Fn;break;case dd:for(;d<14;){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}if(n.nlen=(l&31)+257,l>>>=5,d-=5,n.ndist=(l&31)+1,l>>>=5,d-=5,n.ncode=(l&15)+4,l>>>=4,d-=4,n.nlen>286||n.ndist>30){e.msg="too many length or distance symbols",n.mode=Ke;break}n.have=0,n.mode=ud;case ud:for(;n.have<n.ncode;){for(;d<3;){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}n.lens[j[n.have++]]=l&7,l>>>=3,d-=3}for(;n.have<19;)n.lens[j[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,A={bits:n.lenbits},P=Ii(o1,n.lens,0,19,n.lencode,0,n.work,A),n.lenbits=A.bits,P){e.msg="invalid code lengths set",n.mode=Ke;break}n.have=0,n.mode=hd;case hd:for(;n.have<n.nlen+n.ndist;){for(;b=n.lencode[l&(1<<n.lenbits)-1],E=b>>>24,I=b>>>16&255,R=b&65535,!(E<=d);){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}if(R<16)l>>>=E,d-=E,n.lens[n.have++]=R;else{if(R===16){for(T=E+2;d<T;){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}if(l>>>=E,d-=E,n.have===0){e.msg="invalid bit length repeat",n.mode=Ke;break}S=n.lens[n.have-1],p=3+(l&3),l>>>=2,d-=2}else if(R===17){for(T=E+3;d<T;){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}l>>>=E,d-=E,S=0,p=3+(l&7),l>>>=3,d-=3}else{for(T=E+7;d<T;){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}l>>>=E,d-=E,S=0,p=11+(l&127),l>>>=7,d-=7}if(n.have+p>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=Ke;break}for(;p--;)n.lens[n.have++]=S}}if(n.mode===Ke)break;if(n.lens[256]===0){e.msg="invalid code -- missing end-of-block",n.mode=Ke;break}if(n.lenbits=9,A={bits:n.lenbits},P=Ii(oh,n.lens,0,n.nlen,n.lencode,0,n.work,A),n.lenbits=A.bits,P){e.msg="invalid literal/lengths set",n.mode=Ke;break}if(n.distbits=6,n.distcode=n.distdyn,A={bits:n.distbits},P=Ii(rh,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,A),n.distbits=A.bits,P){e.msg="invalid distances set",n.mode=Ke;break}if(n.mode=Vo,t===Go)break e;case Vo:n.mode=Xo;case Xo:if(r>=6&&c>=258){e.next_out=o,e.avail_out=c,e.next_in=a,e.avail_in=r,n.hold=l,n.bits=d,e1(e,h),o=e.next_out,i=e.output,c=e.avail_out,a=e.next_in,s=e.input,r=e.avail_in,l=n.hold,d=n.bits,n.mode===Fn&&(n.back=-1);break}for(n.back=0;b=n.lencode[l&(1<<n.lenbits)-1],E=b>>>24,I=b>>>16&255,R=b&65535,!(E<=d);){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}if(I&&(I&240)===0){for(y=E,C=I,$=R;b=n.lencode[$+((l&(1<<y+C)-1)>>y)],E=b>>>24,I=b>>>16&255,R=b&65535,!(y+E<=d);){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}l>>>=y,d-=y,n.back+=y}if(l>>>=E,d-=E,n.back+=E,n.length=R,I===0){n.mode=md;break}if(I&32){n.back=-1,n.mode=Fn;break}if(I&64){e.msg="invalid literal/length code",n.mode=Ke;break}n.extra=I&15,n.mode=fd;case fd:if(n.extra){for(T=n.extra;d<T;){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}n.length+=l&(1<<n.extra)-1,l>>>=n.extra,d-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=pd;case pd:for(;b=n.distcode[l&(1<<n.distbits)-1],E=b>>>24,I=b>>>16&255,R=b&65535,!(E<=d);){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}if((I&240)===0){for(y=E,C=I,$=R;b=n.distcode[$+((l&(1<<y+C)-1)>>y)],E=b>>>24,I=b>>>16&255,R=b&65535,!(y+E<=d);){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}l>>>=y,d-=y,n.back+=y}if(l>>>=E,d-=E,n.back+=E,I&64){e.msg="invalid distance code",n.mode=Ke;break}n.offset=R,n.extra=I&15,n.mode=vd;case vd:if(n.extra){for(T=n.extra;d<T;){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}n.offset+=l&(1<<n.extra)-1,l>>>=n.extra,d-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=Ke;break}n.mode=_d;case _d:if(c===0)break e;if(p=h-c,n.offset>p){if(p=n.offset-p,p>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=Ke;break}p>n.wnext?(p-=n.wnext,g=n.wsize-p):g=n.wnext-p,p>n.length&&(p=n.length),x=n.window}else x=i,g=o-n.offset,p=n.length;p>c&&(p=c),c-=p,n.length-=p;do i[o++]=x[g++];while(--p);n.length===0&&(n.mode=Xo);break;case md:if(c===0)break e;i[o++]=n.length,c--,n.mode=Xo;break;case Br:if(n.wrap){for(;d<32;){if(r===0)break e;r--,l|=s[a++]<<d,d+=8}if(h-=c,e.total_out+=h,n.total+=h,n.wrap&4&&h&&(e.adler=n.check=n.flags?wt(n.check,i,h,o-h):Bi(n.check,i,h,o-h)),h=c,n.wrap&4&&(n.flags?l:yd(l))!==n.check){e.msg="incorrect data check",n.mode=Ke;break}l=0,d=0}n.mode=gd;case gd:if(n.wrap&&n.flags){for(;d<32;){if(r===0)break e;r--,l+=s[a++]<<d,d+=8}if(n.wrap&4&&l!==(n.total&4294967295)){e.msg="incorrect length check",n.mode=Ke;break}l=0,d=0}n.mode=bd;case bd:P=l1;break e;case Ke:P=lh;break e;case dh:return ch;case uh:default:return fn}return e.next_out=o,e.avail_out=c,e.next_in=a,e.avail_in=r,n.hold=l,n.bits=d,(n.wsize||h!==e.avail_out&&n.mode<Ke&&(n.mode<Br||t!==qc))&&_h(e,e.output,e.next_out,h-e.avail_out),f-=e.avail_in,h-=e.avail_out,e.total_in+=f,e.total_out+=h,n.total+=h,n.wrap&4&&h&&(e.adler=n.check=n.flags?wt(n.check,i,h,e.next_out-h):Bi(n.check,i,h,e.next_out-h)),e.data_type=n.bits+(n.last?64:0)+(n.mode===Fn?128:0)+(n.mode===Vo||n.mode===jr?256:0),(f===0&&h===0||t===qc)&&P===Ns&&(P=d1),P},b1=e=>{if(Hs(e))return fn;let t=e.state;return t.window&&(t.window=null),e.state=null,Ns},y1=(e,t)=>{if(Hs(e))return fn;const n=e.state;return(n.wrap&2)===0?fn:(n.head=t,t.done=!1,Ns)},w1=(e,t)=>{const n=t.length;let s,i,a;return Hs(e)||(s=e.state,s.wrap!==0&&s.mode!==ur)?fn:s.mode===ur&&(i=1,i=Bi(i,t,n,0),i!==s.check)?lh:(a=_h(e,t,n,n),a?(s.mode=dh,ch):(s.havedict=1,Ns))};var x1=fh,k1=ph,M1=hh,S1=_1,E1=vh,C1=g1,P1=b1,A1=y1,T1=w1,R1="pako inflate (from Nodeca project)",Hn={inflateReset:x1,inflateReset2:k1,inflateResetKeep:M1,inflateInit:S1,inflateInit2:E1,inflate:C1,inflateEnd:P1,inflateGetHeader:A1,inflateSetDictionary:T1,inflateInfo:R1};function D1(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var z1=D1;const mh=Object.prototype.toString,{Z_NO_FLUSH:I1,Z_FINISH:L1,Z_OK:Yi,Z_STREAM_END:Yr,Z_NEED_DICT:Gr,Z_STREAM_ERROR:O1,Z_DATA_ERROR:xd,Z_MEM_ERROR:F1}=Do;function Lo(e){this.options=yr.assign({chunkSize:1024*64,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,t.windowBits===0&&(t.windowBits=-15)),t.windowBits>=0&&t.windowBits<16&&!(e&&e.windowBits)&&(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&(t.windowBits&15)===0&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new ih,this.strm.avail_out=0;let n=Hn.inflateInit2(this.strm,t.windowBits);if(n!==Yi)throw new Error(Os[n]);if(this.header=new z1,Hn.inflateGetHeader(this.strm,this.header),t.dictionary&&(typeof t.dictionary=="string"?t.dictionary=Zi.string2buf(t.dictionary):mh.call(t.dictionary)==="[object ArrayBuffer]"&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(n=Hn.inflateSetDictionary(this.strm,t.dictionary),n!==Yi)))throw new Error(Os[n])}Lo.prototype.push=function(e,t){const n=this.strm,s=this.options.chunkSize,i=this.options.dictionary;let a,o,r;if(this.ended)return!1;for(t===~~t?o=t:o=t===!0?L1:I1,mh.call(e)==="[object ArrayBuffer]"?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;){for(n.avail_out===0&&(n.output=new Uint8Array(s),n.next_out=0,n.avail_out=s),a=Hn.inflate(n,o),a===Gr&&i&&(a=Hn.inflateSetDictionary(n,i),a===Yi?a=Hn.inflate(n,o):a===xd&&(a=Gr));n.avail_in>0&&a===Yr&&n.state.wrap>0&&e[n.next_in]!==0;)Hn.inflateReset(n),a=Hn.inflate(n,o);switch(a){case O1:case xd:case Gr:case F1:return this.onEnd(a),this.ended=!0,!1}if(r=n.avail_out,n.next_out&&(n.avail_out===0||a===Yr))if(this.options.to==="string"){let c=Zi.utf8border(n.output,n.next_out),l=n.next_out-c,d=Zi.buf2string(n.output,c);n.next_out=l,n.avail_out=s-l,l&&n.output.set(n.output.subarray(c,c+l),0),this.onData(d)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(!(a===Yi&&r===0)){if(a===Yr)return a=Hn.inflateEnd(this.strm),this.onEnd(a),this.ended=!0,!0;if(n.avail_in===0)break}}return!0};Lo.prototype.onData=function(e){this.chunks.push(e)};Lo.prototype.onEnd=function(e){e===Yi&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=yr.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};function Ql(e,t){const n=new Lo(t);if(n.push(e),n.err)throw n.msg||Os[n.err];return n.result}function N1(e,t){return t=t||{},t.raw=!0,Ql(e,t)}var $1=Lo,H1=Ql,j1=N1,B1=Ql,U1={Inflate:$1,inflate:H1,inflateRaw:j1,ungzip:B1};const{Deflate:Z1,deflate:Y1,deflateRaw:G1,gzip:V1}=Qv,{Inflate:X1,inflate:W1,inflateRaw:K1,ungzip:q1}=U1;var Q1=Z1,J1=Y1,e_=G1,t_=V1,n_=X1,s_=W1,i_=K1,a_=q1,o_=Do,r_={Deflate:Q1,deflate:J1,deflateRaw:e_,gzip:t_,Inflate:n_,inflate:s_,inflateRaw:i_,ungzip:a_,constants:o_};const l_={uchar:"uint8","unsigned char":"uint8",uint8:"uint8",uint8_t:"uint8",char:"int8","signed char":"int8",int8:"int8",int8_t:"int8",ushort:"uint16","unsigned short":"uint16",uint16:"uint16",uint16_t:"uint16",short:"int16","signed short":"int16",int16:"int16",int16_t:"int16",uint:"uint32","unsigned int":"uint32",uint32:"uint32",uint32_t:"uint32",int:"int32","signed int":"int32",int32:"int32",int32_t:"int32",float:"float32",double:"float64"};class c_{static parse(t){const n=new Uint8Array(t),{header:s,dataOffset:i}=this._parseHeader(n),a=t.slice(i);let o;if(s.encoding==="gzip")o=this._decodeGzip(a);else if(s.encoding==="raw")o=a;else throw new Error(`ì§ìíì§ ìë ì¸ì½ë©: ${s.encoding}`);const r=this._toTypedArray(o,s.type);return console.log("NRRD ë¡ë© ìë£:",{sizes:s.sizes,type:s.type,encoding:s.encoding,spacing:s.spacing,dataLength:r.length}),{header:s,data:r}}static _parseHeader(t){let n=0,s=!1;for(let o=0;o<t.length-1;o++)if(t[o]===10){if(s){n=o+1;break}s=!0}else t[o]!==13&&(s=!1);const i=new TextDecoder().decode(t.slice(0,n));return{header:this._parseHeaderText(i),dataOffset:n}}static _parseHeaderText(t){const n={dimension:3,sizes:[1,1,1],type:"uint8",encoding:"raw",spacing:[1,1,1],spaceDirections:null,spaceOrigin:[0,0,0]},s=t.split(`
`);for(const i of s){const a=i.trim();if(!a||a.startsWith("#"))continue;const o=a.indexOf(":");if(o===-1)continue;const r=a.slice(0,o).trim().toLowerCase(),c=a.slice(o+1).trim();switch(r){case"dimension":n.dimension=parseInt(c);break;case"sizes":n.sizes=c.split(/\s+/).map(Number);break;case"type":n.type=l_[c.toLowerCase()]||"uint8";break;case"encoding":n.encoding=c.toLowerCase();break;case"spacings":case"spacing":n.spacing=c.split(/\s+/).map(Number);break;case"space directions":n.spaceDirections=this._parseSpaceDirections(c),n.spaceDirections&&(n.spacing=n.spaceDirections.map(l=>l?Math.sqrt(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]):1));break;case"space origin":{const l=c.match(/\(([-\d.e+]+),([-\d.e+]+),([-\d.e+]+)\)/);l&&(n.spaceOrigin=[parseFloat(l[1]),parseFloat(l[2]),parseFloat(l[3])]);break}}}return n}static _parseSpaceDirections(t){const n=[],s=/\(([-\d.e+]+),([-\d.e+]+),([-\d.e+]+)\)|none/g;let i;for(;(i=s.exec(t))!==null;)i[0]==="none"?n.push(null):n.push([parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3])]);return n.length>0?n:null}static _decodeGzip(t){try{return r_.inflate(new Uint8Array(t)).buffer}catch(n){throw new Error(`Gzip ëì½ë© ì¤í¨: ${n.message}`)}}static _toTypedArray(t,n){const i={uint8:Uint8Array,int8:Int8Array,uint16:Uint16Array,int16:Int16Array,uint32:Uint32Array,int32:Int32Array,float32:Float32Array,float64:Float64Array}[n]||Uint8Array;return new i(t)}}function Jl(e){if(e.length===0)return;const t=new mn;e.forEach(i=>{i.geometry.computeBoundingBox(),t.expandByObject(i)});const n=t.getCenter(new Y);if(n.lengthSq()<.001)return;const s=new fi().makeTranslation(-n.x,-n.y,-n.z);e.forEach(i=>{i.geometry.applyMatrix4(s),i.geometry.computeBoundingBox(),i.geometry.computeVertexNormals()})}const yn={},It={};let hr=!1;const Vr={L4:13421755,L5:12307643,disc:14522726},d_=new Zl;async function u_(){const e=H.manager;if(!e)return;F.statusMessage="Loading sample models...";const t=[{name:"L4",url:"/stl/L4.stl",color:Vr.L4},{name:"L5",url:"/stl/L5.stl",color:Vr.L5},{name:"disc",url:"/stl/disc.stl",color:Vr.disc}];for(const a of t)try{const o=await e.loadSTL(a.url,a.name,a.color);H.addModel(a.name,o)}catch(o){console.error(`STL ë¡ë ì¤í¨: ${a.name}`,o)}const n=H.models.length;if(n===0)return;const s=H.models.map(a=>a.mesh);Jl(s),F.statusMessage="ë³µìí ì¤...",await Oo();const i=Object.values(It);i.length>0&&e.focusOnAllMeshes(i),F.statusMessage=`${n}ê° ëª¨ë¸ ë¡ë ìë£`}async function gh(e){const t=H.manager;if(!t)return;F.statusMessage="Loading STL files...";for(const a of Array.from(e))try{const o=a.name.replace(/\.[^/.]+$/,""),r=await a.arrayBuffer(),c=d_.parse(r);c.computeVertexNormals(),Yl(c);const l=new Pl({color:13421772,roughness:.6,metalness:.1,transparent:!1,opacity:1,depthWrite:!0,side:wn}),d=new W(c,l);d.name=o,d.castShadow=!0,d.receiveShadow=!0,t.scene.add(d),H.addModel(o,d)}catch(o){console.error(`STL ë¡ë ì¤í¨: ${a.name}`,o)}const n=H.models.length;if(n===0)return;const s=H.models.map(a=>a.mesh);Jl(s),F.statusMessage="ë³µìí ì¤...",await Oo();const i=Object.values(It);i.length>0&&t.focusOnAllMeshes(i),F.statusMessage=`${n}ê° ëª¨ë¸ ë¡ë ìë£`}async function h_(e,t={}){const n=H.manager;if(n){F.statusMessage="Loading NRRD file...";try{const s=await e.arrayBuffer(),i=c_.parse(s),a=e.name.replace(/\.[^/.]+$/,"");H.clearAll(),Object.keys(yn).forEach(f=>delete yn[f]),Object.keys(It).forEach(f=>{n.scene.remove(It[f]),It[f].geometry.dispose(),It[f].material.dispose(),delete It[f]});const o=t.resolution??64,r=new Ou(o);r.fromNRRD(i,t.threshold??200);const c=r.toMesh();if(!c){console.error("NRRD â ë©ì¬ ë³í ì¤í¨");return}const l=new ss({color:13421755,flatShading:!1,side:wn}),d=new W(c,l);d.name=a,n.scene.add(d),yn[a]=r,It[a]=d,H.addModel(a,d),n.focusOnMesh(d),hr=!0,F.statusMessage=`NRRD ë¡ë ìë£: ${a}`}catch(s){console.error("NRRD ë¡ë ì¤í¨:",s),F.statusMessage="NRRD ë¡ë ì¤í¨"}}}async function Oo(e=64){if(hr)return;const t=H.manager;if(!t)return;F.statusMessage="Initializing voxels...";const n=H.models.filter(s=>s.mesh.visible);if(n.length!==0){for(const s of n){const{name:i,mesh:a}=s,o=new Ou(e);o.fromMesh(a);const r=o.toMesh();if(!r)continue;const c=new ss({color:a.material.color??new ni(13421772),flatShading:!1,side:wn}),l=new W(r,c);l.name=`voxel_${i}`,t.scene.add(l),a.visible=!1,yn[i]=o,It[i]=l}hr=!0,zt.setVoxelGrids(yn),F.statusMessage="Voxel initialization complete"}}function f_(e){const t=e.toLowerCase();return t.includes("disc")||t.includes("ivd")?14522726:t.includes("sacrum")||t.includes("s1")?12303274:t.match(/l\d/)?13421755:t.match(/c\d/)?11193531:t.match(/t\d/)?12307660:13421772}function p_(e){const t=H.manager;if(!t)return;const n=new en,s=e.vertices.length,i=new Float32Array(s*3);for(let d=0;d<s;d++)i[d*3]=e.vertices[d][0],i[d*3+1]=e.vertices[d][1],i[d*3+2]=e.vertices[d][2];n.setAttribute("position",new Lt(i,3));const a=e.faces.length,o=new Uint32Array(a*3);for(let d=0;d<a;d++)o[d*3]=e.faces[d][0],o[d*3+1]=e.faces[d][1],o[d*3+2]=e.faces[d][2];n.setIndex(new Lt(o,1)),n.computeVertexNormals(),Yl(n);const r=e.color?parseInt(e.color.replace("#",""),16):f_(e.name),c=new Pl({color:r,roughness:.6,metalness:.1,transparent:!1,opacity:1,depthWrite:!0,side:wn}),l=new W(n,c);l.name=e.name,l.castShadow=!0,l.receiveShadow=!0,t.scene.add(l),H.addModel(e.name,l)}function v_(){const e=H.manager;e&&(Object.entries(It).forEach(([t,n])=>{e.scene.remove(n),n.geometry.dispose(),n.material.dispose()}),Object.keys(yn).forEach(t=>delete yn[t]),Object.keys(It).forEach(t=>delete It[t]),H.clearAll(),zt.clear(),hr=!1,F.statusMessage="Ready")}let qt=null;const bh=5e3;async function __(){await Oo(),zt.setVoxelGrids(yn),q.setMode("drill"),y_(),F.statusMessage="Drill mode: Click to drill"}function m_(){q.reset(),qt&&(qt.visible=!1)}function g_(e){if(q.mode!=="drill"||!qt)return;const t=q.drillRadius;let n=0;const s=new fi;for(const i of Object.values(yn)){const a=i.previewDrill(e,t),o=i.cellSize;for(const r of a){if(n>=bh)break;const c=i.gridToWorld(r.x,r.y,r.z);s.makeScale(o*.98,o*.98,o*.98),s.setPosition(c.x,c.y,c.z),qt.setMatrixAt(n,s),n++}}qt.count=n,qt.instanceMatrix.needsUpdate=!0,qt.visible=n>0}function b_(e){if(q.mode!=="drill")return;const t=q.drillRadius;if(!H.manager)return;zt.push("drill");let s=!1;for(const[i,a]of Object.entries(yn))if(a.drillWithSphere(e,t)>0){s=!0;const r=a.toMesh(),c=It[i];c&&r&&(c.geometry.dispose(),c.geometry=r)}s&&(F.statusMessage=`Drilled at radius ${t.toFixed(1)} mm`)}function y_(){const e=H.manager;if(!e||qt)return;const t=new St(1,1,1),n=new ii({color:16729156,transparent:!0,opacity:.35,depthTest:!1});qt=new Al(t,n,bh),qt.count=0,qt.visible=!1,qt.renderOrder=999,e.scene.add(qt)}var Sa,Ea,Ca,Pa,Aa,Ta,Ra,Da,za,Ia,La,Oa,Fa,Na,$a,Ha,ja,Ba,Ua,Za,Ya,Ga,Va,Xa,Wa,Ka,qa,Qa,Ja,eo,to,no,so,io,ao;class w_{constructor(){L(this,Sa,z(null));L(this,Ea,z(null));L(this,Ca,z("fem"));L(this,Pa,z(Qt({})));L(this,Aa,z(0));L(this,Ta,z(0));L(this,Ra,z(!1));L(this,Da,z(0));L(this,za,z(""));L(this,Ia,z(!1));L(this,La,z("displacement"));L(this,Oa,z("magnitude"));L(this,Fa,z("jet"));L(this,Na,z(10));L(this,$a,z(3));L(this,Ha,z(1));L(this,ja,z("points"));L(this,Ba,z(!1));L(this,Ua,z(0));L(this,Za,z(1));L(this,Ya,z(!1));L(this,Ga,z(0));L(this,Va,z(1));L(this,Xa,z(!1));L(this,Wa,z("x"));L(this,Ka,z(0));L(this,qa,z(!1));L(this,Qa,z(!1));L(this,Ja,z(null));L(this,eo,z(null));L(this,to,z(0));L(this,no,z(0));L(this,so,z(0));L(this,io,z(0));L(this,ao,z(1))}get preProcessor(){return u(v(this,Sa))}set preProcessor(t){k(v(this,Sa),t,!0)}get postProcessor(){return u(v(this,Ea))}set postProcessor(t){k(v(this,Ea),t,!0)}get method(){return u(v(this,Ca))}set method(t){k(v(this,Ca),t,!0)}get solverAssignments(){return u(v(this,Pa))}set solverAssignments(t){k(v(this,Pa),t,!0)}get bcCount(){return u(v(this,Aa))}set bcCount(t){k(v(this,Aa),t,!0)}get materialCount(){return u(v(this,Ta))}set materialCount(t){k(v(this,Ta),t,!0)}get isRunning(){return u(v(this,Ra))}set isRunning(t){k(v(this,Ra),t,!0)}get progress(){return u(v(this,Da))}set progress(t){k(v(this,Da),t,!0)}get progressMessage(){return u(v(this,za))}set progressMessage(t){k(v(this,za),t,!0)}get hasResult(){return u(v(this,Ia))}set hasResult(t){k(v(this,Ia),t,!0)}get postMode(){return u(v(this,La))}set postMode(t){k(v(this,La),t,!0)}get component(){return u(v(this,Oa))}set component(t){k(v(this,Oa),t,!0)}get colormap(){return u(v(this,Fa))}set colormap(t){k(v(this,Fa),t,!0)}get dispScale(){return u(v(this,Na))}set dispScale(t){k(v(this,Na),t,!0)}get particleSize(){return u(v(this,$a))}set particleSize(t){k(v(this,$a),t,!0)}get opacity(){return u(v(this,Ha))}set opacity(t){k(v(this,Ha),t,!0)}get representation(){return u(v(this,ja))}set representation(t){k(v(this,ja),t,!0)}get useCustomRange(){return u(v(this,Ba))}set useCustomRange(t){k(v(this,Ba),t,!0)}get rangeMin(){return u(v(this,Ua))}set rangeMin(t){k(v(this,Ua),t,!0)}get rangeMax(){return u(v(this,Za))}set rangeMax(t){k(v(this,Za),t,!0)}get thresholdEnabled(){return u(v(this,Ya))}set thresholdEnabled(t){k(v(this,Ya),t,!0)}get thresholdLower(){return u(v(this,Ga))}set thresholdLower(t){k(v(this,Ga),t,!0)}get thresholdUpper(){return u(v(this,Va))}set thresholdUpper(t){k(v(this,Va),t,!0)}get clipEnabled(){return u(v(this,Xa))}set clipEnabled(t){k(v(this,Xa),t,!0)}get clipAxis(){return u(v(this,Wa))}set clipAxis(t){k(v(this,Wa),t,!0)}get clipPosition(){return u(v(this,Ka))}set clipPosition(t){k(v(this,Ka),t,!0)}get clipInvert(){return u(v(this,qa))}set clipInvert(t){k(v(this,qa),t,!0)}get hasPreOpResult(){return u(v(this,Qa))}set hasPreOpResult(t){k(v(this,Qa),t,!0)}get forceBCOrigin(){return u(v(this,Ja))}set forceBCOrigin(t){k(v(this,Ja),t,!0)}get lastError(){return u(v(this,eo))}set lastError(t){k(v(this,eo),t,!0)}get elapsedMs(){return u(v(this,to))}set elapsedMs(t){k(v(this,to),t,!0)}get canRun(){return this.bcCount>0&&!this.isRunning&&this.preProcessor!==null}get validationErrors(){var s;const t=[];this.preProcessor||t.push("ì ì²ë¦¬ê¸° ë¯¸ì´ê¸°í (PreProcess í­ì ë¨¼ì  ì¤í)"),this.bcCount===0&&t.push("ê²½ê³ì¡°ê±´(BC)ì´ ì¤ì ëì§ ìì");const n=((s=this.preProcessor)==null?void 0:s.boundaryConditions.some(i=>i.type==="fixed"))??!1;return this.bcCount>0&&!n&&t.push("ê³ ì  ê²½ê³ì¡°ê±´(Fixed BC)ì´ ìì"),t}get visibleCount(){return u(v(this,no))}set visibleCount(t){k(v(this,no),t,!0)}get totalCount(){return u(v(this,so))}set totalCount(t){k(v(this,so),t,!0)}get dataMin(){return u(v(this,io))}set dataMin(t){k(v(this,io),t,!0)}get dataMax(){return u(v(this,ao))}set dataMax(t){k(v(this,ao),t,!0)}updateBCCount(){var t;this.bcCount=((t=this.preProcessor)==null?void 0:t.boundaryConditions.length)??0}updateMaterialCount(){var t;this.materialCount=Object.keys(((t=this.preProcessor)==null?void 0:t.materialAssignments)??{}).length}syncFromPostProcessor(){var n,s;const t=this.postProcessor;t&&(this.visibleCount=t.visibleCount,this.totalCount=((s=(n=t.data)==null?void 0:n.displacements)==null?void 0:s.length)??0,this.dataMin=t.stats.currentMin,this.dataMax=t.stats.currentMax)}}Sa=new WeakMap,Ea=new WeakMap,Ca=new WeakMap,Pa=new WeakMap,Aa=new WeakMap,Ta=new WeakMap,Ra=new WeakMap,Da=new WeakMap,za=new WeakMap,Ia=new WeakMap,La=new WeakMap,Oa=new WeakMap,Fa=new WeakMap,Na=new WeakMap,$a=new WeakMap,Ha=new WeakMap,ja=new WeakMap,Ba=new WeakMap,Ua=new WeakMap,Za=new WeakMap,Ya=new WeakMap,Ga=new WeakMap,Va=new WeakMap,Xa=new WeakMap,Wa=new WeakMap,Ka=new WeakMap,qa=new WeakMap,Qa=new WeakMap,Ja=new WeakMap,eo=new WeakMap,to=new WeakMap,no=new WeakMap,so=new WeakMap,io=new WeakMap,ao=new WeakMap;const w=new w_,Xr=[{id:"M5x40",label:"M5Ã40",category:"screw",url:"/stl/implants/screws/M5x40.stl",material:"titanium",description:"Ã5mm Â· L40mm"},{id:"M6x45",label:"M6Ã45",category:"screw",url:"/stl/implants/screws/M6x45.stl",material:"titanium",description:"Ã6mm Â· L45mm"},{id:"M6x50",label:"M6Ã50",category:"screw",url:"/stl/implants/screws/M6x50.stl",material:"titanium",description:"Ã6mm Â· L50mm"},{id:"M7x50",label:"M7Ã50",category:"screw",url:"/stl/implants/screws/M7x50.stl",material:"titanium",description:"Ã7mm Â· L50mm"},{id:"M7x55",label:"M7Ã55",category:"screw",url:"/stl/implants/screws/M7x55.stl",material:"titanium",description:"Ã7mm Â· L55mm"},{id:"cage_S",label:"Cage S",category:"cage",url:"/stl/implants/cages/cage_S.stl",material:"peek",description:"22Ã8mm",heightMm:8},{id:"cage_M",label:"Cage M",category:"cage",url:"/stl/implants/cages/cage_M.stl",material:"peek",description:"26Ã10mm",heightMm:10},{id:"cage_L",label:"Cage L",category:"cage",url:"/stl/implants/cages/cage_L.stl",material:"peek",description:"26Ã12mm",heightMm:12},{id:"cage_XL",label:"Cage XL",category:"cage",url:"/stl/implants/cages/cage_XL.stl",material:"peek",description:"32Ã14mm",heightMm:14},{id:"rod_40",label:"Rod 40",category:"rod",url:"/stl/implants/rods/rod_40.stl",material:"titanium",description:"Ã5.5mm Â· L40mm"},{id:"rod_50",label:"Rod 50",category:"rod",url:"/stl/implants/rods/rod_50.stl",material:"titanium",description:"Ã5.5mm Â· L50mm"},{id:"rod_60",label:"Rod 60",category:"rod",url:"/stl/implants/rods/rod_60.stl",material:"titanium",description:"Ã5.5mm Â· L60mm"},{id:"rod_80",label:"Rod 80",category:"rod",url:"/stl/implants/rods/rod_80.stl",material:"titanium",description:"Ã5.5mm Â· L80mm"},{id:"rod_100",label:"Rod 100",category:"rod",url:"/stl/implants/rods/rod_100.stl",material:"titanium",description:"Ã5.5mm Â· L100mm"}],kd={screw:Xr.filter(e=>e.category==="screw"),cage:Xr.filter(e=>e.category==="cage"),rod:Xr.filter(e=>e.category==="rod")};function x_(e){yh(),q.enterImplantPlaceMode(e.url,e.id,e.material,e.category,e.heightMm),F.statusMessage=`ë°°ì¹ ëª¨ë: ${e.label} â ë¼ íë©´ì í´ë¦­íì¸ì (Esc ì·¨ì)`,F.toast(`${e.label} ì íë¨. ë·°í¬í¸ì ë¼ íë©´ì í´ë¦­í´ ë°°ì¹íì¸ì.`,"info")}async function k_(e,t){const n=H.implantManager;if(!n)return;const s=q.pendingImplantUrl,i=q.pendingImplantName,a=q.pendingImplantMat,o=q.pendingImplantCategory,r=q.pendingImplantHeightMm;if(!(!s||!i))try{n.boneMeshes=H.models.filter(l=>l.visible).map(l=>l.mesh);const c=await n.loadImplantFromURL(s,i,a,o,r);n.placeImplantAtSurface(c,e,t),F.statusMessage=`${i} ë°°ì¹ ìë£ â í¸ë¤ë¡ ì´ë/íì  ê°ë¥`,F.toast(`${i} ë°°ì¹ë¨`,"success")}catch(c){console.error("ìíëí¸ ë°°ì¹ ì¤í¨:",c),F.toast("ìíëí¸ STL ë¡ë ì¤í¨","error")}}let Rn=null,Li=null;function M_(e,t){const n=H.implantManager;if(!n)return;Rn=e.clone(),Li=t.clone(),n.showEntryMarker(e);const s=q.pendingImplantName??"screw";F.statusMessage=`${s} ì§ìì  ì¤ì  â ì¹´ë©ë¼ë¥¼ ëë ¤ ë°©í¥ì íì¸í í ëì ì í´ë¦­íì¸ì`}async function S_(e){if(!Rn||!Li)return;const t=H.implantManager;if(!t)return;const n=e.clone().sub(Rn);n.length()<.5&&n.copy(Li),n.normalize();const s=q.pendingImplantUrl,i=q.pendingImplantName,a=q.pendingImplantMat,o=q.pendingImplantCategory,r=q.pendingImplantHeightMm;if(!(!s||!i))try{t.boneMeshes=H.models.filter(d=>d.visible).map(d=>d.mesh);const c=await t.loadImplantFromURL(s,i,a,o,r),l=t.implants[c];if(l){l.mesh.position.copy(Rn);const d=new Y(0,1,0),f=new Ut().setFromUnitVectors(d,n);l.mesh.quaternion.copy(f),l.mesh.visible=!0,t.selectImplant(c)}t.hideEntryMarker(),Rn=null,Li=null,F.statusMessage=`${i} ë°°ì¹ ìë£ â í¸ë¤ë¡ ì´ë/íì  ê°ë¥`,F.toast(`${i} ë°°ì¹ë¨`,"success")}catch(c){console.error("ìíëí¸ ë°°ì¹ ì¤í¨:",c),F.toast("ìíëí¸ STL ë¡ë ì¤í¨","error")}}function Md(e){if(!Rn)return;const t=H.implantManager;t&&t.updatePreviewLine(e)}function yh(){Rn=null,Li=null;const e=H.implantManager;e&&e.hideEntryMarker()}function Sd(){return Rn!==null}function E_(){return Rn?Rn.clone():null}function wh(){const e=H.implantManager;if(!e||!e.selectedImplant)return;const t=e.selectedImplant;e.removeImplant(t),F.toast(`${t} ì­ì ë¨`,"info"),F.statusMessage="ìíëí¸ ì­ì ë¨"}function C_(e){const t=H.implantManager;if(!t)return!1;t.boneMeshes=H.models.filter(o=>o.visible).map(o=>o.mesh);const n=t.applyDistraction(e);if(!n)return F.toast("ëì¤í¸ëì ì¡°ê±´ ë¯¸ì¶©ì¡± (ì¼ì´ì§ ëì´ â¤ íì¬ ëì¤í¬ ê³µê°)","warn"),!1;const s=n.deltaH.toFixed(1),i=n.originalGap.toFixed(1),a=n.cageHeight.toFixed(1);return F.toast(`ëì¤í¸ëì ì ì©: ${i}mm â ${a}mm (ìì ì²ì¶ +${s}mm)`,"success"),F.statusMessage=`ì¼ì´ì§ ëì¤í¸ëì ìë£ (+${s}mm)`,!0}function P_(){const e=H.implantManager;if(!e)return;const t=e.implantCount;e.removeAll(),F.toast(`ìíëí¸ ${t}ê° ì ì²´ ì­ì ë¨`,"info"),F.statusMessage="ìíëí¸ ì ì²´ ì­ì ë¨"}function A_(){const e=H.implantManager;return e?Object.entries(e.implants).map(([t,n])=>({name:t,label:t,material:n.material,category:n.category})):[]}var oo,ro,lo,co,uo,ho;class T_{constructor(){L(this,oo,z(null));L(this,ro,z(!1));L(this,lo,z("disconnected"));L(this,co,z(null));L(this,uo,z(0));L(this,ho,z(5))}get client(){return u(v(this,oo))}set client(t){k(v(this,oo),t,!0)}get connected(){return u(v(this,ro))}set connected(t){k(v(this,ro),t,!0)}get status(){return u(v(this,lo))}set status(t){k(v(this,lo),t,!0)}get lastError(){return u(v(this,co))}set lastError(t){k(v(this,co),t,!0)}get reconnectAttempt(){return u(v(this,uo))}set reconnectAttempt(t){k(v(this,uo),t,!0)}get maxReconnect(){return u(v(this,ho))}set maxReconnect(t){k(v(this,ho),t,!0)}setConnected(t){this.connected=t,this.status=t?"connected":"disconnected",t&&(this.lastError=null,this.reconnectAttempt=0)}setError(t){this.lastError=t}setFailed(){this.status="failed",this.connected=!1}}oo=new WeakMap,ro=new WeakMap,lo=new WeakMap,co=new WeakMap,uo=new WeakMap,ho=new WeakMap;const tt=new T_,Gi=new $d;Gi.name="guidelines";let Ed=!1;function R_(e){if(Ed)return;e.add(Gi);const t=tt.client;t&&t.onGuidelineMeshResult(n=>L_(n)),Ed=!0}function D_(e,t="L4",n){var s;(s=tt.client)==null||s.send("get_guideline_meshes",{vertebra_position:e,vertebra_name:t,pedicle_offset:(n==null?void 0:n.pedicle_offset)??15,medial_angle:(n==null?void 0:n.medial_angle)??10,caudal_angle:(n==null?void 0:n.caudal_angle)??0,depth:(n==null?void 0:n.depth)??45,show_trajectory:(n==null?void 0:n.show_trajectory)??!0,show_safe_zone:(n==null?void 0:n.show_safe_zone)??!0,show_depth_marker:(n==null?void 0:n.show_depth_marker)??!0})}function z_(){xh(Gi)}function I_(e,t=!1){const n=new en,s=new Float32Array(e.vertices.length*3);for(let r=0;r<e.vertices.length;r++)s[r*3]=e.vertices[r][0],s[r*3+1]=e.vertices[r][1],s[r*3+2]=e.vertices[r][2];n.setAttribute("position",new Lt(s,3));const i=new Uint32Array(e.faces.length*3);for(let r=0;r<e.faces.length;r++)i[r*3]=e.faces[r][0],i[r*3+1]=e.faces[r][1],i[r*3+2]=e.faces[r][2];n.setIndex(new Lt(i,1)),n.computeVertexNormals();const a=new ss({color:new ni(e.color[0],e.color[1],e.color[2]),specular:new ni(.4,.4,.4),shininess:60,transparent:t,opacity:t?.65:1,side:wn}),o=new W(n,a);return o.name=e.name,o.castShadow=!0,o}function L_(e){xh(Gi);for(const t of e.meshes){const n=I_(t,!0);Gi.add(n)}}function xh(e){for(;e.children.length>0;){const t=e.children[0];t instanceof W&&(t.geometry.dispose(),Array.isArray(t.material)?t.material.forEach(n=>n.dispose()):t.material.dispose()),e.remove(t)}}var O_=ee('<button class="toggle-btn collapsed svelte-c97lwz" title="View ì¤ì ">ð¨ View</button>'),F_=ee('<div class="menu-panel svelte-c97lwz"><div class="menu-header svelte-c97lwz"><span class="menu-title svelte-c97lwz">View</span> <button class="toggle-btn-close svelte-c97lwz" title="ì ê¸°">â²</button></div> <div class="menu-section svelte-c97lwz"><div class="sec-label svelte-c97lwz">Camera</div> <div class="cam-grid svelte-c97lwz"><button class="cam-btn svelte-c97lwz" title="Front">F</button> <button class="cam-btn svelte-c97lwz" title="Back">Bk</button> <button class="cam-btn svelte-c97lwz" title="Top">T</button> <button class="cam-btn svelte-c97lwz" title="Bottom">Bo</button> <button class="cam-btn svelte-c97lwz" title="Left">L</button> <button class="cam-btn svelte-c97lwz" title="Right">R</button> <button class="cam-btn reset svelte-c97lwz" title="Reset Camera">â³</button></div></div> <div class="menu-section svelte-c97lwz"><div class="sec-row svelte-c97lwz"><span class="sec-label-inline svelte-c97lwz">BG</span> <select class="mini-select svelte-c97lwz"><option>Light Gray</option><option>White</option><option>Dark</option><option>Blue Gray</option></select></div> <div class="sec-row svelte-c97lwz" style="margin-top: 4px;"><span class="sec-label-inline svelte-c97lwz">Mode</span> <div class="mode-btns svelte-c97lwz"><button>Solid</button> <button>Wire</button> <button>S+W</button></div></div></div> <div class="menu-section svelte-c97lwz"><div class="slider-row svelte-c97lwz"><span class="slider-label svelte-c97lwz">Opacity</span> <input type="range" min="0.1" max="1.0" step="0.05" class="mini-slider svelte-c97lwz"/> <span class="slider-val svelte-c97lwz"> </span></div> <div class="slider-row svelte-c97lwz"><span class="slider-label svelte-c97lwz">Light</span> <input type="range" min="0.0" max="2.0" step="0.1" class="mini-slider svelte-c97lwz"/> <span class="slider-val svelte-c97lwz"> </span></div></div> <div class="menu-section bottom-section svelte-c97lwz"><label class="check-row svelte-c97lwz"><input type="checkbox" class="svelte-c97lwz"/> <span>Grid</span></label> <label class="check-row svelte-c97lwz"><input type="checkbox" class="svelte-c97lwz"/> <span>Axes</span></label> <button class="screenshot-btn svelte-c97lwz">ð· Screenshot</button></div></div>'),N_=ee('<div class="view-float svelte-c97lwz"><!></div>');function $_(e,t){sn(t,!0);let n=z(!1);function s(S){const P=H.manager;if(!P)return;const M=P.controls.target.clone(),A=P.camera.position.distanceTo(M),j={front:[0,0,A],back:[0,0,-A],top:[0,A,0],bottom:[0,-A,0],left:[-A,0,0],right:[A,0,0]}[S];j&&(P.camera.position.set(M.x+j[0],M.y+j[1],M.z+j[2]),P.camera.lookAt(M),P.controls.update())}function i(){const S=H.manager;S&&H.models.length>0&&S.focusOnMesh(H.models[0].mesh)}function a(S){const P=H.manager;P&&P.renderer.setClearColor(new ni(S))}let o=z(!0),r=z(!0);function c(){k(o,!u(o));const S=H.manager;S&&S.scene.traverse(P=>{P.type==="GridHelper"&&(P.visible=u(o))})}function l(){k(r,!u(r));const S=H.manager;S&&S.scene.traverse(P=>{P.type==="AxesHelper"&&(P.visible=u(r))})}let d=z("solid");function f(S){k(d,S,!0),H.manager&&H.models.forEach(({mesh:M})=>{const A=M.material;A.wireframe=S==="wireframe",S==="solid+wire"?(A.wireframe=!1,p(M),h(M)):p(M)})}function h(S){const P=new ii({color:0,wireframe:!0,transparent:!0,opacity:.15,depthTest:!0}),M=new W(S.geometry,P);M.name="__wireOverlay",M.renderOrder=1,S.add(M)}function p(S){const P=S.getObjectByName("__wireOverlay");P&&(S.remove(P),P.material&&P.material.dispose())}let g=z(1);function x(S){k(g,parseFloat(S.target.value),!0),H.models.forEach(({mesh:P})=>{const M=P.material;M.transparent=u(g)<1,M.opacity=u(g),M.depthWrite=u(g)>=1,M.needsUpdate=!0})}let b=z(.7);function E(S){k(b,parseFloat(S.target.value),!0);const P=H.manager;P&&(P.dirLight.intensity=u(b))}function I(){const S=H.manager;if(!S)return;S.renderer.render(S.scene,S.camera);const P=S.renderer.domElement.toDataURL("image/png"),M=document.createElement("a");M.href=P,M.download=`screenshot_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.png`,M.click()}var R=N_(),y=m(R);{var C=S=>{var P=O_();D("click",P,()=>{k(n,!0)}),K(S,P)},$=S=>{var P=F_(),M=m(P),A=_(m(M),2),T=_(M,2),j=_(m(T),2),ne=m(j),se=_(ne,2),Q=_(se,2),U=_(Q,2),N=_(U,2),oe=_(N,2),ae=_(oe,2),ve=_(T,2),He=m(ve),Ae=_(m(He),2),Ve=m(Ae);Ve.value=Ve.__value="#e8e8e8";var je=_(Ve);je.value=je.__value="#ffffff";var Qe=_(je);Qe.value=Qe.__value="#1a1a1a";var Se=_(Qe);Se.value=Se.__value="#d0d8e0";var Ye=_(He,2),Xe=_(m(Ye),2),ut=m(Xe);let Mt;var G=_(ut,2);let te;var Z=_(G,2);let ie;var re=_(ve,2),pe=m(re),V=_(m(pe),2),J=_(V,2),le=m(J),_e=_(pe,2),be=_(m(_e),2),Ce=_(be,2),Be=m(Ce),at=_(re,2),Ge=m(at),Je=m(Ge),ht=_(Ge,2),ot=m(ht),gt=_(ht,2);he((ft,ce)=>{Mt=Oe(ut,1,"mode-btn svelte-c97lwz",null,Mt,{active:u(d)==="solid"}),te=Oe(G,1,"mode-btn svelte-c97lwz",null,te,{active:u(d)==="wireframe"}),ie=Oe(Z,1,"mode-btn svelte-c97lwz",null,ie,{active:u(d)==="solid+wire"}),_t(V,u(g)),B(le,ft),_t(be,u(b)),B(Be,ce),lr(Je,u(o)),lr(ot,u(r))},[()=>u(g).toFixed(2),()=>u(b).toFixed(1)]),D("click",A,()=>{k(n,!1)}),D("click",ne,()=>s("front")),D("click",se,()=>s("back")),D("click",Q,()=>s("top")),D("click",U,()=>s("bottom")),D("click",N,()=>s("left")),D("click",oe,()=>s("right")),D("click",ae,i),D("change",Ae,ft=>a(ft.target.value)),D("click",ut,()=>f("solid")),D("click",G,()=>f("wireframe")),D("click",Z,()=>f("solid+wire")),D("input",V,x),D("input",be,E),D("change",Je,c),D("change",ot,l),D("click",gt,I),K(S,P)};Me(y,S=>{u(n)?S($,!1):S(C)})}D("pointerdown",R,S=>S.stopPropagation()),K(e,R),an()}Xn(["pointerdown","click","change","input"]);var Rt=zu(()=>H),H_=ee('<div class="canvas-container svelte-19ym8fx"><!></div>');function j_(e,t){sn(t,!1);let n=lu();const s=new si,i=new $t;let a=!1,o=new Y,r=new Y,c=100;Iu(()=>{const f=new Zp(u(n));Rt(Rt().manager=f),f.onBeforeRender=()=>{Rt(Rt().fps=f.fps)},f.start(),R_(f.scene);const h=new s0(f.scene,f.camera,f.renderer,f.controls);Rt(Rt().implantManager=h);const p=new l0(f.scene,f.camera,f.renderer);Rt(Rt().forceArrowHandle=p);const g=f.renderer.domElement;function x(M){const A=g.getBoundingClientRect();return new $t((M.clientX-A.left)/A.width*2-1,-((M.clientY-A.top)/A.height)*2+1)}function b(M){i.copy(x(M)),s.setFromCamera(i,f.camera);const A=[...Rt().models.filter(j=>j.mesh.visible).map(j=>j.mesh),...Object.values(It).filter(j=>j.visible)],T=s.intersectObjects(A,!1);return T.length>0?T[0]:null}function E(M){i.copy(x(M)),s.setFromCamera(i,f.camera);const A=[...Rt().models.filter(j=>j.mesh.visible).map(j=>j.mesh),...Object.values(It).filter(j=>j.visible),...Object.values(h.implants).map(j=>j.mesh)],T=s.intersectObjects(A,!1);return T.length>0?T[0]:null}function I(M,A){const T=x(M),j=new si;j.setFromCamera(T,f.camera);const ne=new Y;ne.setFromMatrixColumn(f.camera.matrixWorld,2).negate();const se=new Cl().setFromNormalAndCoplanarPoint(ne,A),Q=new Y;return j.ray.intersectPlane(se,Q)?Q:null}function R(M){if(q.mode==="implantPlace"&&Sd()){const A=b(M);if(A)Md(A.point);else{const T=E_();if(T){const j=I(M,T);j&&Md(j)}}}if(a){p.updateFromDrag(x(M),o,r,c);return}if(q.mode==="drill"){const A=b(M);A&&g_(A.point)}}function y(M){var A;if(M.button===0){if(q.mode==="implantPlace"){const T=b(M);if(!T||!T.face)return;const j=T.face.normal.clone().transformDirection(T.object.matrixWorld).normalize(),ne=q.pendingImplantCategory;ne==="screw"||ne==="rod"?Sd()?S_(T.point):M_(T.point,j):k_(T.point,j);return}if(q.forceEditMode3D){a=!0,o.setFromMatrixColumn(f.camera.matrixWorld,2).negate(),r.copy(p.getOrigin());const[T,j,ne]=q.forceVector;c=Math.sqrt(T*T+j*j+ne*ne)||100,f.controls.enabled=!1;return}if(q.mode==="none"){const T=E(M);if(T!=null&&T.object.userData.isImplant){const j=T.object.userData.implantName;h.selectImplant(j);return}h.deselectImplant()}if(q.mode==="drill"){const T=b(M);T&&b_(T.point)}if(q.mode==="brush"){const T=b(M);T&&((A=w.preProcessor)==null||A.brushSelectSphere(T.point,q.brushRadius))}}}function C(M){a&&(a=!1,f.controls.enabled=!0)}g.addEventListener("pointermove",R),g.addEventListener("pointerdown",y),g.addEventListener("pointerup",C);function $(M){(M.ctrlKey||M.metaKey)&&M.key==="z"&&!M.shiftKey&&(M.preventDefault(),zt.undo()),(M.ctrlKey||M.metaKey)&&(M.key==="y"||M.key==="z"&&M.shiftKey)&&(M.preventDefault(),zt.redo()),M.key==="Delete"&&wh(),M.key==="Escape"&&(yh(),q.exitImplantPlaceMode(),q.reset())}window.addEventListener("keydown",$);function S(M){M.preventDefault(),M.stopPropagation()}function P(M){var A;M.preventDefault(),M.stopPropagation(),(A=M.dataTransfer)!=null&&A.files&&M.dataTransfer.files.length>0&&gh(M.dataTransfer.files)}return u(n).addEventListener("dragover",S),u(n).addEventListener("drop",P),()=>{g.removeEventListener("pointermove",R),g.removeEventListener("pointerdown",y),g.removeEventListener("pointerup",C),window.removeEventListener("keydown",$),u(n).removeEventListener("dragover",S),u(n).removeEventListener("drop",P),p.dispose(),h.dispose(),Rt(Rt().implantManager=null),Rt(Rt().forceArrowHandle=null),Rt(Rt().manager=null),f.dispose()}}),To();var l=H_(),d=m(l);$_(d,{}),er(l,f=>k(n,f),()=>u(n)),K(e,l),an()}var fo,po,vo,_o,mo,go,bo;class B_{constructor(){L(this,fo,z("idle"));L(this,po,z(0));L(this,vo,z(""));L(this,_o,z(null));L(this,mo,z(null));L(this,go,z(Qt([])));L(this,bo,z(Qt({})))}get step(){return u(v(this,fo))}set step(t){k(v(this,fo),t,!0)}get progress(){return u(v(this,po))}set progress(t){k(v(this,po),t,!0)}get message(){return u(v(this,vo))}set message(t){k(v(this,vo),t,!0)}get error(){return u(v(this,_o))}set error(t){k(v(this,_o),t,!0)}get segmentationPath(){return u(v(this,mo))}set segmentationPath(t){k(v(this,mo),t,!0)}get extractedMeshes(){return u(v(this,go))}set extractedMeshes(t){k(v(this,go),t,!0)}get materialAssignments(){return u(v(this,bo))}set materialAssignments(t){k(v(this,bo),t,!0)}updateProgress(t,n,s){this.step=t,this.progress=n,this.message=s}setError(t){this.step="error",this.error=t}reset(){this.step="idle",this.progress=0,this.message="",this.error=null,this.segmentationPath=null,this.extractedMeshes=[],this.materialAssignments={}}}fo=new WeakMap,po=new WeakMap,vo=new WeakMap,_o=new WeakMap,mo=new WeakMap,go=new WeakMap,bo=new WeakMap;const Fe=new B_;class kh{constructor(t){O(this,"url");O(this,"ws",null);O(this,"connected",!1);O(this,"_onProgress",null);O(this,"_onResult",null);O(this,"_onError",null);O(this,"_onConnect",null);O(this,"_onDisconnect",null);O(this,"_onSegmentResult",null);O(this,"_onMeshesResult",null);O(this,"_onMaterialResult",null);O(this,"_onPipelineStep",null);O(this,"_onPipelineResult",null);O(this,"_onImplantMeshResult",null);O(this,"_onGuidelineMeshResult",null);O(this,"_onCancelled",null);O(this,"_solveTimeout",null);O(this,"_currentRequestId",null);O(this,"solveTimeoutMs",6e5);O(this,"_reconnectTimer",null);O(this,"_reconnectAttempt",0);O(this,"maxReconnect",5);if(!t){const n=window.location;t=`${n.protocol==="https:"?"wss:":"ws:"}//${n.host}/ws`}this.url=t}connect(){if(!(this.ws&&this.ws.readyState<=WebSocket.OPEN)){try{this.ws=new WebSocket(this.url)}catch(t){console.warn("WebSocket ì°ê²° ì¤í¨:",t.message),this._scheduleReconnect();return}this.ws.onopen=()=>{var t;this.connected=!0,this._reconnectAttempt=0,console.log("WebSocket ì°ê²°ë¨:",this.url),(t=this._onConnect)==null||t.call(this)},this.ws.onclose=()=>{var t;this.connected=!1,console.log("WebSocket ì°ê²° í´ì "),(t=this._onDisconnect)==null||t.call(this),this._scheduleReconnect()},this.ws.onerror=()=>{console.warn("WebSocket ìë¬")},this.ws.onmessage=t=>{try{const n=JSON.parse(t.data);this._dispatch(n)}catch(n){console.error("WebSocket ë©ìì§ íì± ì¤í¨:",n)}}}}send(t,n){var s;return!this.ws||this.ws.readyState!==WebSocket.OPEN?(console.warn("WebSocket ë¯¸ì°ê²° â ë©ìì§ ì ì¡ ë¶ê°"),(s=this._onError)==null||s.call(this,{message:"ìë² ë¯¸ì°ê²°"}),!1):(this.ws.send(JSON.stringify({type:t,data:n})),!0)}disconnect(){this._clearSolveTimeout(),this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=null),this.ws&&(this.ws.onclose=null,this.ws.close(),this.ws=null),this.connected=!1}sendAnalysis(t,n){this._currentRequestId=crypto.randomUUID();const s=this.send("run_analysis",{...t,request_id:this._currentRequestId});return s&&this._startSolveTimeout(n??this.solveTimeoutMs),s}cancelAnalysis(){this._currentRequestId&&(this.send("cancel_analysis",{request_id:this._currentRequestId}),this._clearSolveTimeout(),this._currentRequestId=null)}get currentRequestId(){return this._currentRequestId}onProgress(t){this._onProgress=t}onResult(t){this._onResult=t}onError(t){this._onError=t}onConnect(t){this._onConnect=t}onDisconnect(t){this._onDisconnect=t}onSegmentResult(t){this._onSegmentResult=t}onMeshesResult(t){this._onMeshesResult=t}onMaterialResult(t){this._onMaterialResult=t}onPipelineStep(t){this._onPipelineStep=t}onPipelineResult(t){this._onPipelineResult=t}onImplantMeshResult(t){this._onImplantMeshResult=t}onGuidelineMeshResult(t){this._onGuidelineMeshResult=t}onCancelled(t){this._onCancelled=t}_dispatch(t){var n,s,i,a,o,r,c,l,d,f,h;switch(t.type){case"progress":(n=this._onProgress)==null||n.call(this,t.data);break;case"result":this._clearSolveTimeout(),this._currentRequestId=null,(s=this._onResult)==null||s.call(this,t.data);break;case"cancelled":this._clearSolveTimeout(),this._currentRequestId=null,(i=this._onCancelled)==null||i.call(this,t.data);break;case"segment_result":(a=this._onSegmentResult)==null||a.call(this,t.data);break;case"meshes_result":(o=this._onMeshesResult)==null||o.call(this,t.data);break;case"material_result":(r=this._onMaterialResult)==null||r.call(this,t.data);break;case"pipeline_step":(c=this._onPipelineStep)==null||c.call(this,t.data);break;case"pipeline_result":(l=this._onPipelineResult)==null||l.call(this,t.data);break;case"implant_mesh_result":(d=this._onImplantMeshResult)==null||d.call(this,t.data);break;case"guideline_meshes_result":(f=this._onGuidelineMeshResult)==null||f.call(this,t.data);break;case"error":this._clearSolveTimeout(),this._currentRequestId=null,console.error("ìë² ìë¬:",t.data.message),(h=this._onError)==null||h.call(this,t.data);break;case"pong":break;default:console.warn("ì ì ìë ë©ìì§:",t.type)}}_startSolveTimeout(t){this._clearSolveTimeout(),this._solveTimeout=setTimeout(()=>{var n;console.warn(`í´ì íììì (${t/1e3}ì´ ì´ê³¼)`),this.cancelAnalysis(),(n=this._onError)==null||n.call(this,{message:`í´ì íììì (${Math.floor(t/6e4)}ë¶ ì´ê³¼) â ë©ì¬ë¥¼ ë¨ìííê±°ë ìë² ìíë¥¼ íì¸íì¸ì`})},t)}_clearSolveTimeout(){this._solveTimeout&&(clearTimeout(this._solveTimeout),this._solveTimeout=null)}_scheduleReconnect(){var n;if(this._reconnectTimer)return;if(this._reconnectAttempt>=this.maxReconnect){console.error(`WebSocket ì¬ì°ê²° ${this.maxReconnect}í ì¤í¨ â í¬ê¸°`),(n=this._onError)==null||n.call(this,{message:`ìë² ì°ê²° ${this.maxReconnect}í ì¤í¨ â ìë²ë¥¼ íì¸íì¸ì`});return}const t=Math.min(2e3*Math.pow(2,this._reconnectAttempt),3e4);this._reconnectAttempt++,console.log(`WebSocket ì¬ì°ê²° ìë ${this._reconnectAttempt}/${this.maxReconnect} (${t/1e3}ì´ í)...`),this._reconnectTimer=setTimeout(()=>{this._reconnectTimer=null,this.connect()},t)}resetReconnect(){this._reconnectAttempt=0,this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=null)}}async function U_(e,t={}){if(Fe.reset(),Fe.updateProgress("uploading",0,"Uploading DICOM files..."),!tt.client){const s=new kh;tt.client=s,s.onConnect(()=>tt.setConnected(!0)),s.onDisconnect(()=>tt.setConnected(!1)),s.connect()}const n=tt.client;n.onPipelineStep(Z_),n.onPipelineResult(Y_),n.onSegmentResult(V_),n.onMeshesResult(X_),n.onMaterialResult(W_);try{const s=new FormData;for(const o of Array.from(e))s.append("files",o);const i=await fetch("/api/upload_dicom",{method:"POST",body:s});if(!i.ok)throw new Error(`Upload failed: ${i.statusText}`);const a=await i.json();Fe.updateProgress("uploading",1,`Uploaded ${a.n_files} files`),n.send("run_dicom_pipeline",{dicom_dir:a.dicom_dir,engine:t.engine??"auto",device:t.device??"gpu",fast:t.fast??!1,smooth:t.smooth??!0,resolution:t.resolution??64})}catch(s){Fe.setError(s.message),F.statusMessage=`Pipeline error: ${s.message}`}}function Z_(e){const n={dicom_convert:"uploading",dicom_convert_done:"uploading",segmentation:"segmentation",segmentation_done:"segmentation",mesh_extract:"mesh_extraction",mesh_extract_done:"mesh_extraction",material_assign:"material_assignment",material_assign_done:"material_assignment"}[e.step]??Fe.step,s=e.step.endsWith("_done");Fe.updateProgress(n,s?1:.5,e.message??e.step)}async function Y_(e){if(Fe.updateProgress("complete",1,"Pipeline complete"),e.meshes&&e.meshes.length>0&&(Fe.extractedMeshes=e.meshes.map(t=>({name:t.name,label:t.label,material_type:t.material_type})),await G_(e.meshes)),e.patient_info){const t=e.patient_info;console.log(`íì ì ë³´: ${t.patient_name??""} (${t.modality??""}, ${t.study_date??""})`)}F.statusMessage="DICOM pipeline complete",F.activeTab="file"}async function G_(e){let t=0;for(const n of e)try{p_({name:n.name,vertices:n.vertices,faces:n.faces,color:n.color}),t++}catch(s){console.error(`íì´íë¼ì¸ ë©ì¬ ë¡ë ì¤í¨: ${n.name}`,s)}if(t>0){const n=H.models.map(i=>i.mesh);Jl(n),await Oo(),F.toast(`${t}ê° êµ¬ì¡°ë¬¼ ìë ë¡ë ìë£`,"success");const s=H.manager;s&&H.models.length>0&&s.focusOnAllMeshes(H.models.map(i=>i.mesh))}}function V_(e){e.nrrd_path&&(Fe.segmentationPath=e.nrrd_path),Fe.updateProgress("segmentation",1,"Segmentation complete")}function X_(e){e.meshes&&(Fe.extractedMeshes=e.meshes.map(t=>({name:t.name}))),Fe.updateProgress("mesh_extraction",1,"Mesh extraction complete")}function W_(e){e.assignments&&(Fe.materialAssignments=e.assignments),Fe.updateProgress("material_assignment",1,"Material assignment complete")}var K_=ee('<p class="empty svelte-iubyej">No models loaded</p>'),q_=ee('<div class="model-item svelte-iubyej"><button> </button> <span class="model-name svelte-iubyej"> </span> <span class="model-count svelte-iubyej"> </span></div>'),Q_=ee('<div class="pipeline-bar-bg svelte-iubyej"><div class="pipeline-bar svelte-iubyej"></div></div>'),J_=ee('<div class="pipeline-error svelte-iubyej"> </div>'),em=ee('<div class="pipeline-result svelte-iubyej"> </div>'),tm=ee('<div class="pipeline-progress svelte-iubyej"><div class="pipeline-step-text svelte-iubyej"> </div> <!> <!> <!></div>'),nm=ee('<div class="panel svelte-iubyej"><h3 class="svelte-iubyej">FILE</h3> <div class="section svelte-iubyej"><div class="section-title svelte-iubyej"> </div> <!></div> <div class="section svelte-iubyej"><div class="section-title svelte-iubyej">Import</div> <button class="tool-btn primary svelte-iubyej"> </button> <button class="tool-btn secondary svelte-iubyej">Load STL...</button> <button class="tool-btn secondary svelte-iubyej">Load NRRD...</button> <button class="tool-btn danger svelte-iubyej">Clear All</button> <input type="file" accept=".stl" multiple="" style="display:none;" aria-hidden="true"/> <input type="file" accept=".nrrd" style="display:none;" aria-hidden="true"/></div> <div class="section pipeline-section svelte-iubyej"><div class="section-title svelte-iubyej">CT/MRI Pipeline</div> <button class="tool-btn dicom-btn svelte-iubyej">ð¥ Load DICOM (CT/MRI)</button> <div class="pipeline-hint svelte-iubyej">DICOM í´ëë¥¼ ì ííë©´ ìëì¼ë¡:<br/> ì¸ê·¸ë©íì´ì â ë©ì¬ ì¶ì¶ â 3D ëª¨ë¸ ë¡ë</div> <!>  <input type="file" multiple="" style="display:none;" aria-hidden="true"/></div></div>');function sm(e,t){sn(t,!0);let n=z(!1);async function s(){k(n,!0);try{await u_(),F.toast(`${H.models.length}ê° ëª¨ë¸ ë¡ë ìë£`,"success")}catch{F.toast("ìí ëª¨ë¸ ë¡ë ì¤í¨","error")}finally{k(n,!1)}}async function i(U){k(n,!0);try{await gh(U),F.toast(`STL ${U.length}ê° íì¼ ë¡ë ìë£`,"success")}catch{F.toast("STL ë¡ë ì¤í¨","error")}finally{k(n,!1)}}async function a(U){if(U.length!==0){k(n,!0);try{await h_(U[0]),F.toast("NRRD ë¡ë ìë£","success")}catch{F.toast("NRRD ë¡ë ì¤í¨","error")}finally{k(n,!1)}}}async function o(){if(H.models.length===0)return;await F.confirm("ëª¨ë ì­ì ",`${H.models.length}ê° ëª¨ë¸ê³¼ ëª¨ë  í´ì ë°ì´í°ë¥¼ ì­ì í©ëë¤. ê³ìíìê² ìµëê¹?`)&&(v_(),F.toast("ëª¨ë ì­ì ë¨","info"))}async function r(U){const N=U.target;!N.files||N.files.length===0||(await U_(N.files),N.value="")}const c={idle:"",uploading:"DICOM ìë¡ë ì¤...",segmentation:"ì¸ê·¸ë©íì´ì ì¤...",mesh_extraction:"ë©ì¬ ì¶ì¶ ì¤...",material_assignment:"ì¬ë£ í ë¹ ì¤...",complete:"íì´íë¼ì¸ ìë£!",error:"íì´íë¼ì¸ ì¤ë¥"};let l,d,f;var h=nm(),p=_(m(h),2),g=m(p),x=m(g),b=_(g,2);{var E=U=>{var N=K_();K(U,N)},I=U=>{var N=lp(),oe=Gn(N);Zt(oe,17,()=>H.models,Dn,(ae,ve)=>{var He=q_(),Ae=m(He);let Ve;var je=m(Ae),Qe=_(Ae,2),Se=m(Qe),Ye=_(Qe,2),Xe=m(Ye);he(ut=>{Ve=Oe(Ae,1,"vis-btn svelte-iubyej",null,Ve,{hidden:!u(ve).visible}),di(Ae,"title",u(ve).visible?"Hide":"Show"),di(Ae,"aria-label",`${u(ve).visible?"Hide":"Show"} ${u(ve).name??""}`),B(je,u(ve).visible?"â":"â"),B(Se,u(ve).name),B(Xe,`${ut??""}v`)},[()=>u(ve).vertexCount.toLocaleString()]),D("click",Ae,()=>H.toggleVisibility(u(ve).name)),K(ae,He)}),K(U,N)};Me(b,U=>{H.models.length===0?U(E):U(I,!1)})}var R=_(p,2),y=_(m(R),2),C=m(y),$=_(y,2),S=_($,2),P=_(S,2),M=_(P,2);er(M,U=>l=U,()=>l);var A=_(M,2);er(A,U=>d=U,()=>d);var T=_(R,2),j=_(m(T),2),ne=_(j,4);{var se=U=>{var N=tm(),oe=m(N),ae=m(oe),ve=_(oe,2);{var He=Se=>{var Ye=Q_(),Xe=m(Ye);he(()=>Nn(Xe,`width:${Fe.progress*100}%`)),K(Se,Ye)};Me(ve,Se=>{Fe.step!=="complete"&&Fe.step!=="error"&&Se(He)})}var Ae=_(ve,2);{var Ve=Se=>{var Ye=J_(),Xe=m(Ye);he(()=>B(Xe,Fe.error)),K(Se,Ye)};Me(Ae,Se=>{Fe.step==="error"&&Se(Ve)})}var je=_(Ae,2);{var Qe=Se=>{var Ye=em(),Xe=m(Ye);he(()=>B(Xe,`${Fe.extractedMeshes.length??""}ê° êµ¬ì¡°ë¬¼ ìë ë¡ëë¨`)),K(Se,Ye)};Me(je,Se=>{Fe.step==="complete"&&Fe.extractedMeshes.length>0&&Se(Qe)})}he(()=>B(ae,c[Fe.step]??Fe.message)),K(U,N)};Me(ne,U=>{Fe.step!=="idle"&&U(se)})}var Q=_(ne,2);er(Q,U=>f=U,()=>f),he(()=>{B(x,`Models (${H.models.length??""})`),y.disabled=u(n),B(C,u(n)?"Loading...":"Load Sample (L4+L5+Disc)"),$.disabled=u(n),S.disabled=u(n),P.disabled=u(n)||H.models.length===0,j.disabled=Fe.step!=="idle"&&Fe.step!=="complete"&&Fe.step!=="error"}),D("click",y,s),D("click",$,()=>l.click()),D("click",S,()=>d.click()),D("click",P,o),D("change",M,U=>{const N=U.target;N.files&&i(N.files),N.value=""}),D("change",A,U=>{const N=U.target;N.files&&a(N.files),N.value=""}),D("click",j,()=>f.click()),D("change",Q,r),K(e,h),an()}Xn(["click","change"]);var im=ee('<div><div class="catalog-info svelte-umngik"><span class="catalog-label svelte-umngik"> </span> <span class="catalog-desc svelte-umngik"> </span></div> <button> </button></div>'),am=ee('<div class="hint svelte-umngik" style="text-align:center;padding:8px 0">ì¤ë¹ ì¤ìëë¤</div>'),om=ee('<div class="place-hint svelte-umngik"><!> &nbsp;Â·&nbsp; <button class="cancel-btn svelte-umngik">Esc / ì·¨ì</button></div>'),rm=ee('<button class="warn-sm svelte-umngik">Clear All</button>'),lm=ee('<div class="hint svelte-umngik" style="text-align:center;padding:6px 0">ë°°ì¹ë ìíëí¸ ìì</div>'),cm=ee('<div role="button" tabindex="0"><span> </span> <span class="impl-name svelte-umngik"> </span> <span class="impl-mat svelte-umngik"> </span> <button class="del-btn svelte-umngik" title="ì­ì ">â</button></div>'),dm=ee('<div class="distraction-bar svelte-umngik"><span class="distraction-icon svelte-umngik">ð¦´</span> <div class="distraction-info svelte-umngik"><span class="distraction-title svelte-umngik">Distraction</span> <span class="distraction-desc svelte-umngik">ì¼ì´ì§ ëì´ë¡ ëì¤í¬ ê³µê° êµì </span></div> <button class="distraction-btn svelte-umngik">Apply</button></div>'),um=ee('<div class="transform-bar svelte-umngik"><span class="transform-label svelte-umngik">Transform:</span> <button class="transform-btn svelte-umngik">Move</button> <button class="transform-btn svelte-umngik">Rotate</button> <button class="transform-btn warn svelte-umngik">Del</button></div> <!>',1),hm=ee('<div class="implant-list svelte-umngik"></div> <!>',1),fm=ee('<div class="panel svelte-umngik"><h3 class="svelte-umngik">MODELING</h3> <div class="section svelte-umngik"><div class="section-title svelte-umngik">Bone Drill</div> <button> </button> <div class="slider-row svelte-umngik" style="margin-top:6px"><label for="drill-radius" class="svelte-umngik">Radius</label> <input id="drill-radius" type="range" min="1" max="15" step="0.5" class="svelte-umngik"/> <span class="val svelte-umngik"> </span></div> <div class="hint svelte-umngik">Hover = preview &nbsp;Â·&nbsp; Click = drill</div></div> <div class="section svelte-umngik"><div class="section-title svelte-umngik">Implant Catalog</div> <div class="tab-bar svelte-umngik"><button>Screw</button> <button>Cage</button> <button>Rod</button></div> <div class="catalog-list svelte-umngik"><!> <!></div> <!></div> <div class="section svelte-umngik"><div class="section-title-row svelte-umngik"><span class="section-title svelte-umngik">Placed Implants</span> <span class="count-badge svelte-umngik"> </span> <!></div> <!></div> <div class="section svelte-umngik"><div class="section-title svelte-umngik">Pedicle Guidelines</div> <div class="inline-row svelte-umngik"><label for="gl-vertebra" class="row-label svelte-umngik">ì²ì¶</label> <select id="gl-vertebra" class="svelte-umngik"><option>L1</option><option>L2</option><option>L3</option><option>L4</option><option>L5</option><option>S1</option></select></div> <div class="slider-row svelte-umngik" style="margin-top:6px"><label for="gl-angle" class="svelte-umngik">ë´ì¸¡ê°</label> <input id="gl-angle" type="range" min="0" max="25" step="1" class="svelte-umngik"/> <span class="val svelte-umngik"> </span></div> <div class="slider-row svelte-umngik"><label for="gl-depth" class="svelte-umngik">ì½ìê¹ì´</label> <input id="gl-depth" type="range" min="30" max="60" step="5" class="svelte-umngik"/> <span class="val svelte-umngik"> </span></div> <div class="btn-row svelte-umngik" style="margin-top:7px"><button class="tool-btn half svelte-umngik">Show</button> <button class="tool-btn half warn-btn svelte-umngik">Clear</button></div> <div class="hint svelte-umngik">ìì¸¡(ì¢/ì°) ê°ì´ëë¼ì¸ ìë ìì±</div></div> <div class="section svelte-umngik"><div class="section-title svelte-umngik">History</div> <div class="btn-row svelte-umngik"><button class="tool-btn half svelte-umngik"> </button> <button class="tool-btn half svelte-umngik"> </button></div></div></div>');function pm(e,t){sn(t,!0);let n=z("screw");const s=xt(()=>{var X;return((X=H.implantManager)==null?void 0:X.implantCount)??0}),i=xt(()=>u(s)>=0?A_():[]),a=xt(()=>{var X;return((X=H.implantManager)==null?void 0:X.selectedImplant)??null}),o=xt(()=>{var X,fe;return u(a)!==null&&((fe=(X=H.implantManager)==null?void 0:X.implants[u(a)])==null?void 0:fe.category)==="cage"});let r=z("L4"),c=z(10),l=z(45);function d(){q.mode==="drill"?m_():__()}function f(){const X=zt.undo();X&&(F.statusMessage=`Undo: ${X}`)}function h(){const X=zt.redo();X&&(F.statusMessage=`Redo: ${X}`)}function p(){var X;(X=H.implantManager)==null||X.setTransformMode("translate")}function g(){var X;(X=H.implantManager)==null||X.setTransformMode("rotate")}function x(){wh()}function b(){u(s)!==0&&P_()}function E(){q.exitImplantPlaceMode(),F.statusMessage="ë°°ì¹ ëª¨ë ì·¨ìë¨"}function I(){F.statusMessage=`ê°ì´ëë¼ì¸ ìì± ì¤... (${u(r)})`;const fe={L1:[0,150,0],L2:[0,120,0],L3:[0,90,0],L4:[0,60,0],L5:[0,30,0],S1:[0,0,0]}[u(r)]??[0,60,0];D_(fe,u(r),{medial_angle:u(c),depth:u(l)}),F.statusMessage=`${u(r)} ê°ì´ëë¼ì¸ ìì²­ë¨`}function R(){z_(),F.statusMessage="ê°ì´ëë¼ì¸ ì ê±°ë¨"}var y=fm(),C=_(m(y),2),$=_(m(C),2);let S;var P=m($),M=_($,2),A=_(m(M),2),T=_(A,2),j=m(T),ne=_(C,2),se=_(m(ne),2),Q=m(se);let U;var N=_(Q,2);let oe;var ae=_(N,2);let ve;var He=_(se,2),Ae=m(He);Zt(Ae,17,()=>kd[u(n)],X=>X.id,(X,fe)=>{var Ue=im();let it;var bt=m(Ue),ze=m(bt),we=m(ze),Ze=_(ze,2),rt=m(Ze),et=_(bt,2);let me;var Te=m(et);he(()=>{it=Oe(Ue,1,"catalog-item svelte-umngik",null,it,{"catalog-item-active":q.pendingImplantName===u(fe).id&&q.mode==="implantPlace"}),B(we,u(fe).label),B(rt,u(fe).description),me=Oe(et,1,"place-btn svelte-umngik",null,me,{"place-btn-active":q.pendingImplantName===u(fe).id&&q.mode==="implantPlace"}),B(Te,q.pendingImplantName===u(fe).id&&q.mode==="implantPlace"?"ë°°ì¹ ì¤...":"Place")}),D("click",et,()=>x_(u(fe))),K(X,Ue)});var Ve=_(Ae,2);{var je=X=>{var fe=am();K(X,fe)};Me(Ve,X=>{kd[u(n)].length===0&&X(je)})}var Qe=_(He,2);{var Se=X=>{var fe=om(),Ue=m(fe);{var it=we=>{var Ze=Fi();he(()=>B(Ze,`${q.pendingImplantCategory==="screw"?"ð©":"ð"} 1. ì§ìì  í´ë¦­ â ì¹´ë©ë¼ íì  â 2. ëì  í´ë¦­`)),K(we,Ze)},bt=we=>{var Ze=Fi("ð¦´ ë¼ íë©´ì í´ë¦­í´ ë°°ì¹");K(we,Ze)};Me(Ue,we=>{q.pendingImplantCategory==="screw"||q.pendingImplantCategory==="rod"?we(it):we(bt,!1)})}var ze=_(Ue,2);D("click",ze,E),K(X,fe)};Me(Qe,X=>{q.mode==="implantPlace"&&X(Se)})}var Ye=_(ne,2),Xe=m(Ye),ut=_(m(Xe),2),Mt=m(ut),G=_(ut,2);{var te=X=>{var fe=rm();D("click",fe,b),K(X,fe)};Me(G,X=>{u(s)>0&&X(te)})}var Z=_(Xe,2);{var ie=X=>{var fe=lm();K(X,fe)},re=X=>{var fe=hm(),Ue=Gn(fe);Zt(Ue,21,()=>u(i),ze=>ze.name,(ze,we)=>{var Ze=cm();let rt;var et=m(Ze);let me;var Te=m(et),Pe=_(et,2),Ie=m(Pe),ye=_(Pe,2),lt=m(ye),xe=_(ye,2);he(()=>{rt=Oe(Ze,1,"implant-row svelte-umngik",null,rt,{"implant-selected":u(a)===u(we).name}),me=Oe(et,1,"impl-cat-badge svelte-umngik",null,me,{"badge-cage":u(we).category==="cage","badge-screw":u(we).category==="screw","badge-rod":u(we).category==="rod"}),B(Te,u(we).category==="cage"?"C":u(we).category==="screw"?"S":"R"),B(Ie,u(we).name),B(lt,u(we).material)}),D("click",Ze,()=>{var Le;return(Le=H.implantManager)==null?void 0:Le.selectImplant(u(we).name)}),D("keydown",Ze,Le=>{var pt;return Le.key==="Enter"&&((pt=H.implantManager)==null?void 0:pt.selectImplant(u(we).name))}),D("click",xe,Le=>{var pt;Le.stopPropagation(),(pt=H.implantManager)==null||pt.removeImplant(u(we).name)}),K(ze,Ze)});var it=_(Ue,2);{var bt=ze=>{var we=um(),Ze=Gn(we),rt=_(m(Ze),2),et=_(rt,2),me=_(et,2),Te=_(Ze,2);{var Pe=Ie=>{var ye=dm(),lt=_(m(ye),4);D("click",lt,()=>u(a)&&C_(u(a))),K(Ie,ye)};Me(Te,Ie=>{u(o)&&Ie(Pe)})}D("click",rt,p),D("click",et,g),D("click",me,x),K(ze,we)};Me(it,ze=>{u(a)&&ze(bt)})}K(X,fe)};Me(Z,X=>{u(s)===0?X(ie):X(re,!1)})}var pe=_(Ye,2),V=_(m(pe),2),J=_(m(V),2),le=_(V,2),_e=_(m(le),2),be=_(_e,2),Ce=m(be),Be=_(le,2),at=_(m(Be),2),Ge=_(at,2),Je=m(Ge),ht=_(Be,2),ot=m(ht),gt=_(ot,2),ft=_(pe,2),ce=_(m(ft),2),de=m(ce),We=m(de),nt=_(de,2),st=m(nt);he(X=>{S=Oe($,1,"tool-btn svelte-umngik",null,S,{active:q.mode==="drill"}),B(P,`Drill: ${q.mode==="drill"?"ON":"OFF"}`),B(j,`${X??""} mm`),U=Oe(Q,1,"tab-btn svelte-umngik",null,U,{"tab-active":u(n)==="screw"}),oe=Oe(N,1,"tab-btn svelte-umngik",null,oe,{"tab-active":u(n)==="cage"}),ve=Oe(ae,1,"tab-btn svelte-umngik",null,ve,{"tab-active":u(n)==="rod"}),B(Mt,`${u(s)??""}ê°`),B(Ce,`${u(c)??""}Â°`),B(Je,`${u(l)??""} mm`),de.disabled=!zt.canUndo,B(We,`Undo (${zt.undoCount??""})`),nt.disabled=!zt.canRedo,B(st,`Redo (${zt.redoCount??""})`)},[()=>q.drillRadius.toFixed(1)]),D("click",$,d),ys(A,()=>q.drillRadius,X=>q.drillRadius=X),D("click",Q,()=>k(n,"screw")),D("click",N,()=>k(n,"cage")),D("click",ae,()=>k(n,"rod")),Du(J,()=>u(r),X=>k(r,X)),ys(_e,()=>u(c),X=>k(c,X)),ys(at,()=>u(l),X=>k(l,X)),D("click",ot,I),D("click",gt,R),D("click",de,f),D("click",nt,h),K(e,y),an()}Xn(["click","keydown"]);const vm={key:"cortical_bone",E:15e9,nu:.3,density:1850,constitutiveModel:"linear_elastic"};class _m{constructor(t,n,s){O(this,"scene");O(this,"meshes");O(this,"voxelGrids");O(this,"selectedFaceIndices",[]);O(this,"selectedNodeIndices",new Set);O(this,"boundaryConditions",[]);O(this,"materialAssignments",{});O(this,"brushSelection",new Map);O(this,"_selectionHighlight",null);O(this,"_bcVisuals",[]);O(this,"FACE_NORMAL_THRESHOLD",Math.cos(30*Math.PI/180));O(this,"MAX_HIGHLIGHT",5e3);O(this,"cachedFEMMeshes",{});O(this,"solverAssignments",{});this.scene=t,this.meshes=n,this.voxelGrids=s}selectFace(t,n=!1){if(!t||t.faceIndex===void 0)return;n||this.clearSelection();const s=t.object,i=s.geometry,a=t.faceIndex,o=i.attributes.position;let r=i.attributes.normal;r||(i.computeVertexNormals(),r=i.attributes.normal);const c=this._getFaceNormal(o,a),l=this._bfsFaceSelect(o,r,a,c);l.forEach(d=>{this.selectedFaceIndices.push(d);const f=d*3;this.selectedNodeIndices.add(f),this.selectedNodeIndices.add(f+1),this.selectedNodeIndices.add(f+2)}),this._updateSelectionVisual(s),console.log(`ì í: ${l.length}ê° ë©´, ${this.selectedNodeIndices.size}ê° ë¸ë`)}clearSelection(){this.selectedFaceIndices=[],this.selectedNodeIndices.clear(),this._clearSelectionVisual()}brushSelectSphere(t,n){Object.entries(this.voxelGrids).forEach(([s,i])=>{const a=i.previewDrill(t,n);if(a.length===0)return;this.brushSelection.has(s)||this.brushSelection.set(s,new Set);const o=this.brushSelection.get(s),r=i.gridSize.x,c=i.gridSize.y;a.forEach(l=>{const d=l.x+l.y*r+l.z*r*c;o.add(d)})})}clearBrushSelection(){this.brushSelection.clear()}getBrushSelectionCount(){let t=0;return this.brushSelection.forEach(n=>t+=n.size),t}getBrushSelectionCentroid(){const t=this.getBrushSelectionWorldPositions();if(t.length===0)return null;let n=0,s=0,i=0;for(const o of t)n+=o.x,s+=o.y,i+=o.z;const a=t.length;return new Y(n/a,s/a,i/a)}getBrushSelectionWorldPositions(){const t=[];return this.brushSelection.forEach((n,s)=>{const i=this.voxelGrids[s];if(!i)return;const a=i.gridSize.x,o=i.gridSize.y;n.forEach(r=>{const c=r%a,l=Math.floor(r/a)%o,d=Math.floor(r/(a*o)),f=i.gridToWorld(c,l,d);t.push(f)})}),t}addFixedBC(){if(this.getBrushSelectionCount()>0){const s=new Map;this.brushSelection.forEach((o,r)=>{s.set(r,new Set(o))});const i={type:"fixed",indices:new Set,voxelIndices:s,values:[[0,0,0]],color:52292};this.boundaryConditions.push(i),this._addBCVisual(i);const a=this.getBrushSelectionCount();return this.clearBrushSelection(),console.log(`ê³ ì  BC ì¶ê° (ë¸ë¬ì¬): ${a}ê° ë³µì`),i}if(this.selectedNodeIndices.size===0){console.warn("ì íë ë¸ëê° ììµëë¤");return}const t=new Set(this.selectedNodeIndices),n={type:"fixed",indices:t,values:[[0,0,0]],color:52292};return this.boundaryConditions.push(n),this._addBCVisual(n),this.clearSelection(),console.log(`ê³ ì  BC ì¶ê°: ${t.size}ê° ë¸ë`),n}addForceBC(t){if(this.getBrushSelectionCount()>0){const i=new Map;this.brushSelection.forEach((r,c)=>{i.set(c,new Set(r))});const a={type:"force",indices:new Set,voxelIndices:i,values:[t],color:16720418};this.boundaryConditions.push(a),this._addBCVisual(a);const o=this.getBrushSelectionCount();return this.clearBrushSelection(),console.log(`íì¤ BC ì¶ê° (ë¸ë¬ì¬): ${o}ê° ë³µì, force=[${t}]`),a}if(this.selectedNodeIndices.size===0){console.warn("ì íë ë¸ëê° ììµëë¤");return}const n=new Set(this.selectedNodeIndices),s={type:"force",indices:n,values:[t],color:16720418};return this.boundaryConditions.push(s),this._addBCVisual(s),this.clearSelection(),console.log(`íì¤ BC ì¶ê°: ${n.size}ê° ë¸ë, force=[${t}]`),s}removeLastBC(){if(this.boundaryConditions.length===0)return;const t=this.boundaryConditions.pop();this._removeBCVisual(t),console.log("ë§ì§ë§ BC ì ê±°")}clearAllBC(){this._bcVisuals.forEach(t=>{this.scene.remove(t),t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}),this._bcVisuals=[],this.boundaryConditions=[],console.log("ëª¨ë  BC ì ê±°")}assignMaterial(t,n){this.materialAssignments[t]=n,console.log(`ì¬ë£ í ë¹: ${t} â ${n.label} (E=${n.E})`)}buildFEMMesh(t){const n=t.gridSize.x,s=t.gridSize.y,i=t.gridSize.z,a=t.cellSize,o=t.bounds.min,r=new Map,c=[];let l=0;const d=(p,g,x)=>{const b=`${p},${g},${x}`,E=r.get(b);if(E!==void 0)return E;const I=l++;return r.set(b,I),c.push([o.x+p*a,o.y+g*a,o.z+x*a]),I},f=[],h=new Map;for(let p=0;p<i;p++)for(let g=0;g<s;g++)for(let x=0;x<n;x++){if(!t.get(x,g,p))continue;const b=f.length,E=x+g*n+p*n*s;h.set(E,b);const I=d(x,g,p),R=d(x+1,g,p),y=d(x+1,g+1,p),C=d(x,g+1,p),$=d(x,g,p+1),S=d(x+1,g,p+1),P=d(x+1,g+1,p+1),M=d(x,g+1,p+1);f.push([I,R,y,C,$,S,P,M])}return console.log(`FEM ë©ì¬ ìì±: ${c.length}ê° ë¸ë, ${f.length}ê° HEX8 ìì`),{nodes:c,elements:f,voxelToElement:h,cornerToNode:r}}extractParticleData(){const t=[],n=[];return Object.entries(this.voxelGrids).forEach(([s,i])=>{const a=i.cellSize**3;for(let o=0;o<i.gridSize.z;o++)for(let r=0;r<i.gridSize.y;r++)for(let c=0;c<i.gridSize.x;c++)if(i.get(c,r,o)){const l=i.gridToWorld(c,r,o);t.push([l.x,l.y,l.z]),n.push(a)}}),{positions:t,volumes:n}}_mapBCtoFEMNodes(t,n,s){if(!t.voxelIndices)return null;const i=t.voxelIndices.get(n);if(!i||i.size===0)return null;const a=new Set;return i.forEach(o=>{const r=s.voxelToElement.get(o);if(r===void 0)return;s.elements[r].forEach(l=>a.add(l))}),a.size===0?null:{type:t.type,node_indices:[...a],values:t.values}}_mapBCtoParticles(t,n,s){if(!t.voxelIndices)return null;const i=t.voxelIndices.get(n);if(!i||i.size===0)return null;const a=[];return i.forEach(o=>{const r=s.get(o);r!==void 0&&a.push(r)}),a.length===0?null:{type:t.type,node_indices:a,values:t.values}}buildAnalysisRequest(t){if(Object.keys(this.voxelGrids).length===0)return console.warn("[PreProcessor] ë³µì ê·¸ë¦¬ëê° ë¹ì´ ìì"),null;if(this.boundaryConditions.length===0)return console.warn("[PreProcessor] ê²½ê³ì¡°ê±´ ë¯¸ì¤ì "),null;if(!this.boundaryConditions.some(r=>r.type==="fixed"))return console.warn("[PreProcessor] ê³ ì  ê²½ê³ì¡°ê±´(Fixed BC) ìì"),null;for(const r of this.boundaryConditions)if(r.type==="force")for(const c of r.values){if(c.length!==3)return console.warn(`[PreProcessor] Force ë²¡í° ì°¨ì ì¤ë¥: ${c.length}ì°¨ì (3ì°¨ì íì)`),null;if(Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2])<1e-6)return console.warn("[PreProcessor] Force ë²¡í° í¬ê¸°ê° 0ì ê°ê¹ì"),null}const s=[],i=[],a=[];this.cachedFEMMeshes={},Object.entries(this.voxelGrids).forEach(([r,c])=>{const l=this.materialAssignments[r]||vm,d=this.solverAssignments[r]||t;if(d==="fem"){const f=this.buildFEMMesh(c);this.cachedFEMMeshes[r]=f;const h=[];for(const p of this.boundaryConditions){const g=this._mapBCtoFEMNodes(p,r,f);g&&h.push(g)}a.push({name:l.key,method:"fem",E:l.E,nu:l.nu,density:l.density,constitutive_model:l.constitutiveModel||"linear_elastic",C10:l.C10,C01:l.C01,D1:l.D1,mu_ogden:l.mu_ogden,alpha_ogden:l.alpha_ogden,node_indices:[],nodes:f.nodes,elements:f.elements,boundary_conditions:h})}else{const f=c.cellSize**3,h=c.gridSize.x,p=c.gridSize.y,g=c.gridSize.z,x=new Map,b=s.length;let E=0;for(let y=0;y<g;y++)for(let C=0;C<p;C++)for(let $=0;$<h;$++)if(c.get($,C,y)){const S=c.gridToWorld($,C,y),P=s.length;s.push([S.x,S.y,S.z]),i.push(f);const M=$+C*h+y*h*p;x.set(M,P),E++}const I=[];for(let y=b;y<b+E;y++)I.push(y);const R=[];for(const y of this.boundaryConditions){const C=this._mapBCtoParticles(y,r,x);C&&R.push(C)}a.push({name:l.key,method:d,E:l.E,nu:l.nu,density:l.density,constitutive_model:d==="fem"&&l.constitutiveModel||"linear_elastic",node_indices:I,boundary_conditions:R})}});const o=this.boundaryConditions.filter(r=>!r.voxelIndices).map(r=>({type:r.type,node_indices:Array.from(r.indices),values:r.values}));return{positions:s,volumes:i,method:t,boundary_conditions:o,materials:a,options:{}}}_getFaceNormal(t,n){const s=n*3,i=new Y().fromBufferAttribute(t,s),a=new Y().fromBufferAttribute(t,s+1),o=new Y().fromBufferAttribute(t,s+2),r=new Y().subVectors(a,i),c=new Y().subVectors(o,i);return new Y().crossVectors(r,c).normalize()}_bfsFaceSelect(t,n,s,i){const a=t.count/3,o=new Set,r=[],c=[s];o.add(s);const l=100;for(;c.length>0&&r.length<l;){const d=c.shift();if(!(this._getFaceNormal(t,d).dot(i)<this.FACE_NORMAL_THRESHOLD)){r.push(d);for(let p=-3;p<=3;p++){const g=d+p;g>=0&&g<a&&!o.has(g)&&(o.add(g),c.push(g))}}}return r}_updateSelectionVisual(t){this._clearSelectionVisual();const n=t.geometry.attributes.position,s=[];if(this.selectedFaceIndices.forEach(o=>{const r=o*3;for(let c=0;c<3;c++)s.push(n.getX(r+c),n.getY(r+c),n.getZ(r+c))}),s.length===0)return;const i=new en;i.setAttribute("position",new Ds(s,3)),i.computeVertexNormals();const a=new ii({color:16776960,transparent:!0,opacity:.5,side:wn,depthTest:!1});this._selectionHighlight=new W(i,a),this._selectionHighlight.renderOrder=999,this.scene.add(this._selectionHighlight)}_clearSelectionVisual(){this._selectionHighlight&&(this.scene.remove(this._selectionHighlight),this._selectionHighlight.geometry.dispose(),this._selectionHighlight.material.dispose(),this._selectionHighlight=null)}_addBCVisual(t){if(t.voxelIndices){const o=[];let r=1;if(t.voxelIndices.forEach((g,x)=>{const b=this.voxelGrids[x];if(!b)return;r=b.cellSize;const E=b.gridSize.x,I=b.gridSize.y;g.forEach(R=>{const y=R%E,C=Math.floor(R/E)%I,$=Math.floor(R/(E*I)),S=b.gridToWorld(y,C,$);o.push(S)})}),o.length===0)return;const c=r*.98,l=new St(c,c,c),d=new ii({color:t.color,transparent:!0,opacity:.5,depthTest:!1}),f=Math.min(o.length,this.MAX_HIGHLIGHT),h=new Al(l,d,f),p=new fi;for(let g=0;g<f;g++){const x=o[g];p.setPosition(x.x,x.y,x.z),h.setMatrixAt(g,p)}h.instanceMatrix.needsUpdate=!0,h.renderOrder=998,this.scene.add(h),this._bcVisuals.push(h),t._visual=h;return}const n=[];if(t.indices.forEach(o=>{const r=Object.values(this.meshes);if(r.length===0)return;const c=r[0].geometry.attributes.position;o<c.count&&n.push(c.getX(o),c.getY(o),c.getZ(o))}),n.length===0)return;const s=new en;s.setAttribute("position",new Ds(n,3));const i=new Jr({color:t.color,size:3,depthTest:!1,sizeAttenuation:!1}),a=new sr(s,i);a.renderOrder=998,this.scene.add(a),this._bcVisuals.push(a),t._visual=a}_removeBCVisual(t){if(t._visual){this.scene.remove(t._visual),t._visual.geometry&&t._visual.geometry.dispose(),t._visual.material&&t._visual.material.dispose();const n=this._bcVisuals.indexOf(t._visual);n>=0&&this._bcVisuals.splice(n,1)}if(t._arrowVisual){this.scene.remove(t._arrowVisual);const n=t._arrowVisual;n.line&&(n.line.geometry.dispose(),n.line.material.dispose()),n.cone&&(n.cone.geometry.dispose(),n.cone.material.dispose());const s=this._bcVisuals.indexOf(t._arrowVisual);s>=0&&this._bcVisuals.splice(s,1),t._arrowVisual=void 0}}dispose(){this.clearSelection(),this.clearAllBC()}}function ec(e){e=Math.max(0,Math.min(1,e));let t,n,s;return e<.25?(t=0,n=e*4,s=1):e<.5?(t=0,n=1,s=1-(e-.25)*4):e<.75?(t=(e-.5)*4,n=1,s=0):(t=1,n=1-(e-.75)*4,s=0),{r:t,g:n,b:s}}function mm(e){if(e=Math.max(0,Math.min(1,e)),e<.5){const t=e*2;return{r:.23+t*.77,g:.3+t*.7,b:.75+t*.25}}else{const t=(e-.5)*2;return{r:1,g:1-t*.73,b:1-t*.77}}}function gm(e){e=Math.max(0,Math.min(1,e));const t=[[.267,.004,.329],[.282,.141,.458],[.127,.566,.55],[.544,.773,.247],[.993,.906,.144]],n=e*4,s=Math.min(3,Math.floor(n)),i=n-s;return{r:t[s][0]+i*(t[s+1][0]-t[s][0]),g:t[s][1]+i*(t[s+1][1]-t[s][1]),b:t[s][2]+i*(t[s+1][2]-t[s][2])}}function bm(e){return e=Math.max(0,Math.min(1,e)),{r:e,g:e,b:e}}function ym(e){e=Math.max(0,Math.min(1,e));const t=(1-e)*240/360,n=1,s=1,i=Math.floor(t*6),a=t*6-i,o=s*(1-n),r=s*(1-a*n),c=s*(1-(1-a)*n);switch(i%6){case 0:return{r:s,g:c,b:o};case 1:return{r,g:s,b:o};case 2:return{r:o,g:s,b:c};case 3:return{r:o,g:r,b:s};case 4:return{r:c,g:o,b:s};case 5:return{r:s,g:o,b:r};default:return{r:0,g:0,b:0}}}function wm(e){e=Math.max(0,Math.min(1,e));const t=[[.19,.07,.23],[.11,.34,.8],[.08,.67,.74],[.29,.87,.38],[.74,.9,.13],[.98,.6,.07],[.84,.15,.11]],n=e*6,s=Math.min(5,Math.floor(n)),i=n-s;return{r:t[s][0]+i*(t[s+1][0]-t[s][0]),g:t[s][1]+i*(t[s+1][1]-t[s][1]),b:t[s][2]+i*(t[s+1][2]-t[s][2])}}const Vi={jet:{name:"jet",label:"Jet",fn:ec},coolToWarm:{name:"coolToWarm",label:"Cool to Warm",fn:mm},viridis:{name:"viridis",label:"Viridis",fn:gm},grayscale:{name:"grayscale",label:"Grayscale",fn:bm},rainbow:{name:"rainbow",label:"Rainbow",fn:ym},turbo:{name:"turbo",label:"Turbo",fn:wm}},xm=Object.keys(Vi);function Wr(e,t,n,s="jet"){var r;t===void 0&&(t=Math.min(...e)),n===void 0&&(n=Math.max(...e));const i=n-t||1e-10,a=new Float32Array(e.length*3),o=((r=Vi[s])==null?void 0:r.fn)??ec;for(let c=0;c<e.length;c++){const l=(e[c]-t)/i,d=o(Math.max(0,Math.min(1,l)));a[c*3]=d.r,a[c*3+1]=d.g,a[c*3+2]=d.b}return{colors:a,min:t,max:n}}function tc(e,t=10){var i;const n=((i=Vi[e])==null?void 0:i.fn)??ec,s=[];for(let a=0;a<=t;a++){const o=a/t,r=n(o),c=Math.round(r.r*255),l=Math.round(r.g*255),d=Math.round(r.b*255);s.push(`rgb(${c},${l},${d})`)}return`linear-gradient(to right, ${s.join(", ")})`}function km(e,t,n,s,i="jet"){const a=document.getElementById(e);if(!a)return;a.innerHTML="";const o=document.createElement("div");o.style.cssText=`
    width: 100%; height: 16px; border-radius: 3px;
    background: ${tc(i,20)};
  `,a.appendChild(o);const r=document.createElement("div");if(r.style.cssText="display: flex; justify-content: space-between; font-size: 10px; color: #aaa; margin-top: 2px;",r.innerHTML=`<span>${t.toExponential(2)}</span><span>${n.toExponential(2)}</span>`,a.appendChild(r),s){const c=document.createElement("div");c.style.cssText="font-size: 10px; color: #888; text-align: center; margin-top: 2px;",c.textContent=s,a.appendChild(c)}}const Mm=[[0,3,2,1],[4,5,6,7],[0,1,5,4],[2,3,7,6],[0,4,7,3],[1,2,6,5]];function Sm(e){const t=new Map;for(const s of e)for(const i of Mm){const a=i.map(c=>s[c]),o=[...a].sort((c,l)=>c-l).join(","),r=t.get(o);r?r.count++:t.set(o,{nodes:a,count:1})}const n=[];for(const{nodes:s,count:i}of t.values())if(i===1){const[a,o,r,c]=s;n.push([a,o,r]),n.push([a,r,c])}return n}function fr(e,t){switch(t){case"x":return e.map(n=>n[0]||0);case"y":return e.map(n=>n[1]||0);case"z":return e.map(n=>n[2]||0);case"magnitude":default:return e.map(n=>Math.sqrt((n[0]||0)**2+(n[1]||0)**2+(n[2]||0)**2))}}function Mh(e,t,n){switch(t){case"displacement":return fr(e.displacements,n);case"stress":return e.stress||[];case"damage":return new Array(e.nodes.length).fill(0);default:return[]}}function Sh(e,t,n){switch(t){case"displacement":return fr(e.displacements||[],n);case"stress":return e.stress||[];case"damage":return e.damage||[];default:return[]}}function Eh(e,t,n){switch(t){case"displacement":return fr(e.displacements??[],n);case"stress":{const s=e.stress;return!s||s.length===0?[]:typeof s[0]=="number"?s:fr(s,n)}case"damage":return e.damage||[];default:return[]}}function Ch(e,t,n){const s=[];if(e.fem_regions)for(const i of e.fem_regions)s.push(...Mh(i,t,n));if(e.particle_regions)for(const i of e.particle_regions)s.push(...Sh(i,t,n));return!e.fem_regions&&!e.particle_regions&&s.push(...Eh(e,t,n)),s}function Kr(e,t,n){var o;const s={maxDisp:0,minDisp:1/0,maxStress:0,minStress:0,maxDamage:0,minDamage:0,currentMin:0,currentMax:0},i=r=>{for(const c of r){const l=Math.sqrt((c[0]||0)**2+(c[1]||0)**2+(c[2]||0)**2);l>s.maxDisp&&(s.maxDisp=l),l<s.minDisp&&(s.minDisp=l)}};if(e.fem_regions)for(const r of e.fem_regions)i(r.displacements);if(e.particle_regions)for(const r of e.particle_regions)i(r.displacements||[]);!e.fem_regions&&!e.particle_regions&&((o=e.displacements)==null?void 0:o.length)>0&&i(e.displacements),s.minDisp===1/0&&(s.minDisp=0);const a=Ch(e,t,n);return a.length>0&&(s.currentMin=Math.min(...a),s.currentMax=Math.max(...a),t==="stress"&&(s.maxStress=s.currentMax,s.minStress=s.currentMin),t==="damage"&&(s.maxDamage=s.currentMax,s.minDamage=s.currentMin)),s}function Cd(e,t,n,s,i){const a=Math.min(e.length,t.length),o=[],r=[];for(let c=0;c<a;c++){const l=t[c];if(!(n.enabled&&(l<n.lower||l>n.upper))){if(s.enabled){const d=e[c],f=s.axis==="x"?0:s.axis==="y"?1:2,h=i.min.getComponent(f),g=i.max.getComponent(f)-h||1,x=h+(s.position+1)/2*g;if(!(s.invert?d[f]<x:d[f]>x))continue}o.push(e[c]),r.push(l)}}return{positions:o,scalars:r}}function Em(e,t,n,s,i,a){const[o,r,c]=e,l=t[o],d=t[r],f=t[c];if(!l||!d||!f)return!1;if(s.enabled){const h=(n[o]+n[r]+n[c])/3;if(h<s.lower||h>s.upper)return!1}if(i.enabled){const h=i.axis==="x"?0:i.axis==="y"?1:2,p=[(l[0]+d[0]+f[0])/3,(l[1]+d[1]+f[1])/3,(l[2]+d[2]+f[2])/3],g=a.min.getComponent(h),b=a.max.getComponent(h)-g||1,E=g+(i.position+1)/2*b;if(!(i.invert?p[h]<E:p[h]>E))return!1}return!0}class Cm{constructor(t){O(this,"scene");O(this,"data",null);O(this,"_points",null);O(this,"_meshes",[]);O(this,"_geometry",null);O(this,"mode","displacement");O(this,"component","magnitude");O(this,"colormapName","jet");O(this,"dispScale",10);O(this,"particleSize",3);O(this,"opacity",1);O(this,"representation","points");O(this,"customRange",null);O(this,"threshold",{enabled:!1,lower:0,upper:1});O(this,"clipConfig",{enabled:!1,axis:"x",position:0,invert:!1});O(this,"stats",{maxDisp:0,maxStress:0,maxDamage:0,minDisp:0,minStress:0,minDamage:0,currentMin:0,currentMax:0});O(this,"_cachedPositions",null);O(this,"_bbox",new mn);O(this,"visibleCount",0);this.scene=t}loadResults(t){var i,a;this.data=t,this.stats=Kr(t,this.mode,this.component),this._computeBBox(),this.threshold.lower=this.stats.currentMin,this.threshold.upper=this.stats.currentMax,this.updateVisualization();const n=t.fem_regions&&t.fem_regions.length>0,s=t.particle_regions&&t.particle_regions.length>0;console.log("íì²ë¦¬ ê²°ê³¼ ë¡ë:",{ë°©ë²:(i=t.info)==null?void 0:i.method,ìë ´:(a=t.info)==null?void 0:a.converged,FEMìì­:n?t.fem_regions.length:0,ìììì­:s?t.particle_regions.length:0})}setMode(t){this.mode=t,this.data&&(this.stats=Kr(this.data,this.mode,this.component)),this.threshold.lower=this.stats.currentMin,this.threshold.upper=this.stats.currentMax,this.customRange=null,this.data&&this.updateVisualization()}setComponent(t){this.component=t,this.data&&(this.stats=Kr(this.data,this.mode,this.component)),this.threshold.lower=this.stats.currentMin,this.threshold.upper=this.stats.currentMax,this.customRange=null,this.data&&this.updateVisualization()}setColormap(t){this.colormapName=t,this.data&&this.updateVisualization()}setDisplacementScale(t){this.dispScale=t,this.data&&this.updateVisualization()}setParticleSize(t){var n;this.particleSize=t,(n=this._points)!=null&&n.material&&(this._points.material.size=t)}setOpacity(t){var n;if(this.opacity=t,(n=this._points)!=null&&n.material){const s=this._points.material;s.opacity=t,s.transparent=t<1}for(const s of this._meshes){const i=s.material;i.opacity=t,i.transparent=t<1}}setCustomRange(t,n){t!==null&&n!==null?this.customRange={min:t,max:n}:this.customRange=null,this.data&&this.updateVisualization()}setThreshold(t,n,s){this.threshold.enabled=t,n!==void 0&&(this.threshold.lower=n),s!==void 0&&(this.threshold.upper=s),this.data&&this.updateVisualization()}setClipPlane(t){Object.assign(this.clipConfig,t),this.data&&this.updateVisualization()}updateVisualization(){var o,r;if(!this.data)return;this.clear();const t=Ch(this.data,this.mode,this.component),n=((o=this.customRange)==null?void 0:o.min)??(t.length>0?Math.min(...t):0),s=((r=this.customRange)==null?void 0:r.max)??(t.length>0?Math.max(...t):1);let i=0;if(this.data.fem_regions)for(const c of this.data.fem_regions){const l=this._renderFEMRegion(c,n,s);i+=l}if(this.data.particle_regions)for(const c of this.data.particle_regions){const l=this._renderParticleRegion(c,n,s);i+=l}!this.data.fem_regions&&!this.data.particle_regions&&(i=this._renderLegacyPoints(n,s)),this.visibleCount=i,km("analysis-colorbar",n,s,{displacement:{magnitude:"Displacement Mag [mm]",x:"Displacement X [mm]",y:"Displacement Y [mm]",z:"Displacement Z [mm]"},stress:{magnitude:"von Mises Stress [Pa]",x:"Stress X [Pa]",y:"Stress Y [Pa]",z:"Stress Z [Pa]"},damage:{magnitude:"Damage [0-1]",x:"Damage [0-1]",y:"Damage [0-1]",z:"Damage [0-1]"}}[this.mode][this.component],this.colormapName)}_renderFEMRegion(t,n,s){const{nodes:i,elements:a,displacements:o}=t;if(!i||!a||i.length===0)return 0;const r=Sm(a);if(r.length===0)return 0;const c=Mh(t,this.mode,this.component),l=i.map((M,A)=>{const T=o[A]||[0,0,0];return[M[0]+T[0]*this.dispScale,M[1]+T[1]*this.dispScale,M[2]+T[2]*this.dispScale]}),d=r.length,f=new Float32Array(d*3*3),h=new Float32Array(d*3*3),p=new Float32Array(d*3*3),{colors:g}=Wr(c,n,s,this.colormapName);let x=0;const b=new Y,E=new Y,I=new Y,R=new Y,y=new Y,C=new Y;for(let M=0;M<d;M++){const A=r[M];if(!Em(A,l,c,this.threshold,this.clipConfig,this._bbox))continue;const[T,j,ne]=A,se=l[T],Q=l[j],U=l[ne],N=x*9;f[N+0]=se[0],f[N+1]=se[1],f[N+2]=se[2],f[N+3]=Q[0],f[N+4]=Q[1],f[N+5]=Q[2],f[N+6]=U[0],f[N+7]=U[1],f[N+8]=U[2],h[N+0]=g[T*3],h[N+1]=g[T*3+1],h[N+2]=g[T*3+2],h[N+3]=g[j*3],h[N+4]=g[j*3+1],h[N+5]=g[j*3+2],h[N+6]=g[ne*3],h[N+7]=g[ne*3+1],h[N+8]=g[ne*3+2],b.set(se[0],se[1],se[2]),E.set(Q[0],Q[1],Q[2]),I.set(U[0],U[1],U[2]),R.subVectors(E,b),y.subVectors(I,b),C.crossVectors(R,y).normalize(),p[N+0]=C.x,p[N+1]=C.y,p[N+2]=C.z,p[N+3]=C.x,p[N+4]=C.y,p[N+5]=C.z,p[N+6]=C.x,p[N+7]=C.y,p[N+8]=C.z,x++}if(x===0)return 0;const $=new en;$.setAttribute("position",new Lt(f.slice(0,x*9),3)),$.setAttribute("color",new Lt(h.slice(0,x*9),3)),$.setAttribute("normal",new Lt(p.slice(0,x*9),3));const S=new ss({vertexColors:!0,side:wn,flatShading:!0,opacity:this.opacity,transparent:this.opacity<1,shininess:30}),P=new W($,S);return P.name=`fem_result_${t.name}`,this.scene.add(P),this._meshes.push(P),console.log(`FEM íë©´ ë ëë§ [${t.name}]: ${x}ê° ì¼ê°í, ${i.length}ê° ë¸ë`),i.length}_renderParticleRegion(t,n,s){const{positions:i,displacements:a}=t;if(!i||i.length===0)return 0;const o=i.map((b,E)=>{const I=(a==null?void 0:a[E])||[0,0,0];return[b[0]+I[0]*this.dispScale,b[1]+I[1]*this.dispScale,b[2]+I[2]*this.dispScale]}),r=Sh(t,this.mode,this.component),{positions:c,scalars:l}=Cd(o,r,this.threshold,this.clipConfig,this._bbox);if(c.length===0)return 0;const{colors:d}=Wr(l,n,s,this.colormapName),f=c.length,h=new Float32Array(f*3);for(let b=0;b<f;b++)h[b*3]=c[b][0],h[b*3+1]=c[b][1],h[b*3+2]=c[b][2];const p=new en;p.setAttribute("position",new Lt(h,3)),p.setAttribute("color",new Lt(d,3));const g=new Jr({size:this.particleSize,vertexColors:!0,sizeAttenuation:!0,depthTest:!0,opacity:this.opacity,transparent:this.opacity<1}),x=new sr(p,g);return x.name=`particle_result_${t.name}`,this.scene.add(x),this._points||(this._points=x,this._geometry=p),console.log(`ìì ë ëë§ [${t.name}]: ${f}ê° ìì`),f}_renderLegacyPoints(t,n){const s=this.data.displacements.length>0?this._getDeformedPositions():[];if(s.length===0)return 0;const i=Eh(this.data,this.mode,this.component);if(!i||i.length===0)return 0;const{positions:a,scalars:o}=Cd(s,i,this.threshold,this.clipConfig,this._bbox);if(a.length===0)return 0;const r=a.length,{colors:c}=Wr(o,t,n,this.colormapName);this._geometry=new en;const l=new Float32Array(r*3);for(let f=0;f<r;f++)l[f*3]=a[f][0],l[f*3+1]=a[f][1],l[f*3+2]=a[f][2];this._geometry.setAttribute("position",new Lt(l,3)),this._geometry.setAttribute("color",new Lt(c,3));const d=new Jr({size:this.particleSize,vertexColors:!0,sizeAttenuation:!0,depthTest:!0,opacity:this.opacity,transparent:this.opacity<1});return this._points=new sr(this._geometry,d),this._points.name="analysis_result",this.scene.add(this._points),r}clear(){this._points&&(this.scene.remove(this._points),this._points=null),this._geometry&&(this._geometry.dispose(),this._geometry=null);for(const n of this._meshes)this.scene.remove(n),n.geometry.dispose(),n.material.dispose();this._meshes=[];const t=[];this.scene.traverse(n=>{(n.name.startsWith("fem_result_")||n.name.startsWith("particle_result_")||n.name==="analysis_result")&&t.push(n)}),t.forEach(n=>this.scene.remove(n))}getDataRange(){return{min:this.stats.currentMin,max:this.stats.currentMax}}getColorbarCSS(){return tc(this.colormapName,20)}_computeBBox(){var t,n;if(this._bbox.makeEmpty(),(t=this.data)!=null&&t.fem_regions)for(const s of this.data.fem_regions)for(const i of s.nodes)this._bbox.expandByPoint(new Y(i[0],i[1],i[2]));if((n=this.data)!=null&&n.particle_regions)for(const s of this.data.particle_regions)for(const i of s.positions||[])this._bbox.expandByPoint(new Y(i[0],i[1],i[2]));if(this._cachedPositions)for(const s of this._cachedPositions)this._bbox.expandByPoint(new Y(s[0],s[1],s[2]))}_getDeformedPositions(){const t=this.data.displacements,n=t.length;if(this._cachedPositions){const s=[];for(let i=0;i<Math.min(n,this._cachedPositions.length);i++){const a=this._cachedPositions[i],o=t[i]||[0,0,0];s.push([a[0]+o[0]*this.dispScale,a[1]+o[1]*this.dispScale,a[2]+o[2]*this.dispScale])}return s}return t}cachePositions(t){this._cachedPositions=t,this._computeBBox()}savePreOpResults(){return this.data?JSON.parse(JSON.stringify(this.data)):null}showComparison(t){if(!t||!this.data)return;const n=t.displacements,s=this.data.displacements,i=Math.min(n.length,s.length),a=[];for(let r=0;r<i;r++)a.push([(s[r][0]||0)-(n[r][0]||0),(s[r][1]||0)-(n[r][1]||0),(s[r][2]||0)-(n[r][2]||0)]);const o={...this.data,displacements:a,info:{...this.data.info,method:"difference"}};this.loadResults(o)}filterByRegion(t,n){if(!this._points||!this._geometry||n<=0){this._points&&(this._points.visible=!0);return}const s=this._geometry.attributes.position,i=this._geometry.attributes.color;if(!s||!i)return;const a=n*n,o=t.x,r=t.y,c=t.z;for(let l=0;l<s.count;l++){const d=s.getX(l),f=s.getY(l),h=s.getZ(l),p=d-o,g=f-r,x=h-c;p*p+g*g+x*x>a&&i.setXYZ(l,.5,.5,.5)}i.needsUpdate=!0}}async function Ml(){const e=H.manager;if(!e)return;await Oo();const t={};if(H.models.forEach(n=>{t[n.name]=n.mesh}),w.preProcessor||(w.preProcessor=new _m(e.scene,t,yn)),w.postProcessor||(w.postProcessor=new Cm(e.scene)),!tt.client){const n=new kh;tt.client=n,n.onConnect(()=>tt.setConnected(!0)),n.onDisconnect(()=>{tt.setConnected(!1),tt.reconnectAttempt++}),n.onProgress(Bm),n.onResult(Um),n.onError(Ym),n.onCancelled(Zm),n.connect()}}async function Pm(){var c;const e=w.preProcessor,t=tt.client;if(!e||!(t!=null&&t.connected)){F.toast("ìë²ì ì°ê²°ëì§ ììê±°ë ì ì²ë¦¬ê¸°ê° ì´ê¸°íëì§ ìììµëë¤","error");return}const n=w.validationErrors;if(n.length>0){F.toast(`í´ì ë¶ê°: ${n.join(", ")}`,"error");return}w.lastError=null,w.elapsedMs=0;const s=Date.now(),i=e.buildAnalysisRequest(w.method);if(!i)return;const a=i.materials.some(l=>l.method==="fem"&&l.nodes&&l.nodes.length>0),o=i.positions.length>0;if(!a&&!o){F.toast("í´ìí  ë©ì¬ ë°ì´í° ëë ììê° ììµëë¤","error");return}o&&((c=w.postProcessor)==null||c.cachePositions(i.positions)),w.isRunning=!0,w.progress=0,w.progressMessage="Submitting analysis...",F.statusMessage=`Running ${w.method.toUpperCase()} analysis...`;const r=setInterval(()=>{w.isRunning?w.elapsedMs=Date.now()-s:clearInterval(r)},100);t.sendAnalysis(i)}function qr(){const e=tt.client;e&&(e.cancelAnalysis(),w.isRunning=!1,w.progressMessage="",F.toast("í´ì ì·¨ì ìì²­ì ì ì¡íìµëë¤","info"))}function Am(){var e;(e=w.preProcessor)==null||e.addFixedBC(),w.updateBCCount()}function Pd(e){const t=w.preProcessor;if(!t)return;const n=t.getBrushSelectionCentroid();n&&(w.forceBCOrigin=[n.x,n.y,n.z]),t.addForceBC(e),w.updateBCCount()}function Ad(){var e;(e=w.preProcessor)==null||e.removeLastBC(),w.updateBCCount()}function Tm(){var e;(e=w.preProcessor)==null||e.clearAllBC(),w.updateBCCount()}function Td(e,t){var n;(n=w.preProcessor)==null||n.assignMaterial(e,t),w.updateMaterialCount()}function Rd(e,t){w.solverAssignments={...w.solverAssignments,[e]:t},w.preProcessor&&(w.preProcessor.solverAssignments[e]=t)}function Rm(e){w.method=e}function Dm(e){w.postMode=e;const t=w.postProcessor;t&&(t.setMode(e),w.syncFromPostProcessor(),w.rangeMin=t.stats.currentMin,w.rangeMax=t.stats.currentMax,w.thresholdLower=t.stats.currentMin,w.thresholdUpper=t.stats.currentMax,w.useCustomRange=!1)}function zm(e){w.component=e;const t=w.postProcessor;t&&(t.setComponent(e),w.syncFromPostProcessor(),w.rangeMin=t.stats.currentMin,w.rangeMax=t.stats.currentMax,w.thresholdLower=t.stats.currentMin,w.thresholdUpper=t.stats.currentMax,w.useCustomRange=!1)}function Im(e){w.colormap=e;const t=w.postProcessor;t&&(t.setColormap(e),w.syncFromPostProcessor())}function Lm(e){var t;w.dispScale=e,(t=w.postProcessor)==null||t.setDisplacementScale(e),w.syncFromPostProcessor()}function Om(e){var t;w.particleSize=e,(t=w.postProcessor)==null||t.setParticleSize(e)}function Fm(e){var t;w.opacity=e,(t=w.postProcessor)==null||t.setOpacity(e)}function Wo(e,t,n,s){var i;w.clipEnabled=e,t!==void 0&&(w.clipAxis=t),n!==void 0&&(w.clipPosition=n),s!==void 0&&(w.clipInvert=s),(i=w.postProcessor)==null||i.setClipPlane({enabled:e,axis:w.clipAxis,position:w.clipPosition,invert:w.clipInvert}),w.syncFromPostProcessor()}function Nm(){var t;const e=(t=w.postProcessor)==null?void 0:t.savePreOpResults();e&&(w.hasPreOpResult=!0,Sl=e)}let Sl=null;function $m(){var e;Sl&&((e=w.postProcessor)==null||e.showComparison(Sl))}function Hm(){const e=w.postProcessor;if(!e||!e.data){F.toast("ë´ë³´ë¼ ê²°ê³¼ê° ììµëë¤","warn");return}const{displacements:t,stress:n,damage:s,info:i}=e.data,a=["node,dx,dy,dz,von_mises_stress,damage"],o=(t==null?void 0:t.length)??0;for(let d=0;d<o;d++){const f=(t==null?void 0:t[d])??[0,0,0];let h=0;if(Array.isArray(n)){const g=n[d];h=typeof g=="number"?g:Array.isArray(g)?g[0]:0}const p=(s==null?void 0:s[d])??0;a.push(`${d},${f[0]},${f[1]},${f[2]},${h},${p}`)}const r=a.join(`
`),l=`analysis_${(i==null?void 0:i.method)??"unknown"}_${o}pts.csv`;jm(r,l,"text/csv"),F.toast(`CSV ë´ë³´ë´ê¸° ìë£: ${l}`,"success")}function jm(e,t,n){const s=new Blob([e],{type:n}),i=URL.createObjectURL(s),a=document.createElement("a");a.href=i,a.download=t,a.click(),URL.revokeObjectURL(i)}function Bm(e){w.progress=e.progress,w.progressMessage=e.message??e.step}function Um(e){var s,i;w.isRunning=!1,w.hasResult=!0,w.lastError=null,(s=w.postProcessor)==null||s.loadResults(e),w.syncFromPostProcessor();const t=w.postProcessor;t&&(w.rangeMin=t.stats.currentMin,w.rangeMax=t.stats.currentMax,w.thresholdLower=t.stats.currentMin,w.thresholdUpper=t.stats.currentMax);const n=(w.elapsedMs/1e3).toFixed(1);F.statusMessage=`Analysis complete (${(i=e.info)==null?void 0:i.method}) â ${n}s`,F.toast(`í´ì ìë£ (${n}ì´)`,"success"),F.activeTab="postprocess"}function Zm(e){w.isRunning=!1,w.progressMessage="",w.lastError="ì¬ì©ìê° í´ìì ì·¨ìíìµëë¤",F.statusMessage="Analysis cancelled",F.toast("í´ìì´ ì·¨ìëììµëë¤","warn")}function Ym(e){w.isRunning=!1,w.progressMessage="",w.lastError=e.message,F.statusMessage=`Analysis error: ${e.message}`,F.toast(`í´ì ì¤í¨: ${e.message}`,"error"),console.error("í´ì ìë¬:",e.message)}var Gm=ee('<div class="edit3d-hint svelte-inlcgv">ë·°í¬í¸ìì ëëê·¸ â ë°©í¥ ë³ê²½. í¬ê¸°ë ìë ì¬ë¼ì´ë.</div>'),Vm=ee("<button> </button>"),Xm=ee('<div style="margin-top:8px; border-top:1px dashed #ff9999; padding-top:8px;"><div class="force-header svelte-inlcgv"><span class="subsection-label svelte-inlcgv" style="margin:0">ð¯ ë°©í¥/í¬ê¸° í¸ì§</span> <button title="ë·°í¬í¸ìì íì´í í¸ë¤ë¡ ì§ì  í¸ì§"><!></button></div> <!> <div class="force-mag-section svelte-inlcgv"><span class="subsection-label svelte-inlcgv">ð í¬ê¸° (N)</span> <div class="mag-presets svelte-inlcgv"></div> <div class="mag-input-row svelte-inlcgv"><input type="range" min="1" max="2000" step="1" class="mag-slider svelte-inlcgv"/> <input type="number" min="1" max="10000" step="1" class="mag-number svelte-inlcgv"/> <span class="mag-unit svelte-inlcgv">N</span></div></div> <div class="force-dir-section svelte-inlcgv"><span class="subsection-label svelte-inlcgv">ð§­ ë°©í¥</span> <div class="dir-presets svelte-inlcgv"><button title="ìì¶ (ìë)"><span class="dir-arrow svelte-inlcgv">â</span><span class="dir-text svelte-inlcgv">ìì¶</span></button> <button title="ì¸ì¥ (ì)"><span class="dir-arrow svelte-inlcgv">â</span><span class="dir-text svelte-inlcgv">ì¸ì¥</span></button> <button title="ì¸¡ë°© (+X)"><span class="dir-arrow svelte-inlcgv">â</span><span class="dir-text svelte-inlcgv">ì¸¡ë°©</span></button> <button title="ì ë°© (+Z)"><span class="dir-arrow svelte-inlcgv">â</span><span class="dir-text svelte-inlcgv">ì ë°©</span></button> <button class="dir-btn svelte-inlcgv" title="ì ë°©êµ´ê³¡"><span class="dir-arrow svelte-inlcgv">â</span><span class="dir-text svelte-inlcgv">êµ´ê³¡</span></button> <button class="dir-btn svelte-inlcgv" title="íë°©ì ì "><span class="dir-arrow svelte-inlcgv">â</span><span class="dir-text svelte-inlcgv">ì ì </span></button></div> <div class="dir-xyz svelte-inlcgv"><div class="dir-axis svelte-inlcgv"><span class="axis-label x svelte-inlcgv">X</span> <input type="number" step="0.1" min="-1" max="1" class="svelte-inlcgv"/></div> <div class="dir-axis svelte-inlcgv"><span class="axis-label y svelte-inlcgv">Y</span> <input type="number" step="0.1" min="-1" max="1" class="svelte-inlcgv"/></div> <div class="dir-axis svelte-inlcgv"><span class="axis-label z svelte-inlcgv">Z</span> <input type="number" step="0.1" min="-1" max="1" class="svelte-inlcgv"/></div></div></div> <div class="force-preview svelte-inlcgv"><span class="force-preview-label svelte-inlcgv">F =</span> <span class="force-preview-val svelte-inlcgv"> </span> <span class="force-preview-unit svelte-inlcgv">N</span></div> <button class="tool-btn force-apply-btn svelte-inlcgv"> </button></div>'),Wm=ee('<div class="panel svelte-inlcgv"><h3 class="svelte-inlcgv">PRE-PROCESS</h3> <div class="section svelte-inlcgv"><div class="section-title svelte-inlcgv">Brush Selection</div> <div class="slider-row svelte-inlcgv"><label for="brush-radius" class="svelte-inlcgv">ë°ê²½</label> <input id="brush-radius" type="range" min="1" max="15" step="0.5" class="svelte-inlcgv"/> <span class="val svelte-inlcgv"> </span></div> <div class="hint svelte-inlcgv">ëª¨ë¸ ììì í´ë¦­/ëëê·¸ë¡ ìì­ ì í</div> <button> </button> <button class="tool-btn secondary svelte-inlcgv">Clear Selection</button></div> <div class="section bc-section fixed svelte-inlcgv"><div class="section-title svelte-inlcgv" style="color: #00cc44;">Step 1: Fixed BC (ê³ ì )</div> <div class="hint svelte-inlcgv">ë¸ë¬ì¬ë¡ ìì­ ì í â ê³ ì  ì ì©</div> <button class="tool-btn svelte-inlcgv" style="background: #00cc44;">Apply Fixed BC</button></div> <div class="section bc-section force svelte-inlcgv"><div class="section-title svelte-inlcgv" style="color:#ff2222;">Step 2: Force BC (íì¤)</div> <div class="hint svelte-inlcgv">1) ë¸ë¬ì¬ë¡ ìì­ ì í â 2) Apply â 3) ë°©í¥/í¬ê¸° í¸ì§</div> <button class="tool-btn force-apply-btn svelte-inlcgv"> </button> <!></div> <div class="section svelte-inlcgv"><div class="bc-info svelte-inlcgv"><span>BCs: <strong> </strong></span> <button class="tool-btn-sm svelte-inlcgv">Remove Last</button></div> <button class="tool-btn secondary svelte-inlcgv">Clear All BC</button></div> <div class="section hint-section svelte-inlcgv"><span class="hint-text svelte-inlcgv">ð¡ ì¬ë£ ì¤ì ì <button class="link-btn svelte-inlcgv">Material í­</button> ìì ê´ë¦¬í©ëë¤</span></div></div>');function Km(e,t){sn(t,!0),Iu(()=>{H.models.length>0&&!w.preProcessor&&Ml()});let n=z(100),s=z(0),i=z(-1),a=z(0),o=xt(()=>H.models.length>0),r=xt(()=>Math.sqrt(u(s)*u(s)+u(i)*u(i)+u(a)*u(a))),c=xt(()=>({x:(u(r)>0?u(s)/u(r):0)*u(n),y:(u(r)>0?u(i)/u(r):0)*u(n),z:(u(r)>0?u(a)/u(r):0)*u(n)}));or(()=>{const[Z,ie,re]=q.forceVector,pe=Math.sqrt(Z*Z+ie*ie+re*re);pe>.001&&(k(n,Math.round(pe),!0),k(s,+(Z/pe).toFixed(3)),k(i,+(ie/pe).toFixed(3)),k(a,+(re/pe).toFixed(3)))});function l(){if(u(r)<.001)return;const Z=u(s)/u(r),ie=u(i)/u(r),re=u(a)/u(r);q.forceVector=[+(Z*u(n)).toFixed(2),+(ie*u(n)).toFixed(2),+(re*u(n)).toFixed(2)]}function d(){var Z,ie,re,pe;if(q.forceEditMode3D=!q.forceEditMode3D,q.forceEditMode3D){l();const V=H.forceArrowHandle;if(V){const J=new mn,le=Object.values(It);le.length>0?le.forEach(Ce=>J.expandByObject(Ce)):H.models.forEach(Ce=>J.expandByObject(Ce.mesh));const _e=J.isEmpty()?80:J.max.y-J.min.y;V.setScale(Math.max(1,_e/80));const be=(Z=w.preProcessor)==null?void 0:Z.getBrushSelectionCentroid();if(be)V.setOrigin(be),F.toast("3D Force í¸ì§ íì±í â ë¸ë¬ì¬ ì í ì¤ì¬ìì ìì","info");else if(w.forceBCOrigin){const[Ce,Be,at]=w.forceBCOrigin;V.setOrigin(new Y(Ce,Be,at)),F.toast("3D Force í¸ì§ íì±í â íì¤ ìì­ ì¤ì¬ìì ìì","info")}else if(!J.isEmpty()){const Ce=J.getCenter(new Y);V.setOrigin(Ce),F.toast("â  Force BC ìì­ì ë¨¼ì  ë¸ë¬ì¬ë¡ ì íí ë¤ Apply Force BCë¥¼ í´ë¦­íì¸ì","warn")}}(ie=H.forceArrowHandle)==null||ie.setVisible(!0),(re=H.forceArrowHandle)==null||re.syncFromForceVector()}else(pe=H.forceArrowHandle)==null||pe.setVisible(!1),F.toast("3D Force í¸ì§ ë¹íì±í","info")}async function f(){if(!u(o)){F.toast("ëª¨ë¸ì ë¨¼ì  ë¡ëíì¸ì","warn");return}w.preProcessor||(F.toast("ì ì²ë¦¬ ì´ê¸°í ì¤... (ë³µìí)","info"),await Ml()),q.setMode(q.mode==="brush"?"none":"brush")}let h=xt(()=>w.forceBCOrigin!==null);function p(){var J;if(!u(o)){F.toast("ëª¨ë¸ì ë¨¼ì  ë¡ëíì¸ì","warn");return}const Z=((J=w.preProcessor)==null?void 0:J.getBrushSelectionCount())??0;if(Z===0){F.toast("â  ë¨¼ì  Brushë¡ Force ìì­ì ì ííì¸ì","warn");return}const ie=u(r)>.01?u(s)/u(r):0,re=u(r)>.01?u(i)/u(r):-1,pe=u(r)>.01?u(a)/u(r):0,V=[ie*u(n),re*u(n),pe*u(n)];Pd(V),F.toast(`Force BC ì ì© (${Z}ê° ë³µì, ${u(n)}N) â ë°©í¥/í¬ê¸°ë¥¼ í¸ì§íì¸ì`,"success"),!q.forceEditMode3D&&w.forceBCOrigin&&d()}function g(){if(!u(o)||u(r)<.01)return;Ad();const Z=u(s)/u(r),ie=u(i)/u(r),re=u(a)/u(r),pe=[Z*u(n),ie*u(n),re*u(n)];Pd(pe),F.toast(`Force BC ìë°ì´í¸: ${u(n)}N â (${Z.toFixed(1)}, ${ie.toFixed(1)}, ${re.toFixed(1)})`,"success")}function x(){if(!u(o)){F.toast("ëª¨ë¸ì ë¨¼ì  ë¡ëíì¸ì","warn");return}Am(),F.toast("Fixed BC ì ì©ë¨","success")}function b(Z,ie,re){var pe;k(s,Z,!0),k(i,ie,!0),k(a,re,!0),q.forceEditMode3D&&(l(),(pe=H.forceArrowHandle)==null||pe.syncFromForceVector())}function E(Z){var ie;k(n,Z,!0),q.forceEditMode3D&&(l(),(ie=H.forceArrowHandle)==null||ie.syncFromForceVector())}function I(Z){var re;const ie=parseFloat(Z.target.value);!isNaN(ie)&&ie>0&&(k(n,ie,!0),q.forceEditMode3D&&(l(),(re=H.forceArrowHandle)==null||re.syncFromForceVector()))}function R(Z){var re;const ie=parseFloat(Z.target.value);k(n,ie,!0),q.forceEditMode3D&&(l(),(re=H.forceArrowHandle)==null||re.syncFromForceVector())}function y(){var Z;q.forceEditMode3D&&(l(),(Z=H.forceArrowHandle)==null||Z.syncFromForceVector())}async function C(){if(w.bcCount===0)return;await F.confirm("BC ì ì²´ ì­ì ",`${w.bcCount}ê° ê²½ê³ì¡°ê±´ì ëª¨ë ì­ì í©ëë¤.`)&&(Tm(),F.toast("ëª¨ë  BC ì­ì ë¨","info"))}var $=Wm(),S=_(m($),2),P=_(m(S),2),M=_(m(P),2),A=_(M,2),T=m(A),j=_(P,4);let ne;var se=m(j),Q=_(j,2),U=_(S,2),N=_(m(U),4),oe=_(U,2),ae=_(m(oe),4),ve=m(ae),He=_(ae,2);{var Ae=Z=>{var ie=Xm(),re=m(ie),pe=_(m(re),2);let V;var J=m(pe);{var le=xe=>{var Le=Fi("ð¯ 3D í¸ì§ ON");K(xe,Le)},_e=xe=>{var Le=Fi("ð¯ 3D í¸ì§");K(xe,Le)};Me(J,xe=>{q.forceEditMode3D?xe(le):xe(_e,!1)})}var be=_(re,2);{var Ce=xe=>{var Le=Gm();K(xe,Le)};Me(be,xe=>{q.forceEditMode3D&&xe(Ce)})}var Be=_(be,2),at=_(m(Be),2);Zt(at,20,()=>[50,100,200,500,1e3],Dn,(xe,Le)=>{var pt=Vm();let js;var xr=m(pt);he(()=>{js=Oe(pt,1,"mag-btn svelte-inlcgv",null,js,{active:u(n)===Le}),B(xr,Le)}),D("click",pt,()=>E(Le)),K(xe,pt)});var Ge=_(at,2),Je=m(Ge),ht=_(Je,2),ot=_(Be,2),gt=_(m(ot),2),ft=m(gt);let ce;var de=_(ft,2);let We;var nt=_(de,2);let st;var X=_(nt,2);let fe;var Ue=_(X,2),it=_(Ue,2),bt=_(gt,2),ze=m(bt),we=_(m(ze),2),Ze=_(ze,2),rt=_(m(Ze),2),et=_(Ze,2),me=_(m(et),2),Te=_(ot,2),Pe=_(m(Te),2),Ie=m(Pe),ye=_(Te,2),lt=m(ye);he((xe,Le,pt)=>{V=Oe(pe,1,"edit3d-btn svelte-inlcgv",null,V,{"edit3d-active":q.forceEditMode3D}),_t(Je,u(n)),_t(ht,u(n)),ce=Oe(ft,1,"dir-btn svelte-inlcgv",null,ce,{active:u(s)===0&&u(i)===-1&&u(a)===0}),We=Oe(de,1,"dir-btn svelte-inlcgv",null,We,{active:u(s)===0&&u(i)===1&&u(a)===0}),st=Oe(nt,1,"dir-btn svelte-inlcgv",null,st,{active:u(s)===1&&u(i)===0&&u(a)===0}),fe=Oe(X,1,"dir-btn svelte-inlcgv",null,fe,{active:u(s)===0&&u(i)===0&&u(a)===1}),B(Ie,`(${xe??""}, ${Le??""}, ${pt??""})`),ye.disabled=!u(o)||u(r)<.01,B(lt,`Force BC ìë°ì´í¸ (${u(n)??""}N)`)},[()=>u(c).x.toFixed(0),()=>u(c).y.toFixed(0),()=>u(c).z.toFixed(0)]),D("click",pe,d),D("input",Je,R),D("change",ht,I),D("click",ft,()=>b(0,-1,0)),D("click",de,()=>b(0,1,0)),D("click",nt,()=>b(1,0,0)),D("click",X,()=>b(0,0,1)),D("click",Ue,()=>b(0,-.7,-.7)),D("click",it,()=>b(0,-.7,.7)),D("change",we,y),ys(we,()=>u(s),xe=>k(s,xe)),D("change",rt,y),ys(rt,()=>u(i),xe=>k(i,xe)),D("change",me,y),ys(me,()=>u(a),xe=>k(a,xe)),D("click",ye,g),K(Z,ie)};Me(He,Z=>{u(h)&&Z(Ae)})}var Ve=_(oe,2),je=m(Ve),Qe=m(je),Se=_(m(Qe)),Ye=m(Se),Xe=_(Qe,2),ut=_(je,2),Mt=_(Ve,2),G=m(Mt),te=_(m(G));he(Z=>{B(T,`${Z??""} mm`),ne=Oe(j,1,"tool-btn svelte-inlcgv",null,ne,{active:q.mode==="brush"}),j.disabled=!u(o),B(se,`Brush: ${q.mode==="brush"?"ON":"OFF"}`),Q.disabled=!u(o),N.disabled=!u(o),ae.disabled=!u(o),B(ve,`Apply Force BC (${u(n)??""}N)`),B(Ye,w.bcCount),Xe.disabled=w.bcCount===0,ut.disabled=w.bcCount===0},[()=>q.brushRadius.toFixed(1)]),ys(M,()=>q.brushRadius,Z=>q.brushRadius=Z),D("click",j,f),D("click",Q,()=>{var Z;return(Z=w.preProcessor)==null?void 0:Z.clearBrushSelection()}),D("click",N,x),D("click",ae,p),D("click",Xe,()=>Ad()),D("click",ut,C),D("click",te,()=>F.activeTab="material"),K(e,$),an()}Xn(["click","input","change"]);const Zs={linear_elastic:{label:"Linear Elastic",labelKo:"ì í íì±",description:"ìë³í ì í íì± â ëª¨ë  ìë² ì§ì",params:["E","nu","density"],femOnly:!1},neo_hookean:{label:"Neo-Hookean",labelKo:"Neo-Hookean",description:"ëë³í ìì¶ì± ì´íì± â FEM ì ì©",params:["E","nu","density"],femOnly:!0},mooney_rivlin:{label:"Mooney-Rivlin",labelKo:"Mooney-Rivlin",description:"2-íë¼ë¯¸í° ì´íì± â ì°ì¡°ì§/ëì¤í¬ì ì í©, FEM ì ì©",params:["C10","C01","D1","density"],femOnly:!0},ogden:{label:"Ogden",labelKo:"Ogden",description:"N-í­ ì´íì± â ìì²´ ì¡°ì§ ëë³í, FEM ì ì©",params:["mu_ogden","alpha_ogden","D1","density"],femOnly:!0}},qm={all:"ì ì²´",bone:"ë¼",disc:"ëì¤í¬",implant:"ìíëí¸",soft_tissue:"ì°ì¡°ì§",custom:"ì»¤ì¤í"},Qm=[{key:"cortical_bone",category:"bone",label:"Cortical Bone",labelKo:"í¼ì§ê³¨",E:15e9,nu:.3,density:1850,description:"ê±´ê°í í¼ì§ê³¨ (Cortical bone)",isCustom:!1,isPathological:!1,constitutiveModel:"linear_elastic"},{key:"cancellous_bone",category:"bone",label:"Cancellous Bone",labelKo:"í´ë©´ê³¨",E:1e9,nu:.3,density:1100,description:"ê±´ê°í í´ë©´ê³¨ (Cancellous/Trabecular bone)",isCustom:!1,isPathological:!1,constitutiveModel:"linear_elastic"},{key:"osteoporotic_cortical",category:"bone",label:"Osteoporotic Cortical",labelKo:"ê³¨ë¤ê³µì¦ í¼ì§ê³¨",E:8e9,nu:.3,density:1400,description:"ê³¨ë¤ê³µì¦ í¼ì§ê³¨ (T-score â¤ -2.5)",isCustom:!1,isPathological:!0,constitutiveModel:"linear_elastic"},{key:"osteoporotic_cancellous",category:"bone",label:"Osteoporotic Cancellous",labelKo:"ê³¨ë¤ê³µì¦ í´ë©´ê³¨",E:3e8,nu:.3,density:600,description:"ê³¨ë¤ê³µì¦ í´ë©´ê³¨ â ê³¨ë°ë íì  ê°ì",isCustom:!1,isPathological:!0,constitutiveModel:"linear_elastic"},{key:"sclerotic_bone",category:"bone",label:"Sclerotic Bone",labelKo:"ê²½íê³¨",E:2e10,nu:.3,density:2e3,description:"ê²½íê³¨ (Sclerotic bone) â ê³¨ë°ë ë¹ì ì ì¦ê°",isCustom:!1,isPathological:!0,constitutiveModel:"linear_elastic"},{key:"disc_normal",category:"disc",label:"Normal Disc",labelKo:"ì ì ëì¤í¬",E:1e7,nu:.45,density:1200,description:"ê±´ê°í ì¶ê°í (Intervertebral disc)",isCustom:!1,isPathological:!1,constitutiveModel:"linear_elastic"},{key:"disc_grade3",category:"disc",label:"Degenerated Disc III",labelKo:"í´í ëì¤í¬ III",E:2e7,nu:.4,density:1150,description:"í´íì± ëì¤í¬ Pfirrmann Grade III â ìíµ ë¶ê· ì§í",isCustom:!1,isPathological:!0,constitutiveModel:"linear_elastic"},{key:"disc_grade4",category:"disc",label:"Degenerated Disc IV",labelKo:"í´í ëì¤í¬ IV",E:4e7,nu:.35,density:1100,description:"í´íì± ëì¤í¬ Pfirrmann Grade IV â ëì´ ê°ì, ìíµ ìì¤",isCustom:!1,isPathological:!0,constitutiveModel:"linear_elastic"},{key:"disc_grade5",category:"disc",label:"Degenerated Disc V",labelKo:"í´í ëì¤í¬ V",E:8e7,nu:.3,density:1050,description:"í´íì± ëì¤í¬ Pfirrmann Grade V â ìì  ë¶ê´´, ì¬ì í",isCustom:!1,isPathological:!0,constitutiveModel:"linear_elastic"},{key:"ligament",category:"soft_tissue",label:"Ligament",labelKo:"ì¸ë",E:5e7,nu:.4,density:1100,description:"ì²ì¶ ì¸ë (Spinal ligament)",isCustom:!1,isPathological:!1,constitutiveModel:"linear_elastic"},{key:"calcified_ligament",category:"soft_tissue",label:"Calcified Ligament",labelKo:"ìíí ì¸ë",E:2e8,nu:.35,density:1300,description:"ìíí ì¸ë â ë¹ì ì ê²½ì§, í©ìì¸ë ë¹í ë±",isCustom:!1,isPathological:!0,constitutiveModel:"linear_elastic"},{key:"soft_tissue",category:"soft_tissue",label:"Soft Tissue",labelKo:"ì°ì¡°ì§",E:1e6,nu:.49,density:1050,description:"ì¼ë° ì°ì¡°ì§ (ê·¼ì¡, ì§ë°© ë±)",isCustom:!1,isPathological:!1,constitutiveModel:"linear_elastic"},{key:"titanium",category:"implant",label:"Ti-6Al-4V",labelKo:"í°íë í©ê¸",E:11e10,nu:.34,density:4500,description:"Ti-6Al-4V â ì²ì¶ ëì¬/ë¡ë íì¤ ì¬ì§",isCustom:!1,isPathological:!1,constitutiveModel:"linear_elastic"},{key:"peek",category:"implant",label:"PEEK",labelKo:"PEEK",E:4e9,nu:.38,density:1320,description:"Polyether-ether-ketone â ì¶ê°ì²´ ì¼ì´ì§ ì¬ì§",isCustom:!1,isPathological:!1,constitutiveModel:"linear_elastic"},{key:"cobalt_chrome",category:"implant",label:"CoCr Alloy",labelKo:"ì½ë°í¸-í¬ë¡¬",E:23e10,nu:.3,density:8300,description:"CoCr í©ê¸ â ê³ ê°ë ìíëí¸",isCustom:!1,isPathological:!1,constitutiveModel:"linear_elastic"},{key:"stainless_steel",category:"implant",label:"316L SS",labelKo:"ì¤íì¸ë¦¬ì¤ê° 316L",E:2e11,nu:.3,density:7900,description:"316L ì¤íì¸ë¦¬ì¤ê° â ê²½ì ì  ìíëí¸",isCustom:!1,isPathological:!1,constitutiveModel:"linear_elastic"},{key:"uhmwpe",category:"implant",label:"UHMWPE",labelKo:"ì´ê³ ë¶ì PE",E:7e8,nu:.46,density:930,description:"ì´ê³ ë¶ìë í´ë¦¬ìí¸ë  â ë² ì´ë§ë©´ ì¬ì§",isCustom:!1,isPathological:!1,constitutiveModel:"linear_elastic"}],Dd="pysim-custom-materials";var yo,wo,xo;class Jm{constructor(){L(this,yo,z(Qt([...Qm])));L(this,wo,z("all"));L(this,xo,z(""));this._loadCustomFromStorage()}get entries(){return u(v(this,yo))}set entries(t){k(v(this,yo),t,!0)}get activeCategory(){return u(v(this,wo))}set activeCategory(t){k(v(this,wo),t,!0)}get searchQuery(){return u(v(this,xo))}set searchQuery(t){k(v(this,xo),t,!0)}get filtered(){let t=this.entries;this.activeCategory!=="all"&&(t=t.filter(s=>s.category===this.activeCategory));const n=this.searchQuery.trim().toLowerCase();return n&&(t=t.filter(s=>s.label.toLowerCase().includes(n)||s.labelKo.includes(n)||s.description.includes(n)||s.key.includes(n))),t}getByCategory(t){return this.entries.filter(n=>n.category===t)}getByKey(t){return this.entries.find(n=>n.key===t)}addCustom(t){const n=`custom_${Date.now()}`,s={key:n,category:"custom",label:t.label,labelKo:t.labelKo,E:t.E,nu:t.nu,density:t.density,description:t.description??`ì¬ì©ì ì ì ì¬ë£: ${t.labelKo}`,isCustom:!0,isPathological:!1,constitutiveModel:t.constitutiveModel??"linear_elastic",C10:t.C10,C01:t.C01,D1:t.D1,mu_ogden:t.mu_ogden,alpha_ogden:t.alpha_ogden};return this.entries=[...this.entries,s],this._saveCustomToStorage(),n}removeCustom(t){this.entries=this.entries.filter(n=>n.key!==t||!n.isCustom),this._saveCustomToStorage()}_saveCustomToStorage(){try{const t=this.entries.filter(n=>n.isCustom);localStorage.setItem(Dd,JSON.stringify(t))}catch{}}_loadCustomFromStorage(){try{const t=localStorage.getItem(Dd);if(!t)return;const n=JSON.parse(t);if(Array.isArray(n)&&n.length>0){const s=new Set(this.entries.map(a=>a.key)),i=n.filter(a=>!s.has(a.key)).map(a=>({...a,isCustom:!0,category:"custom"}));this.entries=[...this.entries,...i]}}catch{}}}yo=new WeakMap,wo=new WeakMap,xo=new WeakMap;const qn=new Jm;function Ys(e){if(e>=1e9){const n=e/1e9;return`${n>=10?n.toFixed(0):n.toFixed(1)} GPa`}const t=e/1e6;return`${t>=10?t.toFixed(0):t.toFixed(1)} MPa`}function eg(e){return Math.pow(10,5+e/1e3*(11.4-5))}function Ko(e){const s=Math.log10(Math.max(e,1e5));return Math.round((s-5)/(11.4-5)*1e3)}function tg(e,t,n=.5){const s=e/(2*(1+t)),i=e/(3*(1-2*t));return{C10:s/2*n,C01:s/2*(1-n),D1:i>0?2/i:0}}function ng(e,t,n=2){const s=e/(2*(1+t)),i=e/(3*(1-2*t));return{mu_ogden:s,alpha_ogden:n,D1:i>0?2/i:0}}function sg(e){switch(e){case"linear_elastic":return"Linear";case"neo_hookean":return"NeoHook";case"mooney_rivlin":return"M-R";case"ogden":return"Ogden";default:return"Linear"}}var ig=ee('<span class="hint svelte-iy3ody">(ê¸°ë³¸: bone)</span>'),ag=ee('<div class="validation-item svelte-iy3ody"> </div>'),og=ee('<div class="validation-errors svelte-iy3ody"></div>'),rg=ee('<div class="solver-row svelte-iy3ody"><div class="model-name svelte-iy3ody"><span class="solver-dot svelte-iy3ody"></span> <span class="name-text svelte-iy3ody"> </span></div> <select class="cell-select solver-sel svelte-iy3ody"><option>FEM</option><option>PD</option><option>SPG</option></select> <span class="mat-summary svelte-iy3ody"> </span></div>'),lg=ee('<div class="section solver-table-section svelte-iy3ody"><div class="section-title svelte-iy3ody">ëª¨ë¸ë³ ìë² / ì¬ë£</div> <div class="solver-row header-row svelte-iy3ody"><span>ëª¨ë¸</span> <span>ìë²</span> <span>ì¬ë£</span></div> <div class="solver-table svelte-iy3ody"></div> <div class="mat-hint svelte-iy3ody">â» ì¬ë£ ë³ê²½ì Material í­ìì</div> <div class="bulk-row svelte-iy3ody"><span class="bulk-label svelte-iy3ody">ì¼ê´:</span> <button class="bulk-btn svelte-iy3ody">All FEM</button> <button class="bulk-btn svelte-iy3ody">All PD</button> <button class="bulk-btn svelte-iy3ody">All SPG</button></div></div>'),cg=ee('<div class="desc-item svelte-iy3ody"><span class="desc-badge svelte-iy3ody"> </span> <span class="desc-text svelte-iy3ody"> </span></div>'),dg=ee('<span class="run-summary svelte-iy3ody"> </span>'),ug=ee("ð Run Analysis <!>",1),hg=ee('<div class="progress-section svelte-iy3ody"><div class="progress-header svelte-iy3ody"><span class="progress-text svelte-iy3ody"> </span> <button class="cancel-btn svelte-iy3ody">â Cancel</button></div> <div class="progress-bar-bg svelte-iy3ody"><div class="progress-bar svelte-iy3ody"></div></div> <div class="progress-footer svelte-iy3ody"><span class="progress-pct svelte-iy3ody"> </span> <span class="elapsed svelte-iy3ody"> </span></div></div>'),fg=ee('<div class="result-info svelte-iy3ody"> </div>'),pg=ee('<div class="error-msg svelte-iy3ody"> </div>'),vg=ee('<div class="error-msg svelte-iy3ody"> </div>'),_g=ee('<div class="panel svelte-iy3ody"><h3 class="svelte-iy3ody">SOLVE</h3> <div class="section svelte-iy3ody"><div class="status-row svelte-iy3ody"><span></span> <span class="label svelte-iy3ody">Server</span> <span> </span></div></div> <div class="section svelte-iy3ody"><div class="section-title svelte-iy3ody">Checklist</div> <div> </div> <div> </div> <div> </div> <div> <!></div></div> <!> <!> <div class="section svelte-iy3ody"><div class="section-title svelte-iy3ody">ìë² ì¤ëª</div> <div class="solver-descs svelte-iy3ody"></div></div> <button class="run-btn svelte-iy3ody"><!></button> <!> <!> <!></div>');function mg(e,t){sn(t,!0);let n=xt(()=>H.models.length>0&&w.bcCount>0&&!w.isRunning&&tt.connected),s=xt(()=>{const V=[];return H.models.length===0&&V.push("ëª¨ë¸ ë¯¸ë¡ë"),w.bcCount===0&&V.push("ê²½ê³ì¡°ê±´(BC) ë¯¸ì¤ì "),tt.connected||V.push("ìë² ë¯¸ì°ê²°"),V});function i(V){var le;const J=(le=w.preProcessor)==null?void 0:le.materialAssignments[V];return J?J.label:"ë¯¸í ë¹"}function a(V){var _e;const J=(_e=w.preProcessor)==null?void 0:_e.materialAssignments[V];if(!J)return"ì¬ë£ ë¯¸í ë¹ â Material í­ìì ì¤ì ";const le=sg(J.constitutiveModel??"linear_elastic");return`${J.label} [${le}] E=${Ys(J.E)}, Î½=${J.nu}`}function o(V,J){const le=J.target.value;Rd(V,le)}function r(V){Rm(V),H.models.forEach(J=>Rd(J.name,V)),F.toast(`ì ì²´ ëª¨ë¸ â ${l[V]}`,"info")}async function c(){if(!u(n)){u(s).length>0&&F.toast(`í´ì ë¶ê°: ${u(s).join(", ")}`,"error");return}await Ml(),w.preProcessor&&(w.preProcessor.solverAssignments={...w.solverAssignments}),w.materialCount===0&&F.toast("ì¬ë£ ë¯¸í ë¹ â ê¸°ë³¸ bone ì¬ë£ ì ì©","warn"),await Pm()}const l={fem:"FEM",pd:"PD",spg:"SPG"},d={fem:"ì í íì± â ë¹ ë¥´ê³  ì í, íê´´ ë¶ê°",pd:"Peridynamics â íê´´/ê· ì´ ì í",spg:"Meshfree â ëë³í, ë©ì¬ ë¶ì"},f={fem:"#1976d2",pd:"#e53935",spg:"#ff8f00"};let h=xt(()=>()=>{const V=w.solverAssignments,J=w.method,le={};return H.models.forEach(_e=>{const be=V[_e.name]||J;le[be]=(le[be]||0)+1}),Object.entries(le).map(([_e,be])=>`${l[_e]}Ã${be}`).join(", ")});var p=_g(),g=_(m(p),2),x=m(g),b=m(x);let E;var I=_(b,4);let R;var y=m(I),C=_(g,2),$=_(m(C),2);let S;var P=m($),M=_($,2);let A;var T=m(M),j=_(M,2);let ne;var se=m(j),Q=_(j,2);let U;var N=m(Q),oe=_(N);{var ae=V=>{var J=ig();K(V,J)};Me(oe,V=>{w.materialCount===0&&V(ae)})}var ve=_(C,2);{var He=V=>{var J=og();Zt(J,21,()=>u(s),Dn,(le,_e)=>{var be=ag(),Ce=m(be);he(()=>B(Ce,`â  ${u(_e)??""}`)),K(le,be)}),K(V,J)};Me(ve,V=>{u(s).length>0&&!w.isRunning&&V(He)})}var Ae=_(ve,2);{var Ve=V=>{var J=lg(),le=_(m(J),4);Zt(le,21,()=>H.models,Dn,(at,Ge)=>{const Je=xt(()=>w.solverAssignments[u(Ge).name]||w.method);var ht=rg(),ot=m(ht),gt=m(ot),ft=_(gt,2),ce=m(ft),de=_(ot,2),We=m(de);We.value=We.__value="fem";var nt=_(We);nt.value=nt.__value="pd";var st=_(nt);st.value=st.__value="spg";var X;Vs(de);var fe=_(de,2),Ue=m(fe);he((it,bt,ze)=>{Nn(gt,`background: ${f[u(Je)]??""}`),di(ft,"title",u(Ge).name),B(ce,it),Nn(de,`border-color: ${f[u(Je)]??""}`),X!==(X=u(Je))&&(de.value=(de.__value=u(Je))??"",Rs(de,u(Je))),di(fe,"title",bt),B(Ue,ze)},[()=>u(Ge).name.length>10?u(Ge).name.slice(0,10)+"â¦":u(Ge).name,()=>a(u(Ge).name),()=>i(u(Ge).name)]),D("change",de,it=>o(u(Ge).name,it)),K(at,ht)});var _e=_(le,4),be=_(m(_e),2),Ce=_(be,2),Be=_(Ce,2);he(()=>{Nn(be,`background: ${f.fem}`),Nn(Ce,`background: ${f.pd}`),Nn(Be,`background: ${f.spg}`)}),D("click",be,()=>r("fem")),D("click",Ce,()=>r("pd")),D("click",Be,()=>r("spg")),K(V,J)};Me(Ae,V=>{H.models.length>0&&V(Ve)})}var je=_(Ae,2),Qe=_(m(je),2);Zt(Qe,20,()=>["fem","pd","spg"],Dn,(V,J)=>{var le=cg(),_e=m(le),be=m(_e),Ce=_(_e,2),Be=m(Ce);he(()=>{Nn(_e,`background: ${f[J]??""}`),B(be,l[J]),B(Be,d[J])}),K(V,le)});var Se=_(je,2),Ye=m(Se);{var Xe=V=>{var J=Fi("Running...");K(V,J)},ut=V=>{var J=ug(),le=_(Gn(J));{var _e=be=>{var Ce=dg(),Be=m(Ce);he(at=>B(Be,`(${at??""})`),[()=>u(h)()]),K(be,Ce)};Me(le,be=>{H.models.length>0&&be(_e)})}K(V,J)};Me(Ye,V=>{w.isRunning?V(Xe):V(ut,!1)})}var Mt=_(Se,2);{var G=V=>{var J=hg(),le=m(J),_e=m(le),be=m(_e),Ce=_(_e,2),Be=_(le,2),at=m(Be);let Ge;var Je=_(Be,2),ht=m(Je),ot=m(ht),gt=_(ht,2),ft=m(gt);he((ce,de)=>{B(be,w.progressMessage),Ge=Nn(at,"",Ge,{width:`${w.progress*100}%`}),B(ot,`${ce??""}%`),B(ft,`${de??""}s`)},[()=>(w.progress*100).toFixed(0),()=>(w.elapsedMs/1e3).toFixed(1)]),D("click",Ce,function(...ce){qr==null||qr.apply(this,ce)}),K(V,J)};Me(Mt,V=>{w.isRunning&&V(G)})}var te=_(Mt,2);{var Z=V=>{var J=fg(),le=m(J);he(_e=>B(le,`â í´ì ìë£ â ${_e??""}ì´`),[()=>(w.elapsedMs/1e3).toFixed(1)]),K(V,J)};Me(te,V=>{!w.isRunning&&w.hasResult&&w.elapsedMs>0&&V(Z)})}var ie=_(te,2);{var re=V=>{var J=pg(),le=m(J);he(()=>B(le,`â ${w.lastError??""}`)),K(V,J)},pe=V=>{var J=vg(),le=m(J);he(()=>B(le,tt.lastError)),K(V,J)};Me(ie,V=>{w.lastError?V(re):tt.lastError&&V(pe,1)})}he(()=>{E=Oe(b,1,"dot svelte-iy3ody",null,E,{connected:tt.connected}),R=Oe(I,1,"status-text svelte-iy3ody",null,R,{connected:tt.connected}),B(y,tt.connected?"Connected":"Disconnected"),S=Oe($,1,"check-item svelte-iy3ody",null,S,{ok:tt.connected}),B(P,`${tt.connected?"â":"â"} Server Connected`),A=Oe(M,1,"check-item svelte-iy3ody",null,A,{ok:H.models.length>0}),B(T,`${H.models.length>0?"â":"â"} Models: ${H.models.length??""}`),ne=Oe(j,1,"check-item svelte-iy3ody",null,ne,{ok:w.bcCount>0}),B(se,`${w.bcCount>0?"â":"â"} Boundary Conditions: ${w.bcCount??""}`),U=Oe(Q,1,"check-item svelte-iy3ody",null,U,{ok:w.materialCount>0}),B(N,`${w.materialCount>0?"â":"â"} Materials: ${w.materialCount??""} `),Se.disabled=!u(n)}),D("click",Se,c),K(e,p),an()}Xn(["change","click"]);var gg=ee('<div class="empty-section svelte-1x6no0a"><div class="empty-icon svelte-1x6no0a">ð¬</div> <div class="empty-title svelte-1x6no0a">í´ì ê²°ê³¼ ìì</div> <div class="empty-msg svelte-1x6no0a">Solve í­ìì í´ìì ì¤ííë©´<br/>ì¬ê¸°ìì ê²°ê³¼ë¥¼ ìê°íí©ëë¤.</div></div>'),bg=ee('<div class="field-row svelte-1x6no0a"><label for="post-comp" class="field-label svelte-1x6no0a">ì±ë¶</label> <select id="post-comp" class="field-select svelte-1x6no0a"><option>Magnitude (í¬ê¸°)</option><option>X</option><option>Y</option><option>Z</option></select></div>'),yg=ee('<button><span class="cm-name svelte-1x6no0a"> </span></button>'),wg=ee('<div class="clip-controls svelte-1x6no0a"><div class="field-row svelte-1x6no0a"><label for="clip-axis" class="field-label svelte-1x6no0a">ì¶</label> <select id="clip-axis" class="field-select svelte-1x6no0a"><option>X</option><option>Y</option><option>Z</option></select></div> <div class="slider-row svelte-1x6no0a"><label for="clip-pos" class="svelte-1x6no0a">ìì¹</label> <input id="clip-pos" type="range" min="-1" max="1" step="0.01" class="svelte-1x6no0a"/> <span class="val svelte-1x6no0a"> </span></div> <div class="toggle-row svelte-1x6no0a"><label class="svelte-1x6no0a"><input type="checkbox"/> ë°ì </label></div></div>'),xg=ee('<div class="section svelte-1x6no0a"><div class="section-title svelte-1x6no0a">Color By</div> <div class="field-row svelte-1x6no0a"><label for="post-mode" class="field-label svelte-1x6no0a">íë</label> <select id="post-mode" class="field-select svelte-1x6no0a"><option>Displacement (ë³ì)</option><option>Stress â von Mises (ìë ¥)</option><option>Damage (ìì)</option></select></div> <!></div> <div class="section svelte-1x6no0a"><div class="section-title svelte-1x6no0a">Color Map</div> <div class="cm-grid svelte-1x6no0a"></div> <div id="analysis-colorbar" class="colorbar-container svelte-1x6no0a"></div> <div class="range-info svelte-1x6no0a"><span class="range-val svelte-1x6no0a"> </span> <span class="range-dash svelte-1x6no0a">â</span> <span class="range-val svelte-1x6no0a"> </span> <span class="range-unit svelte-1x6no0a"> </span></div></div> <div class="section svelte-1x6no0a"><div class="section-title svelte-1x6no0a">Display</div> <div class="slider-row svelte-1x6no0a"><label for="warp-scale" class="svelte-1x6no0a">ë³í ë°°ì¨</label> <input id="warp-scale" type="range" min="0" max="200" step="1" class="svelte-1x6no0a"/> <span class="val svelte-1x6no0a"> </span></div> <div class="slider-row svelte-1x6no0a"><label for="pt-size" class="svelte-1x6no0a">í¬ì¸í¸ í¬ê¸°</label> <input id="pt-size" type="range" min="0.5" max="10" step="0.5" class="svelte-1x6no0a"/> <span class="val svelte-1x6no0a"> </span></div> <div class="slider-row svelte-1x6no0a"><label for="opacity" class="svelte-1x6no0a">ë¶í¬ëªë</label> <input id="opacity" type="range" min="0.1" max="1.0" step="0.05" class="svelte-1x6no0a"/> <span class="val svelte-1x6no0a"> </span></div></div> <div class="section svelte-1x6no0a"><div class="section-title svelte-1x6no0a">Statistics</div> <table class="stat-table svelte-1x6no0a"><tbody><tr><td class="stat-label svelte-1x6no0a">ìì</td><td class="stat-value svelte-1x6no0a"> </td></tr><tr><td class="stat-label svelte-1x6no0a">Max ë³ì</td><td class="stat-value svelte-1x6no0a"> </td></tr><tr><td class="stat-label svelte-1x6no0a">Max ìë ¥</td><td class="stat-value svelte-1x6no0a"> </td></tr><tr><td class="stat-label svelte-1x6no0a">Max ìì</td><td class="stat-value svelte-1x6no0a"> </td></tr><tr><td class="stat-label svelte-1x6no0a">ë°©ë²</td><td class="stat-value svelte-1x6no0a"> </td></tr></tbody></table></div> <div class="section svelte-1x6no0a"><div class="section-title svelte-1x6no0a">Clip Plane</div> <div class="toggle-row svelte-1x6no0a"><label class="svelte-1x6no0a"><input type="checkbox"/> íì±í</label></div> <!></div> <div class="section svelte-1x6no0a"><div class="section-title svelte-1x6no0a">Export</div> <button class="tool-btn export-btn svelte-1x6no0a">ð Export CSV</button></div> <div class="section compare svelte-1x6no0a"><div class="section-title svelte-1x6no0a" style="color: #ff6f00;">Pre/Post-Op ë¹êµ</div> <div class="hint svelte-1x6no0a">ìì  ì  ê²°ê³¼ë¥¼ ì ì¥ â ìì  í í´ì â ë¹êµ</div> <button class="tool-btn save-btn svelte-1x6no0a">ð¾ Save Pre-Op</button> <button class="tool-btn compare-btn svelte-1x6no0a">ð Compare</button></div>',1),kg=ee('<div class="panel svelte-1x6no0a"><h3 class="svelte-1x6no0a">POST-PROCESS</h3> <!></div>');function Mg(e,t){sn(t,!1);function n(y){const C=y.target.value;Dm(C)}function s(y){const C=y.target.value;zm(C)}function i(y){Im(y)}function a(y){const C=parseFloat(y.target.value);Lm(C)}function o(y){const C=parseFloat(y.target.value);Om(C)}function r(y){const C=parseFloat(y.target.value);Fm(C)}function c(){Nm(),F.toast("ìì  ì  ê²°ê³¼ ì ì¥ë¨","success")}function l(){$m(),F.toast("ìì  ì /í ë¹êµ íì","info")}function d(y){const C=y.target.checked;Wo(C)}function f(y){const C=y.target.value;Wo(w.clipEnabled,C)}function h(y){const C=parseFloat(y.target.value);Wo(w.clipEnabled,void 0,C)}function p(y){const C=y.target.checked;Wo(w.clipEnabled,void 0,void 0,C)}function g(){Hm()}const x={displacement:"mm",stress:"Pa",damage:""};To();var b=kg(),E=_(m(b),2);{var I=y=>{var C=gg();K(y,C)},R=y=>{var C=xg(),$=Gn(C),S=_(m($),2),P=_(m(S),2),M=m(P);M.value=M.__value="displacement";var A=_(M);A.value=A.__value="stress";var T=_(A);T.value=T.__value="damage";var j;Vs(P);var ne=_(S,2);{var se=me=>{var Te=bg(),Pe=_(m(Te),2),Ie=m(Pe);Ie.value=Ie.__value="magnitude";var ye=_(Ie);ye.value=ye.__value="x";var lt=_(ye);lt.value=lt.__value="y";var xe=_(lt);xe.value=xe.__value="z";var Le;Vs(Pe),he(()=>{Le!==(Le=w.component)&&(Pe.value=(Pe.__value=w.component)??"",Rs(Pe,w.component))}),D("change",Pe,s),K(me,Te)};Me(ne,me=>{w.postMode!=="damage"&&me(se)})}var Q=_($,2),U=_(m(Q),2);Zt(U,5,()=>xm,Dn,(me,Te)=>{var Pe=yg();let Ie;var ye=m(Pe),lt=m(ye);he(xe=>{Ie=Oe(Pe,1,"cm-chip svelte-1x6no0a",null,Ie,{active:w.colormap===u(Te)}),Nn(Pe,`background: ${xe??""};`),di(Pe,"title",Vi[u(Te)].label),B(lt,Vi[u(Te)].label)},[()=>tc(u(Te),8)]),D("click",Pe,()=>i(u(Te))),K(me,Pe)});var N=_(U,4),oe=m(N),ae=m(oe),ve=_(oe,4),He=m(ve),Ae=_(ve,2),Ve=m(Ae),je=_(Q,2),Qe=_(m(je),2),Se=_(m(Qe),2),Ye=_(Se,2),Xe=m(Ye),ut=_(Qe,2),Mt=_(m(ut),2),G=_(Mt,2),te=m(G),Z=_(ut,2),ie=_(m(Z),2),re=_(ie,2),pe=m(re),V=_(je,2),J=_(m(V),2),le=m(J),_e=m(le),be=_(m(_e)),Ce=m(be),Be=_(_e),at=_(m(Be)),Ge=m(at),Je=_(Be),ht=_(m(Je)),ot=m(ht),gt=_(Je),ft=_(m(gt)),ce=m(ft),de=_(gt),We=_(m(de)),nt=m(We),st=_(V,2),X=_(m(st),2),fe=m(X),Ue=m(fe),it=_(X,2);{var bt=me=>{var Te=wg(),Pe=m(Te),Ie=_(m(Pe),2),ye=m(Ie);ye.value=ye.__value="x";var lt=_(ye);lt.value=lt.__value="y";var xe=_(lt);xe.value=xe.__value="z";var Le;Vs(Ie);var pt=_(Pe,2),js=_(m(pt),2),xr=_(js,2),Ph=m(xr),Ah=_(pt,2),Th=m(Ah),sc=m(Th);he(Rh=>{Le!==(Le=w.clipAxis)&&(Ie.value=(Ie.__value=w.clipAxis)??"",Rs(Ie,w.clipAxis)),_t(js,w.clipPosition),B(Ph,Rh),lr(sc,w.clipInvert)},[()=>w.clipPosition.toFixed(2)]),D("change",Ie,f),D("input",js,h),D("change",sc,p),K(me,Te)};Me(it,me=>{w.clipEnabled&&me(bt)})}var ze=_(st,2),we=_(m(ze),2),Ze=_(ze,2),rt=_(m(Ze),4),et=_(rt,2);he((me,Te,Pe,Ie,ye,lt,xe,Le,pt)=>{j!==(j=w.postMode)&&(P.value=(P.__value=w.postMode)??"",Rs(P,w.postMode)),B(ae,me),B(He,Te),B(Ve,x[w.postMode]),_t(Se,w.dispScale),B(Xe,`Ã${w.dispScale??""}`),_t(Mt,w.particleSize),B(te,Pe),_t(ie,w.opacity),B(pe,`${Ie??""}%`),B(Ce,`${ye??""}ê°`),B(Ge,`${lt??""} mm`),B(ot,`${xe??""} Pa`),B(ce,Le),B(nt,pt),lr(Ue,w.clipEnabled),et.disabled=!w.hasPreOpResult},[()=>w.dataMin.toExponential(2),()=>w.dataMax.toExponential(2),()=>w.particleSize.toFixed(1),()=>(w.opacity*100).toFixed(0),()=>w.visibleCount.toLocaleString(),()=>{var me;return((me=w.postProcessor)==null?void 0:me.stats.maxDisp.toExponential(3))??"â"},()=>{var me;return((me=w.postProcessor)==null?void 0:me.stats.maxStress.toExponential(3))??"â"},()=>{var me;return((me=w.postProcessor)==null?void 0:me.stats.maxDamage.toFixed(4))??"â"},()=>{var me,Te,Pe,Ie;return((Ie=(Pe=(Te=(me=w.postProcessor)==null?void 0:me.data)==null?void 0:Te.info)==null?void 0:Pe.method)==null?void 0:Ie.toUpperCase())??"â"}]),D("change",P,n),D("input",Se,a),D("input",Mt,o),D("input",ie,r),D("change",Ue,d),D("click",we,g),D("click",rt,c),D("click",et,l),K(y,C)};Me(E,y=>{w.hasResult?y(R,!1):y(I)})}K(e,b),an()}Xn(["change","click","input"]);var Sg=ee("<button> </button>"),Eg=ee('<span class="path-icon svelte-kvtkk2" title="ë³ë¦¬íì  ë³ì´">â²</span>'),Cg=ee('<button class="mat-del-btn svelte-kvtkk2" title="ì­ì ">Ã</button>'),Pg=ee('<div role="button" tabindex="0"><div class="mat-card-header svelte-kvtkk2"><span class="mat-card-name svelte-kvtkk2"><!> </span> <span class="mat-card-model svelte-kvtkk2"> </span> <!></div> <div class="mat-card-props svelte-kvtkk2"><span> </span> <span> </span> <span> </span></div></div>'),Ag=ee('<div class="mat-empty svelte-kvtkk2">í´ë¹íë ì¬ë£ê° ììµëë¤</div>'),Tg=ee("<option> </option>"),Rg=ee('<div class="model-hint svelte-kvtkk2">â  FEM ì ì© â PD/SPGììë Linear Elasticì¼ë¡ ëì²´</div>'),Dg=ee(`<div class="editor-row svelte-kvtkk2"><label for="edit-e" class="editor-label svelte-kvtkk2">E (Young's modulus)</label> <div class="editor-controls svelte-kvtkk2"><input id="edit-e-slider" type="range" min="0" max="1000" step="1" class="editor-slider svelte-kvtkk2"/> <input id="edit-e" type="number" step="0.1" min="0.01" class="editor-num svelte-kvtkk2"/> <button class="unit-btn svelte-kvtkk2"> </button></div></div> <div class="editor-row svelte-kvtkk2"><label for="edit-nu" class="editor-label svelte-kvtkk2">Î½ (Poisson's ratio)</label> <div class="editor-controls svelte-kvtkk2"><input id="edit-nu" type="range" min="0.01" max="0.499" step="0.01" class="editor-slider svelte-kvtkk2"/> <span class="editor-val svelte-kvtkk2"> </span></div></div>`,1),zg=ee('<div class="editor-row ref-section svelte-kvtkk2"><label class="editor-label ref-label svelte-kvtkk2">ê¸°ë³¸ ë¬¼ì± (ì°¸ì¡°)</label> <div class="ref-values svelte-kvtkk2"><span> </span> <span> </span></div></div> <div class="editor-row svelte-kvtkk2"><label class="editor-label svelte-kvtkk2">Cââ [Pa]</label> <div class="editor-controls svelte-kvtkk2"><input type="text" inputmode="decimal" class="editor-num-wide svelte-kvtkk2"/></div></div> <div class="editor-row svelte-kvtkk2"><label class="editor-label svelte-kvtkk2">Cââ [Pa]</label> <div class="editor-controls svelte-kvtkk2"><input type="text" inputmode="decimal" class="editor-num-wide svelte-kvtkk2"/></div></div> <div class="editor-row svelte-kvtkk2"><label class="editor-label svelte-kvtkk2">Dâ [1/Pa]</label> <div class="editor-controls svelte-kvtkk2"><input type="text" inputmode="decimal" class="editor-num-wide svelte-kvtkk2"/></div></div> <div class="auto-calc-row svelte-kvtkk2"><button class="auto-calc-btn svelte-kvtkk2" title="íì¬ E/Î½ ê°ìì C10, C01, D1 ìë ë³í">â³ E/Î½ìì ìëê³ì°</button></div>',1),Ig=ee('<div class="editor-row ref-section svelte-kvtkk2"><label class="editor-label ref-label svelte-kvtkk2">ê¸°ë³¸ ë¬¼ì± (ì°¸ì¡°)</label> <div class="ref-values svelte-kvtkk2"><span> </span> <span> </span></div></div> <div class="editor-row svelte-kvtkk2"><label class="editor-label svelte-kvtkk2">Î¼ (Shear modulus) [Pa]</label> <div class="editor-controls svelte-kvtkk2"><input type="text" inputmode="decimal" class="editor-num-wide svelte-kvtkk2"/></div></div> <div class="editor-row svelte-kvtkk2"><label class="editor-label svelte-kvtkk2">Î± (Exponent)</label> <div class="editor-controls svelte-kvtkk2"><input type="text" inputmode="decimal" class="editor-num-wide svelte-kvtkk2"/></div></div> <div class="editor-row svelte-kvtkk2"><label class="editor-label svelte-kvtkk2">Dâ [1/Pa]</label> <div class="editor-controls svelte-kvtkk2"><input type="text" inputmode="decimal" class="editor-num-wide svelte-kvtkk2"/></div></div> <div class="auto-calc-row svelte-kvtkk2"><button class="auto-calc-btn svelte-kvtkk2" title="íì¬ E/Î½ ê°ìì Î¼, Î±, D1 ìë ë³í">â³ E/Î½ìì ìëê³ì°</button></div>',1),Lg=ee('<div class="mat-editor svelte-kvtkk2"><div class="editor-title svelte-kvtkk2"> </div> <div class="editor-row svelte-kvtkk2"><label class="editor-label svelte-kvtkk2">êµ¬ì± ëª¨ë¸ (Constitutive Model)</label> <select class="model-select svelte-kvtkk2"></select> <div class="model-desc svelte-kvtkk2"> </div> <!></div> <!> <div class="editor-row svelte-kvtkk2"><label for="edit-density" class="editor-label svelte-kvtkk2">Ï (Density, kg/mÂ³)</label> <div class="editor-controls svelte-kvtkk2"><input id="edit-density" type="range" min="500" max="9000" step="50" class="editor-slider svelte-kvtkk2"/> <span class="editor-val svelte-kvtkk2"> </span></div></div></div>'),Og=ee("<option> </option>"),Fg=ee('<div class="editor-actions svelte-kvtkk2"><button class="action-btn save svelte-kvtkk2">+ ì»¤ì¤í ì ì¥</button> <button class="action-btn svelte-kvtkk2">ì´ê¸°í</button></div>'),Ng=ee('<div class="panel svelte-kvtkk2"><h3 class="svelte-kvtkk2">MATERIAL LIBRARY</h3> <div class="mat-tabs svelte-kvtkk2"></div> <input type="text" class="mat-search svelte-kvtkk2" placeholder="ê²ì..."/> <div class="mat-list svelte-kvtkk2"></div> <!> <div class="assign-section svelte-kvtkk2"><div class="assign-row svelte-kvtkk2"><label for="mat-target" class="assign-label svelte-kvtkk2">ëì</label> <select id="mat-target" class="assign-select svelte-kvtkk2"><option>All</option><!></select></div> <button class="assign-btn svelte-kvtkk2">Assign Material</button></div> <!></div>');function $g(e,t){sn(t,!0);let n=z("__all__"),s=z(null),i=z(15e9),a=z(.3),o=z(1850),r=z("GPa"),c=z(Qt(Ko(15e9))),l=z("linear_elastic"),d=z(0),f=z(0),h=z(0),p=z(0),g=z(2),x=xt(()=>H.models.length>0);const b=["all","bone","disc","implant","soft_tissue","custom"];let E=xt(()=>qn.filtered),I=xt(()=>u(r)==="GPa"?u(i)/1e9:u(i)/1e6);function R(G){k(s,G,!0),k(i,G.E,!0),k(a,G.nu,!0),k(o,G.density,!0),k(c,Ko(G.E),!0),k(r,G.E>=1e9?"GPa":"MPa",!0),k(l,G.constitutiveModel??"linear_elastic",!0),k(d,G.C10??0,!0),k(f,G.C01??0,!0),k(h,G.D1??0,!0),k(p,G.mu_ogden??0,!0),k(g,G.alpha_ogden??2,!0)}function y(G){k(c,parseInt(G.target.value),!0),k(i,eg(u(c)),!0)}function C(G){const te=parseFloat(G.target.value);isNaN(te)||te<=0||(k(i,u(r)==="GPa"?te*1e9:te*1e6,!0),k(c,Ko(u(i)),!0))}function $(){k(r,u(r)==="GPa"?"MPa":"GPa",!0)}function S(G){k(a,parseFloat(G.target.value),!0)}function P(G){k(o,parseInt(G.target.value),!0)}function M(G){const te=G.target.value;k(l,te,!0),te==="mooney_rivlin"?A():te==="ogden"&&T()}function A(){const{C10:G,C01:te,D1:Z}=tg(u(i),u(a));k(d,G,!0),k(f,te,!0),k(h,Z,!0)}function T(){const{mu_ogden:G,alpha_ogden:te,D1:Z}=ng(u(i),u(a),u(g));k(p,G,!0),k(g,te,!0),k(h,Z,!0)}function j(){if(!u(s)){F.toast("ì¬ë£ë¥¼ ë¨¼ì  ì ííì¸ì","warn");return}if(!u(x)){F.toast("ëª¨ë¸ì ë¨¼ì  ë¡ëíì¸ì","warn");return}const G={key:u(s).key,label:u(s).labelKo,E:u(i),nu:u(a),density:u(o),constitutiveModel:u(l)};u(l)==="mooney_rivlin"?(G.C10=u(d),G.C01=u(f),G.D1=u(h)):u(l)==="ogden"&&(G.mu_ogden=u(p),G.alpha_ogden=u(g),G.D1=u(h)),u(n)==="__all__"?H.models.forEach(re=>Td(re.name,G)):Td(u(n),G);const Z=u(i)!==u(s).E||u(a)!==u(s).nu||u(o)!==u(s).density||u(l)!==(u(s).constitutiveModel??"linear_elastic")?" (ìì ë¨)":"",ie=Zs[u(l)].label;F.toast(`ì¬ë£ í ë¹: ${G.label}${Z} â ${ie}, E=${Ys(u(i))}`,"success")}function ne(){u(s)&&(k(i,u(s).E,!0),k(a,u(s).nu,!0),k(o,u(s).density,!0),k(c,Ko(u(s).E),!0),k(r,u(s).E>=1e9?"GPa":"MPa",!0),k(l,u(s).constitutiveModel??"linear_elastic",!0),k(d,u(s).C10??0,!0),k(f,u(s).C01??0,!0),k(h,u(s).D1??0,!0),k(p,u(s).mu_ogden??0,!0),k(g,u(s).alpha_ogden??2,!0))}function se(){const G=prompt("ì»¤ì¤í ì¬ë£ ì´ë¦ì ìë ¥íì¸ì:");if(!G||G.trim().length===0)return;const te=Zs[u(l)].label,Z={label:G.trim(),labelKo:G.trim(),E:u(i),nu:u(a),density:u(o),constitutiveModel:u(l),description:`ì¬ì©ì ì ì: ${te}, E=${Ys(u(i))}, Î½=${u(a)}`};u(l)==="mooney_rivlin"?(Z.C10=u(d),Z.C01=u(f),Z.D1=u(h)):u(l)==="ogden"&&(Z.mu_ogden=u(p),Z.alpha_ogden=u(g),Z.D1=u(h)),qn.addCustom(Z),F.toast(`ì»¤ì¤í ì¬ë£ ì ì¥: ${G} (${te})`,"success"),qn.activeCategory="custom"}function Q(G){var te;qn.removeCustom(G),((te=u(s))==null?void 0:te.key)===G&&k(s,null),F.toast("ì»¤ì¤í ì¬ë£ ì­ì ë¨","info")}function U(G){qn.searchQuery=G.target.value}var N=Ng(),oe=_(m(N),2);Zt(oe,21,()=>b,Dn,(G,te)=>{var Z=Sg();let ie;var re=m(Z);he(()=>{ie=Oe(Z,1,"mat-tab svelte-kvtkk2",null,ie,{active:qn.activeCategory===u(te)}),B(re,qm[u(te)])}),D("click",Z,()=>{qn.activeCategory=u(te)}),K(G,Z)});var ae=_(oe,2),ve=_(ae,2);Zt(ve,21,()=>u(E),G=>G.key,(G,te)=>{var Z=Pg();let ie;var re=m(Z),pe=m(re),V=m(pe);{var J=ce=>{var de=Eg();K(ce,de)};Me(V,ce=>{u(te).isPathological&&ce(J)})}var le=_(V),_e=_(pe,2),be=m(_e),Ce=_(_e,2);{var Be=ce=>{var de=Cg();D("click",de,We=>{We.stopPropagation(),Q(u(te).key)}),K(ce,de)};Me(Ce,ce=>{u(te).isCustom&&ce(Be)})}var at=_(re,2),Ge=m(at),Je=m(Ge),ht=_(Ge,2),ot=m(ht),gt=_(ht,2),ft=m(gt);he(ce=>{var de;ie=Oe(Z,1,"mat-card svelte-kvtkk2",null,ie,{selected:((de=u(s))==null?void 0:de.key)===u(te).key,pathological:u(te).isPathological,custom:u(te).isCustom}),B(le,` ${u(te).labelKo??""}`),B(be,Zs[u(te).constitutiveModel??"linear_elastic"].label),B(Je,`E=${ce??""}`),B(ot,`Î½=${u(te).nu??""}`),B(ft,`Ï=${u(te).density??""}`)},[()=>Ys(u(te).E)]),D("click",Z,()=>R(u(te))),D("keydown",Z,ce=>{ce.key==="Enter"&&R(u(te))}),K(G,Z)},G=>{var te=Ag();K(G,te)});var He=_(ve,2);{var Ae=G=>{var te=Lg(),Z=m(te),ie=m(Z),re=_(Z,2),pe=_(m(re),2);Zt(pe,21,()=>Object.entries(Zs),Dn,(ce,de)=>{var We=xt(()=>Qh(u(de),2));let nt=()=>u(We)[0],st=()=>u(We)[1];var X=Tg(),fe=m(X),Ue={};he(()=>{B(fe,st().label),Ue!==(Ue=nt())&&(X.value=(X.__value=nt())??"")}),K(ce,X)});var V;Vs(pe);var J=_(pe,2),le=m(J),_e=_(J,2);{var be=ce=>{var de=Rg();K(ce,de)};Me(_e,ce=>{Zs[u(l)].femOnly&&ce(be)})}var Ce=_(re,2);{var Be=ce=>{var de=Dg(),We=Gn(de),nt=_(m(We),2),st=m(nt),X=_(st,2),fe=_(X,2),Ue=m(fe),it=_(We,2),bt=_(m(it),2),ze=m(bt),we=_(ze,2),Ze=m(we);he((rt,et)=>{_t(st,u(c)),_t(X,rt),B(Ue,u(r)),_t(ze,u(a)),B(Ze,et)},[()=>u(I).toFixed(u(I)>=10?1:2),()=>u(a).toFixed(2)]),D("input",st,y),D("change",X,C),D("click",fe,$),D("input",ze,S),K(ce,de)},at=ce=>{var de=zg(),We=Gn(de),nt=_(m(We),2),st=m(nt),X=m(st),fe=_(st,2),Ue=m(fe),it=_(We,2),bt=_(m(it),2),ze=m(bt),we=_(it,2),Ze=_(m(we),2),rt=m(Ze),et=_(we,2),me=_(m(et),2),Te=m(me),Pe=_(et,2),Ie=m(Pe);he((ye,lt,xe,Le,pt)=>{B(X,`E = ${ye??""}`),B(Ue,`Î½ = ${lt??""}`),_t(ze,xe),_t(rt,Le),_t(Te,pt)},[()=>Ys(u(i)),()=>u(a).toFixed(2),()=>u(d)!==0?u(d).toPrecision(6):"0",()=>u(f)!==0?u(f).toPrecision(6):"0",()=>u(h)!==0?u(h).toPrecision(4):"0"]),D("change",ze,ye=>{k(d,parseFloat(ye.target.value)||0,!0)}),D("change",rt,ye=>{k(f,parseFloat(ye.target.value)||0,!0)}),D("change",Te,ye=>{k(h,parseFloat(ye.target.value)||0,!0)}),D("click",Ie,A),K(ce,de)},Ge=ce=>{var de=Ig(),We=Gn(de),nt=_(m(We),2),st=m(nt),X=m(st),fe=_(st,2),Ue=m(fe),it=_(We,2),bt=_(m(it),2),ze=m(bt),we=_(it,2),Ze=_(m(we),2),rt=m(Ze),et=_(we,2),me=_(m(et),2),Te=m(me),Pe=_(et,2),Ie=m(Pe);he((ye,lt,xe,Le)=>{B(X,`E = ${ye??""}`),B(Ue,`Î½ = ${lt??""}`),_t(ze,xe),_t(rt,u(g)),_t(Te,Le)},[()=>Ys(u(i)),()=>u(a).toFixed(2),()=>u(p)!==0?u(p).toPrecision(6):"0",()=>u(h)!==0?u(h).toPrecision(4):"0"]),D("change",ze,ye=>{k(p,parseFloat(ye.target.value)||0,!0)}),D("change",rt,ye=>{k(g,parseFloat(ye.target.value)||2,!0)}),D("change",Te,ye=>{k(h,parseFloat(ye.target.value)||0,!0)}),D("click",Ie,T),K(ce,de)};Me(Ce,ce=>{u(l)==="linear_elastic"||u(l)==="neo_hookean"?ce(Be):u(l)==="mooney_rivlin"?ce(at,1):u(l)==="ogden"&&ce(Ge,2)})}var Je=_(Ce,2),ht=_(m(Je),2),ot=m(ht),gt=_(ot,2),ft=m(gt);he(()=>{B(ie,`ìì± í¸ì§ â ${u(s).labelKo??""}`),V!==(V=u(l))&&(pe.value=(pe.__value=u(l))??"",Rs(pe,u(l))),B(le,Zs[u(l)].description),_t(ot,u(o)),B(ft,u(o))}),D("change",pe,M),D("input",ot,P),K(G,te)};Me(He,G=>{u(s)&&G(Ae)})}var Ve=_(He,2),je=m(Ve),Qe=_(m(je),2),Se=m(Qe);Se.value=Se.__value="__all__";var Ye=_(Se);Zt(Ye,17,()=>H.models,Dn,(G,te)=>{var Z=Og(),ie=m(Z),re={};he(()=>{B(ie,u(te).name),re!==(re=u(te).name)&&(Z.value=(Z.__value=u(te).name)??"")}),K(G,Z)});var Xe=_(je,2),ut=_(Ve,2);{var Mt=G=>{var te=Fg(),Z=m(te),ie=_(Z,2);D("click",Z,se),D("click",ie,ne),K(G,te)};Me(ut,G=>{u(s)&&G(Mt)})}he(()=>{_t(ae,qn.searchQuery),Xe.disabled=!u(x)||!u(s)}),D("input",ae,U),Du(Qe,()=>u(n),G=>k(n,G)),D("click",Xe,j),K(e,N),an()}Xn(["click","input","keydown","change"]);var Hg=ee('<aside class="sidebar svelte-l14y5r"><!></aside>');function jg(e,t){sn(t,!1),To();var n=Hg(),s=m(n);{var i=d=>{sm(d,{})},a=d=>{pm(d,{})},o=d=>{$g(d,{})},r=d=>{Km(d,{})},c=d=>{mg(d,{})},l=d=>{Mg(d,{})};Me(s,d=>{F.activeTab==="file"?d(i):F.activeTab==="modeling"?d(a,1):F.activeTab==="material"?d(o,2):F.activeTab==="preprocess"?d(r,3):F.activeTab==="solve"?d(c,4):F.activeTab==="postprocess"&&d(l,5)})}K(e,n),an()}var Bg=ee('<div class="statusbar svelte-owsl1j"><span class="status-col svelte-owsl1j"><span class="label svelte-owsl1j">Status:</span> <span class="value status-msg svelte-owsl1j"> </span></span> <span class="sep svelte-owsl1j"></span> <span><span class="label svelte-owsl1j">Models:</span> <span class="value svelte-owsl1j"> </span></span> <span class="sep svelte-owsl1j"></span> <span><span class="label svelte-owsl1j">Vertices:</span> <span class="value svelte-owsl1j"> </span></span> <span class="sep svelte-owsl1j"></span> <span><span class="label svelte-owsl1j">Faces:</span> <span class="value svelte-owsl1j"> </span></span> <span class="sep svelte-owsl1j"></span> <span><span class="label svelte-owsl1j">FPS:</span> <span class="value svelte-owsl1j"> </span></span></div>');function Ug(e,t){sn(t,!0);let n=xt(()=>H.models.reduce((y,C)=>y+C.vertexCount,0)),s=xt(()=>H.models.reduce((y,C)=>y+C.faceCount,0));var i=Bg(),a=m(i),o=_(m(a),2),r=m(o),c=_(a,4),l=_(m(c),2),d=m(l),f=_(c,4),h=_(m(f),2),p=m(h),g=_(f,4),x=_(m(g),2),b=m(x),E=_(g,4),I=_(m(E),2),R=m(I);he((y,C)=>{di(a,"title",F.statusMessage),B(r,F.statusMessage),B(d,H.models.length),B(p,y),B(b,C),B(R,H.fps)},[()=>u(n).toLocaleString(),()=>u(s).toLocaleString()]),K(e,i),an()}var Zg=ee("<div> </div>"),Yg=ee('<div class="toast-container"></div>'),Gg=ee('<div class="confirm-overlay"><div class="confirm-dialog"><h4> </h4> <p> </p> <div class="btn-row"><button class="btn-cancel">ì·¨ì</button> <button class="btn-confirm">íì¸</button></div></div></div>'),Vg=ee('<!> <div class="main-container svelte-1n46o8q"><!> <!></div> <!> <!> <!>',1);function Xg(e,t){sn(t,!1),To();var n=Vg(),s=Gn(n);Ap(s,{});var i=_(s,2),a=m(i);j_(a,{});var o=_(a,2);jg(o,{});var r=_(i,2);Ug(r,{});var c=_(r,2);{var l=h=>{var p=Yg();Zt(p,5,()=>F.toasts,g=>g.id,(g,x)=>{var b=Zg(),E=m(b);he(()=>{Oe(b,1,`toast ${u(x).level??""}`,"svelte-1n46o8q"),B(E,u(x).message)}),K(g,b)}),K(h,p)};Me(c,h=>{F.toasts.length>0&&h(l)})}var d=_(c,2);{var f=h=>{var p=Gg(),g=m(p),x=m(g),b=m(x),E=_(x,2),I=m(E),R=_(E,2),y=m(R),C=_(y,2);he(()=>{B(b,F.confirmDialog.title),B(I,F.confirmDialog.message)}),D("click",p,()=>F.closeConfirm(!1)),D("click",g,$=>$.stopPropagation()),D("click",y,()=>F.closeConfirm(!1)),D("click",C,()=>F.closeConfirm(!0)),K(h,p)};Me(d,h=>{F.confirmDialog&&h(f)})}K(e,n),an()}Xn(["click"]);cp(Xg,{target:document.getElementById("app")});
